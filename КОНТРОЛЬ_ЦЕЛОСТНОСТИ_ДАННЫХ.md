# КОНТРОЛЬ ЦЕЛОСТНОСТИ ДАННЫХ
## Проект: Imperial Tunes

**Версия документа:** 1.0  
**Дата создания:** 09.11.2025  
**База данных:** PostgreSQL (Supabase)

---

## ОГЛАВЛЕНИЕ

1. [Общая информация](#общая-информация)
2. [Этапы валидации данных](#этапы-валидации-данных)
3. [Таблицы валидации по типам данных](#таблицы-валидации-по-типам-данных)
4. [Валидация на уровне клиента](#валидация-на-уровне-клиента)
5. [Валидация на уровне базы данных](#валидация-на-уровне-базы-данных)
6. [Валидация загружаемых файлов](#валидация-загружаемых-файлов)
7. [Обработка ошибок валидации](#обработка-ошибок-валидации)

---

## ОБЩАЯ ИНФОРМАЦИЯ

В проекте Imperial Tunes реализована многоуровневая система валидации данных, обеспечивающая целостность информации на всех этапах работы приложения:

- **Клиентская валидация** (React/TypeScript) - проверка данных перед отправкой на сервер
- **Валидация на уровне БД** (PostgreSQL) - CHECK ограничения, UNIQUE, NOT NULL
- **Валидация файлов** (Supabase Storage) - проверка форматов и размеров

---

## ЭТАПЫ ВАЛИДАЦИИ ДАННЫХ

### Таблица 1: Этапы валидации данных

| № | Этап валидации | Описание | Уровень выполнения | Приоритет |
|---|----------------|----------|---------------------|-----------|
| 1 | Формат данных | Проверка соответствия типам данных (строка, число, дата, email, URL) | Клиент + БД | Высокий |
| 2 | Длина строковых значений | Проверка минимальной и максимальной длины текстовых полей | Клиент + БД | Высокий |
| 3 | Уникальность значений | Проверка уникальности username, email, названий артистов/альбомов | Клиент + БД | Высокий |
| 4 | Обязательность полей | Проверка наличия обязательных (NOT NULL) полей | Клиент + БД | Высокий |
| 5 | Диапазон числовых значений | Проверка допустимых диапазонов (длительность, счетчики) | Клиент + БД | Средний |
| 6 | Формат файлов | Проверка расширений и MIME-типов загружаемых файлов | Клиент + Storage | Высокий |
| 7 | Размер файлов | Проверка максимального размера загружаемых файлов | Клиент + Storage | Высокий |
| 8 | Валидация дат | Проверка корректности и диапазона дат | Клиент + БД | Средний |
| 9 | Связность данных | Проверка внешних ключей и целостности связей | БД | Критический |
| 10 | Бизнес-логика | Проверка правил бизнес-логики (статусы, роли) | Клиент + БД | Высокий |

---

## ТАБЛИЦЫ ВАЛИДАЦИИ ПО ТИПАМ ДАННЫХ

### Таблица 2: Валидация формата Email

| № | Этап валидации | Тип проверки | Описание этапа | Действие при ошибке | Класс/Страница |
|---|----------------|--------------|----------------|---------------------|----------------|
| 1 | Формат Email | HTML5 валидация | Проверка формата email через атрибут `type="email"` в input | Браузер блокирует отправку формы, показывает стандартное сообщение | `src/pages/Auth.tsx` (строка 194-202) |
| 2 | Формат Email | Supabase Auth | Проверка формата email при регистрации/входе | Возвращается ошибка `invalid_email` или `email_not_confirmed` | `src/pages/Auth.tsx` (строка 29-34, 81-94) |
| 3 | Обязательность | HTML5 required | Проверка наличия email в поле | Браузер блокирует отправку формы | `src/pages/Auth.tsx` (строка 200) |

**Связанные компоненты:**
- `src/pages/Auth.tsx` - Страница авторизации и регистрации
- `src/pages/Settings.tsx` - Страница настроек (сброс пароля по email)

---

### Таблица 3: Валидация пароля

| № | Этап валидации | Тип проверки | Описание этапа | Действие при ошибке | Класс/Страница |
|---|----------------|--------------|----------------|---------------------|----------------|
| 1 | Минимальная длина | HTML5 minLength | Проверка минимальной длины пароля (6 символов) | Браузер блокирует отправку формы | `src/pages/Auth.tsx` (строка 214) |
| 2 | Минимальная длина | JavaScript проверка | Проверка длины пароля перед изменением | Показывается toast с ошибкой `settings.passwordMinLength` | `src/pages/Settings.tsx` (строка 204-207) |
| 3 | Совпадение паролей | JavaScript проверка | Проверка совпадения нового пароля и подтверждения | Показывается toast с ошибкой `settings.passwordMismatch` | `src/pages/Settings.tsx` (строка 209-212) |
| 4 | Хэширование | Supabase Auth | Автоматическое хэширование пароля перед сохранением | Пароль никогда не сохраняется в открытом виде | `src/pages/Auth.tsx` (строка 81-94) |

**Связанные компоненты:**
- `src/pages/Auth.tsx` - Страница авторизации и регистрации
- `src/pages/Settings.tsx` - Страница настроек (смена пароля)

---

### Таблица 4: Валидация Username

| № | Этап валидации | Тип проверки | Описание этапа | Действие при ошибке | Класс/Страница |
|---|----------------|--------------|----------------|---------------------|----------------|
| 1 | Длина строки | HTML5 minLength/maxLength | Проверка длины username (3-50 символов) | Браузер блокирует отправку формы | `src/pages/Auth.tsx` (строка 162-163) |
| 2 | Длина строки | JavaScript проверка | Проверка длины перед регистрацией | Показывается toast с ошибкой `auth.usernameLength` | `src/pages/Auth.tsx` (строка 62-66) |
| 3 | Длина строки | JavaScript проверка | Проверка длины при сохранении профиля | Показывается toast с ошибкой `settings.usernameMinLength` | `src/pages/Settings.tsx` (строка 176-180) |
| 4 | Уникальность | SQL запрос | Проверка существования username в БД | Показывается toast с ошибкой `auth.usernameTaken` | `src/pages/Auth.tsx` (строка 68-79) |
| 5 | Длина строки | CHECK ограничение | Проверка длины в БД (3-50 символов) | Ошибка БД: `new row violates check constraint` | `supabase/migrations/20250201000000_complete_database_schema.sql` (строка 165-168) |
| 6 | Уникальность | UNIQUE constraint | Гарантия уникальности username в БД | Ошибка БД: `duplicate key value violates unique constraint` | `supabase/migrations/20250201000000_complete_database_schema.sql` (строка 154) |
| 7 | Обязательность | NOT NULL constraint | Гарантия наличия username | Ошибка БД: `null value in column "username" violates not-null constraint` | `supabase/migrations/20250201000000_complete_database_schema.sql` (строка 154) |

**Связанные компоненты:**
- `src/pages/Auth.tsx` - Страница авторизации и регистрации
- `src/pages/Settings.tsx` - Страница настроек (редактирование профиля)
- Таблица БД: `public.users`

---

### Таблица 5: Валидация названий (Треки, Альбомы, Плейлисты)

| № | Этап валидации | Тип проверки | Описание этапа | Действие при ошибке | Класс/Страница |
|---|----------------|--------------|----------------|---------------------|----------------|
| 1 | Название трека - длина | HTML5 required | Проверка наличия названия трека | Браузер блокирует отправку формы | `src/components/UploadTrackDialog.tsx` (строка 434) |
| 2 | Название трека - длина | JavaScript проверка | Проверка заполнения всех обязательных полей | Показывается toast с ошибкой `upload.error.required` | `src/components/UploadTrackDialog.tsx` (строка 255-258) |
| 3 | Название трека - длина | CHECK ограничение | Проверка длины в БД (1-100 символов) | Ошибка БД при вставке | `supabase/migrations/20250201000000_complete_database_schema.sql` (строка 246-249) |
| 4 | Название альбома - длина | HTML5 required | Проверка наличия названия альбома | Браузер блокирует отправку формы | `src/components/CreateAlbumDialog.tsx` (строка 233) |
| 5 | Название альбома - длина | JavaScript проверка | Проверка заполнения всех обязательных полей | Показывается toast с ошибкой `album.create.fillAll` | `src/components/CreateAlbumDialog.tsx` (строка 149-152) |
| 6 | Название альбома - длина | CHECK ограничение | Проверка длины в БД (2-100 символов) | Ошибка БД при вставке | `supabase/migrations/20250201000000_complete_database_schema.sql` (строка 215-218) |
| 7 | Название плейлиста - длина | HTML5 minLength/maxLength | Проверка длины плейлиста (2-100 символов) | Браузер блокирует отправку формы | `src/components/CreatePlaylistDialog.tsx` (строка 101-102) |
| 8 | Название плейлиста - длина | JavaScript проверка | Проверка длины перед созданием | Показывается toast с ошибкой о длине | `src/components/CreatePlaylistDialog.tsx` (строка 37-40) |
| 9 | Название плейлиста - длина | CHECK ограничение | Проверка длины в БД (2-100 символов) | Ошибка БД при вставке | `supabase/migrations/20250201000000_complete_database_schema.sql` (строка 264-267) |

**Связанные компоненты:**
- `src/components/UploadTrackDialog.tsx` - Диалог загрузки трека
- `src/components/CreateAlbumDialog.tsx` - Диалог создания альбома
- `src/components/CreatePlaylistDialog.tsx` - Диалог создания плейлиста
- Таблицы БД: `public.tracks`, `public.albums`, `public.playlists`

---

### Таблица 6: Валидация дат

| № | Этап валидации | Тип проверки | Описание этапа | Действие при ошибке | Класс/Страница |
|---|----------------|--------------|----------------|---------------------|----------------|
| 1 | Дата релиза альбома | HTML5 type="date" | Проверка формата даты через браузер | Браузер показывает календарь для выбора даты | `src/components/CreateAlbumDialog.tsx` (строка 263-269) |
| 2 | Дата релиза альбома | HTML5 required | Проверка наличия даты релиза | Браузер блокирует отправку формы | `src/components/CreateAlbumDialog.tsx` (строка 268) |
| 3 | Дата релиза альбома | CHECK ограничение | Проверка диапазона даты (1900-01-01 до CURRENT_DATE + 1 год) | Ошибка БД при вставке невалидной даты | `supabase/migrations/20250201000000_complete_database_schema.sql` (строка 219-222) |

**Связанные компоненты:**
- `src/components/CreateAlbumDialog.tsx` - Диалог создания альбома
- Таблица БД: `public.albums`

---

### Таблица 7: Валидация числовых значений

| № | Этап валидации | Тип проверки | Описание этапа | Действие при ошибке | Класс/Страница |
|---|----------------|--------------|----------------|---------------------|----------------|
| 1 | Длительность трека | Автоматическое определение | Извлечение длительности из метаданных аудиофайла | Если не удалось определить, используется значение по умолчанию | `src/components/UploadTrackDialog.tsx` (строка 271-277) |
| 2 | Длительность трека | CHECK ограничение | Проверка диапазона (1-7200 секунд) | Ошибка БД при вставке невалидной длительности | `supabase/migrations/20250201000000_complete_database_schema.sql` (строка 239-242) |
| 3 | Счетчик прослушиваний | CHECK ограничение | Проверка неотрицательности (>= 0) | Ошибка БД при обновлении | `supabase/migrations/20250201000000_complete_database_schema.sql` (строка 243) |
| 4 | Счетчик лайков | CHECK ограничение | Проверка неотрицательности (>= 0) | Ошибка БД при обновлении | `supabase/migrations/20250201000000_complete_database_schema.sql` (строка 244) |
| 5 | Порядковый номер трека | CHECK ограничение | Проверка положительности (> 0) | Ошибка БД при вставке | `supabase/migrations/20250201000000_complete_database_schema.sql` (строка 245) |
| 6 | Порядковый номер в плейлисте | CHECK ограничение | Проверка положительности (> 0) | Ошибка БД при вставке | `supabase/migrations/20250201000000_complete_database_schema.sql` (строка 287) |
| 7 | Количество подписчиков | CHECK ограничение | Проверка неотрицательности (>= 0) | Ошибка БД при обновлении | `supabase/migrations/20250201000000_complete_database_schema.sql` (строка 268) |
| 8 | Длительность прослушивания | CHECK ограничение | Проверка неотрицательности (>= 0) | Ошибка БД при вставке | `supabase/migrations/20250201000000_complete_database_schema.sql` (строка 297) |

**Связанные компоненты:**
- `src/components/UploadTrackDialog.tsx` - Диалог загрузки трека
- Таблицы БД: `public.tracks`, `public.playlist_tracks`, `public.playlists`, `public.listening_history`

---

### Таблица 8: Валидация имен артистов и жанров

| № | Этап валидации | Тип проверки | Описание этапа | Действие при ошибке | Класс/Страница |
|---|----------------|--------------|----------------|---------------------|----------------|
| 1 | Имя артиста - длина | HTML5 required | Проверка наличия имени артиста | Браузер блокирует отправку формы | `src/components/BecomeArtistForm.tsx` (строка 332) |
| 2 | Имя артиста - длина | JavaScript проверка | Проверка заполнения имени артиста | Показывается toast с ошибкой `becomeArtist.error.enterName` | `src/components/BecomeArtistForm.tsx` (строка 173-176) |
| 3 | Имя артиста - длина | CHECK ограничение | Проверка длины в БД (2-100 символов) | Ошибка БД при вставке | `supabase/migrations/20250201000000_complete_database_schema.sql` (строка 182-185) |
| 4 | Имя артиста - уникальность | UNIQUE constraint | Гарантия уникальности имени артиста | Ошибка БД: `duplicate key value violates unique constraint` | `supabase/migrations/20250201000000_complete_database_schema.sql` (строка 175) |
| 5 | Название жанра - длина | CHECK ограничение | Проверка длины в БД (2-50 символов) | Ошибка БД при вставке | `supabase/migrations/20250201000000_complete_database_schema.sql` (строка 196-199) |
| 6 | Название жанра - уникальность | UNIQUE constraint | Гарантия уникальности названия жанра | Ошибка БД при вставке | `supabase/migrations/20250201000000_complete_database_schema.sql` (строка 191) |

**Связанные компоненты:**
- `src/components/BecomeArtistForm.tsx` - Форма заявки на артиста
- Таблицы БД: `public.artists`, `public.genres`, `public.artist_applications`

---

### Таблица 9: Валидация URL

| № | Этап валидации | Тип проверки | Описание этапа | Действие при ошибке | Класс/Страница |
|---|----------------|--------------|----------------|---------------------|----------------|
| 1 | URL портфолио | HTML5 type="url" | Проверка формата URL через браузер | Браузер показывает предупреждение при неверном формате | `src/components/BecomeArtistForm.tsx` (строка 386) |
| 2 | URL социальных сетей | HTML5 type="url" | Проверка формата URL для Instagram и YouTube | Браузер показывает предупреждение при неверном формате | `src/components/BecomeArtistForm.tsx` (строка 397, 408) |
| 3 | URL изображений | Хранение в TEXT | URL сохраняются как текст, валидация на уровне приложения | Ошибка при попытке загрузить изображение по неверному URL | `src/components/ImageUpload.tsx` |

**Связанные компоненты:**
- `src/components/BecomeArtistForm.tsx` - Форма заявки на артиста
- `src/components/ImageUpload.tsx` - Компонент загрузки изображений

---

### Таблица 10: Валидация перечислений (Enum) и статусов

| № | Этап валидации | Тип проверки | Описание этапа | Действие при ошибке | Класс/Страница |
|---|----------------|--------------|----------------|---------------------|----------------|
| 1 | Роль пользователя | CHECK ограничение | Проверка допустимых значений ролей | Ошибка БД при вставке недопустимой роли | `supabase/migrations/20250201000000_complete_database_schema.sql` (строка 140-148) |
| 2 | Язык интерфейса | CHECK ограничение | Проверка допустимых значений ('ru', 'en') | Ошибка БД при вставке недопустимого языка | `supabase/migrations/20250201000000_complete_database_schema.sql` (строка 169) |
| 3 | Статус анкеты артиста | CHECK ограничение | Проверка допустимых значений ('pending', 'approved', 'rejected') | Ошибка БД при вставке недопустимого статуса | `supabase/migrations/20250201000000_complete_database_schema.sql` (строка 385-389) |
| 4 | Тип действия в логе аудита | CHECK ограничение | Проверка допустимых значений типов действий | Ошибка БД при вставке недопустимого типа | `supabase/migrations/20250201000000_complete_database_schema.sql` (строка 311-318) |

**Связанные компоненты:**
- Таблицы БД: `public.roles`, `public.users`, `public.artist_applications`, `public.audit_log`

---

## ВАЛИДАЦИЯ НА УРОВНЕ КЛИЕНТА

### Таблица 11: Валидация на уровне React компонентов

| № | Компонент | Тип валидации | Описание | Действие при ошибке | Файл |
|---|-----------|---------------|----------|---------------------|------|
| 1 | Auth.tsx | Валидация формы регистрации | Проверка всех полей перед отправкой | Показ toast с ошибкой, блокировка отправки | `src/pages/Auth.tsx` |
| 2 | Settings.tsx | Валидация профиля | Проверка длины username перед сохранением | Показ toast с ошибкой `settings.usernameMinLength` | `src/pages/Settings.tsx` |
| 3 | Settings.tsx | Валидация пароля | Проверка длины и совпадения паролей | Показ toast с ошибками | `src/pages/Settings.tsx` |
| 4 | BecomeArtistForm.tsx | Валидация заявки артиста | Проверка заполнения имени артиста | Показ toast с ошибкой `becomeArtist.error.enterName` | `src/components/BecomeArtistForm.tsx` |
| 5 | CreateAlbumDialog.tsx | Валидация альбома | Проверка заполнения обязательных полей | Показ toast с ошибкой `album.create.fillAll` | `src/components/CreateAlbumDialog.tsx` |
| 6 | UploadTrackDialog.tsx | Валидация трека | Проверка наличия файла и всех обязательных полей | Показ toast с ошибкой `upload.error.required` | `src/components/UploadTrackDialog.tsx` |
| 7 | CreatePlaylistDialog.tsx | Валидация плейлиста | Проверка длины названия плейлиста | Показ toast с ошибкой о длине | `src/components/CreatePlaylistDialog.tsx` |

---

## ВАЛИДАЦИЯ НА УРОВНЕ БАЗЫ ДАННЫХ

### Таблица 12: CHECK ограничения в базе данных

| № | Таблица | Поле | Ограничение | Описание | Файл миграции |
|---|---------|------|-------------|----------|---------------|
| 1 | roles | role_name | IN ('слушатель', 'администратор', 'артист', 'дистрибьютор', 'модератор') | Проверка допустимых ролей | `20250201000000_complete_database_schema.sql` (строка 140-148) |
| 2 | users | username | LENGTH >= 3 AND LENGTH <= 50 | Длина username | `20250201000000_complete_database_schema.sql` (строка 165-168) |
| 3 | users | language | IN ('ru', 'en') | Допустимые языки | `20250201000000_complete_database_schema.sql` (строка 169) |
| 4 | artists | artist_name | LENGTH >= 2 AND LENGTH <= 100 | Длина имени артиста | `20250201000000_complete_database_schema.sql` (строка 182-185) |
| 5 | genres | genre_name | LENGTH >= 2 AND LENGTH <= 50 | Длина названия жанра | `20250201000000_complete_database_schema.sql` (строка 196-199) |
| 6 | albums | album_title | LENGTH >= 2 AND LENGTH <= 100 | Длина названия альбома | `20250201000000_complete_database_schema.sql` (строка 215-218) |
| 7 | albums | album_release_date | >= '1900-01-01' AND <= CURRENT_DATE + INTERVAL '1 year' | Диапазон дат релиза | `20250201000000_complete_database_schema.sql` (строка 219-222) |
| 8 | tracks | track_title | LENGTH >= 1 AND LENGTH <= 100 | Длина названия трека | `20250201000000_complete_database_schema.sql` (строка 246-249) |
| 9 | tracks | track_duration | > 0 AND <= 7200 | Диапазон длительности трека (секунды) | `20250201000000_complete_database_schema.sql` (строка 239-242) |
| 10 | tracks | track_play_count | >= 0 | Неотрицательный счетчик прослушиваний | `20250201000000_complete_database_schema.sql` (строка 243) |
| 11 | tracks | track_like_count | >= 0 | Неотрицательный счетчик лайков | `20250201000000_complete_database_schema.sql` (строка 244) |
| 12 | tracks | track_order | > 0 | Положительный порядковый номер | `20250201000000_complete_database_schema.sql` (строка 245) |
| 13 | playlists | playlist_title | LENGTH >= 2 AND LENGTH <= 100 | Длина названия плейлиста | `20250201000000_complete_database_schema.sql` (строка 264-267) |
| 14 | playlists | follow_count | >= 0 | Неотрицательный счетчик подписчиков | `20250201000000_complete_database_schema.sql` (строка 268) |
| 15 | playlist_tracks | order_position | > 0 | Положительный порядковый номер в плейлисте | `20250201000000_complete_database_schema.sql` (строка 287) |
| 16 | listening_history | duration_played | >= 0 | Неотрицательная длительность прослушивания | `20250201000000_complete_database_schema.sql` (строка 297) |
| 17 | artist_applications | artist_name | LENGTH >= 2 AND LENGTH <= 100 | Длина имени артиста в заявке | `20250201000000_complete_database_schema.sql` (строка 381-384) |
| 18 | artist_applications | status | IN ('pending', 'approved', 'rejected') | Допустимые статусы заявки | `20250201000000_complete_database_schema.sql` (строка 385-389) |
| 19 | audit_log | action_type | IN ('INSERT', 'UPDATE', 'DELETE', 'SELECT', 'LOGIN', 'LOGOUT') | Допустимые типы действий | `20250201000000_complete_database_schema.sql` (строка 311-318) |

### Таблица 13: UNIQUE ограничения в базе данных

| № | Таблица | Поле/Комбинация полей | Описание | Файл миграции |
|---|---------|----------------------|----------|---------------|
| 1 | roles | role_name | Уникальное название роли | `20250201000000_complete_database_schema.sql` (строка 136) |
| 2 | users | username | Уникальное имя пользователя | `20250201000000_complete_database_schema.sql` (строка 154) |
| 3 | artists | artist_name | Уникальное имя артиста | `20250201000000_complete_database_schema.sql` (строка 175) |
| 4 | genres | genre_name | Уникальное название жанра | `20250201000000_complete_database_schema.sql` (строка 191) |
| 5 | track_genres | (track_id, genre_id) | Уникальная связь трека и жанра | `20250201000000_complete_database_schema.sql` (строка 277) |
| 6 | playlist_tracks | (playlist_id, track_id) | Уникальная связь плейлиста и трека | `20250201000000_complete_database_schema.sql` (строка 288) |
| 7 | favorites_tracks | (user_id, track_id) | Уникальная связь пользователя и избранного трека | `20250201000000_complete_database_schema.sql` (строка 343) |
| 8 | favorites_albums | (user_id, album_id) | Уникальная связь пользователя и избранного альбома | `20250201000000_complete_database_schema.sql` (строка 352) |
| 9 | favorites_playlists | (user_id, playlist_id) | Уникальная связь пользователя и избранного плейлиста | `20250201000000_complete_database_schema.sql` (строка 361) |

### Таблица 14: NOT NULL ограничения в базе данных

| № | Таблица | Поле | Описание | Файл миграции |
|---|---------|------|----------|---------------|
| 1 | users | username | Обязательное имя пользователя | `20250201000000_complete_database_schema.sql` (строка 154) |
| 2 | users | language | Обязательный язык интерфейса | `20250201000000_complete_database_schema.sql` (строка 160) |
| 3 | users | is_active | Обязательный статус активности | `20250201000000_complete_database_schema.sql` (строка 161) |
| 4 | artists | artist_name | Обязательное имя артиста | `20250201000000_complete_database_schema.sql` (строка 175) |
| 5 | genres | genre_name | Обязательное название жанра | `20250201000000_complete_database_schema.sql` (строка 191) |
| 6 | albums | album_title | Обязательное название альбома | `20250201000000_complete_database_schema.sql` (строка 205) |
| 7 | albums | album_release_date | Обязательная дата релиза | `20250201000000_complete_database_schema.sql` (строка 206) |
| 8 | tracks | track_title | Обязательное название трека | `20250201000000_complete_database_schema.sql` (строка 228) |
| 9 | tracks | track_duration | Обязательная длительность трека | `20250201000000_complete_database_schema.sql` (строка 229) |
| 10 | tracks | track_audio_url | Обязательный URL аудиофайла | `20250201000000_complete_database_schema.sql` (строка 231) |
| 11 | playlists | playlist_title | Обязательное название плейлиста | `20250201000000_complete_database_schema.sql` (строка 255) |
| 12 | playlists | user_id | Обязательный владелец плейлиста | `20250201000000_complete_database_schema.sql` (строка 258) |
| 13 | artist_applications | artist_name | Обязательное имя артиста в заявке | `20250201000000_complete_database_schema.sql` (строка 368) |
| 14 | artist_applications | status | Обязательный статус заявки | `20250201000000_complete_database_schema.sql` (строка 375) |

---

## ВАЛИДАЦИЯ ЗАГРУЖАЕМЫХ ФАЙЛОВ

### Таблица 15: Валидация аудиофайлов

| № | Этап валидации | Тип проверки | Описание этапа | Действие при ошибке | Класс/Страница |
|---|----------------|--------------|----------------|---------------------|----------------|
| 1 | Формат файла | Проверка расширения | Проверка расширения файла (.mp3, .wav, .flac, .ogg, .m4a) | Показывается toast с ошибкой `upload.error.fileFormat` | `src/components/UploadTrackDialog.tsx` (строка 221-225) |
| 2 | Размер файла | Проверка размера | Проверка максимального размера (50 MB) | Показывается toast с ошибкой `upload.error.fileSize` | `src/components/UploadTrackDialog.tsx` (строка 228-231) |
| 3 | Наличие файла | JavaScript проверка | Проверка выбора файла перед отправкой | Показывается toast с ошибкой `upload.error.required` | `src/components/UploadTrackDialog.tsx` (строка 255-258) |
| 4 | MIME-тип | HTML5 accept | Ограничение выбора файлов по типу | Браузер фильтрует файлы при выборе | `src/components/UploadTrackDialog.tsx` (строка 379) |
| 5 | Длительность | Автоматическое определение | Извлечение длительности из метаданных | Если не удалось определить, используется значение по умолчанию | `src/components/UploadTrackDialog.tsx` (строка 271-277) |

**Связанные компоненты:**
- `src/components/UploadTrackDialog.tsx` - Диалог загрузки трека
- Supabase Storage bucket: `songs`

### Таблица 16: Валидация изображений

| № | Этап валидации | Тип проверки | Описание этапа | Действие при ошибке | Класс/Страница |
|---|----------------|--------------|----------------|---------------------|----------------|
| 1 | Тип файла | Проверка MIME-типа | Проверка типа файла (должен начинаться с 'image/') | Показывается toast с ошибкой `image.upload.selectImage` | `src/components/ImageUpload.tsx` (строка 35-38) |
| 2 | Размер файла | Проверка размера | Проверка максимального размера (по умолчанию 5 MB, настраивается) | Показывается toast с ошибкой `image.upload.maxSize` | `src/components/ImageUpload.tsx` (строка 41-45) |
| 3 | MIME-тип | HTML5 accept | Ограничение выбора файлов по типу | Браузер фильтрует файлы при выборе | `src/components/ImageUpload.tsx` (строка 153) |
| 4 | Доступ к Storage | Проверка прав доступа | Проверка доступности bucket и прав RLS | Показывается toast с ошибкой `image.upload.bucketNotFound` или `image.upload.noPermission` | `src/components/ImageUpload.tsx` (строка 82-89) |

**Связанные компоненты:**
- `src/components/ImageUpload.tsx` - Компонент загрузки изображений
- Supabase Storage buckets: `covers`, `avatars`

**Ограничения Storage:**
- **songs**: Максимальный размер 50 MB, форматы: mp3, wav, flac, ogg, m4a
- **covers**: Максимальный размер 5 MB, форматы: jpeg, png, webp
- **avatars**: Максимальный размер 5 MB, форматы: jpeg, jpg, png, webp

---

## ОБРАБОТКА ОШИБОК ВАЛИДАЦИИ

### Таблица 17: Типы ошибок и их обработка

| № | Тип ошибки | Источник | Описание | Действие при ошибке | Компонент |
|---|------------|----------|----------|---------------------|-----------|
| 1 | Ошибка формата данных | HTML5 валидация | Неверный формат email, URL, даты | Браузер блокирует отправку формы, показывает стандартное сообщение | Все формы с input полями |
| 2 | Ошибка длины строки | JavaScript проверка | Превышение допустимой длины | Показ toast с сообщением об ошибке | `Auth.tsx`, `Settings.tsx`, `CreatePlaylistDialog.tsx` |
| 3 | Ошибка уникальности | SQL запрос / БД | Дублирование уникального значения | Показ toast с сообщением об ошибке | `Auth.tsx` (username) |
| 4 | Ошибка CHECK ограничения | PostgreSQL | Нарушение CHECK ограничения | Ошибка БД, показ toast с сообщением | Все компоненты с вставкой данных |
| 5 | Ошибка UNIQUE constraint | PostgreSQL | Нарушение уникальности | Ошибка БД, показ toast с сообщением | Все компоненты с вставкой данных |
| 6 | Ошибка NOT NULL constraint | PostgreSQL | Попытка вставить NULL в обязательное поле | Ошибка БД, показ toast с сообщением | Все компоненты с вставкой данных |
| 7 | Ошибка формата файла | JavaScript проверка | Неверный формат загружаемого файла | Показ toast с ошибкой, блокировка загрузки | `UploadTrackDialog.tsx`, `ImageUpload.tsx` |
| 8 | Ошибка размера файла | JavaScript проверка | Превышение максимального размера | Показ toast с ошибкой, блокировка загрузки | `UploadTrackDialog.tsx`, `ImageUpload.tsx` |
| 9 | Ошибка авторизации | Supabase Auth | Неверные учетные данные или отсутствие прав | Показ toast с ошибкой, блокировка операции | Все компоненты с авторизацией |
| 10 | Ошибка RLS (Row Level Security) | PostgreSQL RLS | Нарушение политик безопасности | Ошибка БД, показ toast с сообщением | Все компоненты с доступом к БД |

---

## СВЯЗАННЫЕ КОМПОНЕНТЫ И СТРАНИЦЫ

### Таблица 18: Компоненты с валидацией данных

| № | Компонент/Страница | Типы валидации | Основные поля |
|---|-------------------|----------------|---------------|
| 1 | `src/pages/Auth.tsx` | Email, пароль, username | email, password, username, first_name, last_name |
| 2 | `src/pages/Settings.tsx` | Username, пароль | username, password, confirmPassword |
| 3 | `src/components/BecomeArtistForm.tsx` | Имя артиста, URL, текст | artist_name, portfolio_url, instagram_url, youtube_url |
| 4 | `src/components/CreateAlbumDialog.tsx` | Название альбома, дата | album_title, album_release_date, artist_id |
| 5 | `src/components/UploadTrackDialog.tsx` | Файл, название трека | file, track_title, artist_id, album_id |
| 6 | `src/components/CreatePlaylistDialog.tsx` | Название плейлиста | playlist_title, playlist_description |
| 7 | `src/components/ImageUpload.tsx` | Изображение, размер, формат | file (image), maxSizeMB |

---

## ЗАКЛЮЧЕНИЕ

Система валидации данных в проекте Imperial Tunes обеспечивает:

1. **Многоуровневая защита**: Валидация на клиенте, сервере (БД) и уровне Storage
2. **Пользовательский опыт**: Быстрая обратная связь через toast-уведомления
3. **Целостность данных**: Гарантия корректности данных через CHECK, UNIQUE и NOT NULL ограничения
4. **Безопасность**: Проверка прав доступа через RLS и Supabase Auth
5. **Производительность**: Индексы для быстрой проверки уникальности

Все валидации документированы в миграциях БД и реализованы в React компонентах с соответствующими сообщениями об ошибках для пользователей.

---