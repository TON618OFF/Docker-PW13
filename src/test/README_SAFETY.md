# Безопасность Unit-тестов

## ✅ Гарантии безопасности

**Все unit-тесты полностью изолированы от реальной базы данных и не могут повлиять на производственные данные.**

## Как это работает

### 1. Моки Supabase клиента

Все тесты используют `vi.mock()` для полной замены Supabase клиента:

```typescript
vi.mock('@/integrations/supabase/client', () => ({
  supabase: {
    from: vi.fn(),
    rpc: vi.fn(),
  },
}));
```

**Это означает:**
- Реальный `createClient()` из `@supabase/supabase-js` **НИКОГДА** не вызывается
- Никакие HTTP запросы к Supabase API **НЕ отправляются**
- Реальная база данных **НЕ используется**

### 2. Изоляция тестов

Каждый тест:
- Использует только мокированные функции (`vi.fn()`)
- Возвращает фиктивные данные через `mockResolvedValue()` и `mockReturnValue()`
- Не имеет доступа к реальной сети или БД

### 3. Защита в CI/CD

В GitHub Actions:
- Переменные окружения `VITE_SUPABASE_URL` и `VITE_SUPABASE_ANON_KEY` используются только для информации
- **Даже если они установлены, они НЕ используются**, так как клиент полностью замокан
- Тесты выполняются в изолированном окружении без доступа к реальной БД

## Что происходит в тестах

### Пример: тест создания трека

```typescript
it('должен создать новый трек', async () => {
  const mockQuery = {
    insert: vi.fn().mockReturnThis(),
    select: vi.fn().mockReturnThis(),
    single: vi.fn().mockResolvedValue({ 
      data: { id: '1', ...newTrack }, 
      error: null 
    }),
  };

  vi.mocked(supabase.from).mockReturnValue(mockQuery as any);
  
  await tracksAPI.createTrack(newTrack);
  
  // ✅ Проверяется только, что был вызван метод insert
  // ✅ НИКАКИХ реальных запросов к БД НЕ происходит
});
```

**Что НЕ происходит:**
- ❌ Нет HTTP запроса к Supabase
- ❌ Нет подключения к PostgreSQL
- ❌ Нет записи в реальную БД
- ❌ Нет изменения данных

**Что происходит:**
- ✅ Проверяется логика построения запроса
- ✅ Проверяется правильность вызова методов
- ✅ Проверяется применение фильтров

## Дополнительные меры защиты

### 1. Автоматическая проверка в setup.ts

Файл `src/test/setup.ts` содержит защиту:
- Переопределяет переменные окружения на тестовые значения
- Предупреждает, если тесты запускаются не в тестовом режиме

### 2. Изоляция окружения

Vitest запускается в отдельном процессе с:
- Собственным окружением (`environment: "jsdom"`)
- Изолированными модулями
- Отдельным контекстом выполнения

## Проверка безопасности

### Как убедиться, что тесты безопасны:

1. **Проверьте наличие моков:**
   ```bash
   grep -r "vi.mock.*supabase" src/services/api/__tests__/
   ```
   ✅ Должны быть во всех тестовых файлах

2. **Проверьте отсутствие реальных запросов:**
   ```bash
   grep -r "createClient\|fetch\|axios" src/services/api/__tests__/
   ```
   ✅ Не должно быть реальных HTTP клиентов

3. **Запустите тесты с отключенной сетью:**
   ```bash
   # В Linux/Mac можно использовать:
   sudo iptables -A OUTPUT -p tcp --dport 443 -j DROP
   npm test
   # Тесты должны пройти успешно
   ```

## Что делать, если нужно протестировать реальное подключение?

**Для интеграционных тестов:**
- Используйте отдельную тестовую БД
- Настройте отдельные переменные окружения
- Используйте транзакции с откатом
- Запускайте в изолированном окружении (Docker)

**Unit-тесты НИКОГДА не должны:**
- ❌ Подключаться к реальной БД
- ❌ Использовать реальные API ключи
- ❌ Изменять реальные данные

## FAQ

**Q: Что если я случайно использую реальный клиент в тесте?**  
A: Vitest выдаст ошибку, так как мок переопределяет весь модуль. Реальный клиент не будет создан.

**Q: Могут ли переменные окружения в CI подключиться к БД?**  
A: Нет. Даже если они установлены, моки полностью заменяют клиент, и реальные запросы не выполняются.

**Q: Что если тест упадет и попытается подключиться?**  
A: Невозможно. Моки возвращают фиктивные данные, реальный клиент не создается.

**Q: Как проверить, что тесты действительно безопасны?**  
A: Запустите тесты с отключенным интернетом - они должны пройти успешно.

## Итог

✅ **Unit-тесты полностью безопасны**  
✅ **Реальная БД не используется**  
✅ **Производственные данные защищены**  
✅ **CI/CD не может повлиять на БД**

---