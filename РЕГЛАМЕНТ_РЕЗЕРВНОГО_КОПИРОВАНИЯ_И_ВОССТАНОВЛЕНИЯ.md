# Регламент резервного копирования и восстановления ImperialTunes

## Версия документа: 2.1
## Дата создания: 09.11.2025
## Дата последнего обновления: 09.11.2025

## Ответственное лицо: Администратор БД

---

## Оглавление

1. [Общие положения](#общие-положения)
2. [Цели и задачи](#цели-и-задачи)
3. [Область применения](#область-применения)
4. [Типы резервных копий](#типы-резервных-копий)
5. [Регламент резервного копирования](#регламент-резервного-копирования)
6. [Регламент восстановления](#регламент-восстановления)
7. [Процедуры тестирования восстановления](#процедуры-тестирования-восстановления)
8. [Хранение резервных копий](#хранение-резервных-копий)
9. [Мониторинг и контроль](#мониторинг-и-контроль)
10. [План действий при инцидентах](#план-действий-при-инцидентах)
11. [Демонстрация восстановления на учебном стенде](#демонстрация-восстановления-на-учебном-стенде)
12. [Приложения](#приложения)

---

## Общие положения

### Назначение документа

Настоящий регламент определяет порядок создания, хранения и восстановления резервных копий базы данных и файлов системы ImperialTunes.

### Нормативные документы

- ГОСТ Р 57580.1-2017 "Резервное копирование и восстановление"
- Политика информационной безопасности организации
- Инструкция по эксплуатации базы данных

### Термины и определения

- **Резервная копия (бэкап)** - копия данных системы на определённый момент времени
- **Полная резервная копия** - копия всех данных и структуры БД
- **Инкрементальная резервная копия** - копия изменений с момента последнего бэкапа
- **Точка восстановления (RPO - Recovery Point Objective)** - максимально допустимая потеря данных
- **Время восстановления (RTO - Recovery Time Objective)** - максимально допустимое время простоя системы
- **Учебный стенд** - изолированная среда для тестирования процедур восстановления

---

## Цели и задачи

### Цели

1. Обеспечение непрерывности работы системы
2. Защита данных от потери и повреждения
3. Минимизация времени простоя при сбоях
4. Соответствие требованиям информационной безопасности

### Задачи

1. Регулярное создание резервных копий
2. Безопасное хранение резервных копий
3. Быстрое восстановление системы при сбоях
4. Тестирование процедур восстановления
5. Документирование всех операций

---

## Область применения

### Что подлежит резервному копированию

1. **База данных PostgreSQL:**
   - Все таблицы схемы `public`
   - Все функции, триггеры, представления
   - Все индексы и ограничения
   - Все RLS политики
   - Все данные таблиц

2. **Файлы Storage (Supabase Storage):**
   - Bucket `songs` - аудио файлы
   - Bucket `covers` - обложки альбомов
   - Bucket `avatars` - аватары пользователей

3. **Конфигурационные файлы:**
   - Миграции БД (`supabase/migrations/`)
   - Переменные окружения (`.env.local`)
   - Конфигурация Docker (`docker-compose.yml`)
   - Конфигурация Nginx (`nginx.conf`)

4. **Код приложения:**
   - Исходный код (хранится в Git)
   - Собранные артефакты (опционально)

### Что не подлежит резервному копированию

1. Временные файлы и кэш
2. Логи (хранятся отдельно)
3. Данные сессий пользователей
4. Файлы node_modules (восстанавливаются из package.json)

---

## Типы резервных копий

### 1. Полная резервная копия (Full Backup)

**Описание:** Полная копия всех данных и структуры БД

**Частота:** Ежедневно в 02:00 UTC

**Содержимое:**
- SQL дамп всей БД (схема + данные)
- Все файлы из Storage buckets
- Конфигурационные файлы
- Метаданные бэкапа

**Размер:** Зависит от объёма данных (обычно 10-100 MB для БД + размер файлов)

**Время создания:** 5-30 минут (зависит от объёма данных)

**Хранение:** 30 дней

### 2. Инкрементальная резервная копия (Incremental Backup)

**Описание:** Копия изменений с момента последнего полного бэкапа

**Частота:** Каждые 6 часов

**Содержимое:**
- Изменённые таблицы
- Новые файлы в Storage
- Изменённые конфигурационные файлы

**Размер:** Меньше полного бэкапа (обычно 1-10 MB)

**Время создания:** 1-5 минут

**Хранение:** 7 дней

### 3. Резервная копия перед миграцией (Pre-Migration Backup)

**Описание:** Полная копия перед применением миграций БД

**Частота:** Перед каждой миграцией

**Содержимое:**
- SQL дамп текущего состояния БД
- Все файлы из Storage

**Размер:** Зависит от объёма данных

**Время создания:** 5-30 минут

**Хранение:** До успешного применения миграции + 7 дней

### 4. Резервная копия перед обновлением (Pre-Update Backup)

**Описание:** Полная копия перед обновлением системы

**Частота:** Перед каждым обновлением

**Содержимое:**
- SQL дамп текущего состояния БД
- Все файлы из Storage
- Конфигурационные файлы
- Версия кода приложения

**Размер:** Зависит от объёма данных

**Время создания:** 5-30 минут

**Хранение:** До успешного обновления + 30 дней

---

## Регламент резервного копирования

### Ежедневное резервное копирование

#### Расписание

- **Время:** 02:00 UTC (05:00 MSK)
- **Частота:** Ежедневно
- **Тип:** Полная резервная копия
- **Автоматизация:** Да (через cron/Task Scheduler)

#### Процедура выполнения

1. **Подготовка:**
   ```bash
   # Проверка доступности Supabase
   # Проверка наличия свободного места на диске
   # Проверка переменных окружения
   ```

2. **Создание бэкапа БД:**
   ```bash
   # Метод 1: Через pg_dump (если доступен SUPABASE_DB_URL)
   node scripts/backup-supabase.js
   
   # Метод 2: Через Supabase API (если pg_dump недоступен)
   # Автоматически выбирается в скрипте
   ```

3. **Создание бэкапа Storage:**
   ```bash
   # Автоматически выполняется в scripts/backup-supabase.js
   # Скачивание всех файлов из buckets: songs, covers, avatars
   ```

4. **Создание архива:**
   ```bash
   # Автоматически создаётся tar.gz архив (на Linux/Mac)
   # На Windows создаётся несжатый архив
   ```

5. **Создание метаданных:**
   ```bash
   # Автоматически создаётся файл backup_info.txt
   # Содержит информацию о бэкапе: дата, размер, количество файлов
   ```

6. **Загрузка в облачное хранилище (опционально):**
   ```bash
   # Если настроено облачное хранилище (AWS S3, Google Drive)
   node scripts/upload-to-cloud.js ./backups/supabase_backup_YYYYMMDD_HHMMSS.tar.gz
   ```

7. **Проверка целостности:**
   ```bash
   # Проверка размера файлов
   # Проверка наличия всех необходимых файлов
   # Проверка структуры бэкапа
   ```

8. **Уведомление:**
   ```bash
   # Отправка уведомления об успешном создании бэкапа
   # Или об ошибке (если произошла)
   ```

#### Скрипт автоматизации (Linux/Mac)

```bash
#!/bin/bash
# /etc/cron.daily/imperial-tunes-backup

# Загрузить переменные окружения
source /path/to/project/.env.backup

# Перейти в директорию проекта
cd /path/to/project

# Создать бэкап
node scripts/backup-supabase.js

# Проверить результат
if [ $? -eq 0 ]; then
    echo "Backup completed successfully"
    # Отправить уведомление
    mail -s "ImperialTunes Backup Success" admin@example.com <<< "Backup completed successfully"
else
    echo "Backup failed"
    # Отправить уведомление об ошибке
    mail -s "ImperialTunes Backup Failed" admin@example.com <<< "Backup failed. Check logs."
    exit 1
fi
```

#### Скрипт автоматизации (Windows)

**Вариант 1: Batch скрипт (CMD)**

```batch
@echo off
REM C:\Scripts\imperial-tunes-backup.bat
REM Или: C:\Study\imperial-tunes\react\scripts\backup-supabase.bat

REM Перейти в директорию проекта
cd /d C:\Study\imperial-tunes\react\

REM Загрузить переменные окружения из файла
REM Создайте файл .env.backup с переменными:
REM SUPABASE_URL=https://[project-ref].supabase.co
REM SUPABASE_SERVICE_ROLE_KEY=[your-key]
REM SUPABASE_DB_URL=postgresql://postgres:[password]@db.[project-ref].supabase.co:5432/postgres
for /f "usebackq tokens=1,* delims==" %%a in ("%CD%\.env.backup") do set %%a=%%b

REM Создать бэкап
node scripts\backup-supabase.js

REM Проверить результат
if %ERRORLEVEL% EQU 0 (
    echo Backup completed successfully
    REM Можно добавить отправку email через PowerShell
    powershell -Command "Send-MailMessage -To 'admin@example.com' -Subject 'ImperialTunes Backup Success' -Body 'Backup completed successfully' -SmtpServer 'smtp.example.com'"
) else (
    echo Backup failed
    powershell -Command "Send-MailMessage -To 'admin@example.com' -Subject 'ImperialTunes Backup Failed' -Body 'Backup failed. Check logs.' -SmtpServer 'smtp.example.com'"
    exit /b 1
)
```

**Вариант 2: PowerShell скрипт (рекомендуется)**

```powershell
# C:\Scripts\imperial-tunes-backup.ps1
# Или: C:\Study\imperial-tunes\react\scripts\backup-supabase.ps1

# Перейти в директорию проекта
$projectPath = "C:\Study\imperial-tunes\react"
Set-Location $projectPath

# Загрузить переменные окружения из файла
if (Test-Path ".env.backup") {
    Get-Content ".env.backup" | ForEach-Object {
        if ($_ -match '^([^#][^=]+)=(.*)$') {
            [Environment]::SetEnvironmentVariable($matches[1], $matches[2], "Process")
        }
    }
}

# Создать бэкап
$result = node scripts\backup-supabase.js

# Проверить результат
if ($LASTEXITCODE -eq 0) {
    Write-Host "Backup completed successfully" -ForegroundColor Green
    # Отправить уведомление (если настроено)
    # Send-MailMessage -To "admin@example.com" -Subject "ImperialTunes Backup Success" -Body "Backup completed successfully" -SmtpServer "smtp.example.com"
} else {
    Write-Host "Backup failed" -ForegroundColor Red
    # Send-MailMessage -To "admin@example.com" -Subject "ImperialTunes Backup Failed" -Body "Backup failed. Check logs." -SmtpServer "smtp.example.com"
    exit 1
}
```

**Настройка Task Scheduler (Windows):**

1. Открыть **Task Scheduler** (Планировщик заданий):
   - `Win + R` → ввести `taskschd.msc` → Enter
   - Или: Панель управления → Администрирование → Планировщик заданий

2. Создать новое задание:
   - В правой панели: **Create Basic Task** (Создать простую задачу)
   - Имя: `ImperialTunes Daily Backup`
   - Описание: `Ежедневное резервное копирование базы данных ImperialTunes`

3. Настроить триггер:
   - **Trigger:** Daily (Ежедневно)
   - **Start:** `05:00:00` (или нужное время)
   - **Recur every:** `1 days`

4. Настроить действие:
   - **Action:** Start a program (Запустить программу)
   - **Program/script:** `powershell.exe` (для PowerShell) или `cmd.exe` (для Batch)
   - **Add arguments:**
     - Для PowerShell: `-ExecutionPolicy Bypass -File "C:\Scripts\imperial-tunes-backup.ps1"`
     - Для Batch: `/c "C:\Scripts\imperial-tunes-backup.bat"`

5. Настроить условия:
   - ✅ **Run whether user is logged on or not** (Запускать независимо от регистрации пользователя)
   - ✅ **Run with highest privileges** (Запускать с наивысшими правами)
   - ✅ **Start the task only if the computer is on AC power** (если на ноутбуке)

6. Настроить параметры:
   - ✅ **Allow task to be run on demand** (Разрешить запуск по требованию)
   - ✅ **Run task as soon as possible after a scheduled start is missed** (Запускать задачу как можно скорее после пропуска запланированного запуска)

7. Сохранить задание

### Еженедельное резервное копирование

#### Расписание

- **Время:** Воскресенье, 03:00 UTC (06:00 MSK)
- **Частота:** Еженедельно
- **Тип:** Полная резервная копия с расширенным хранением
- **Автоматизация:** Да

#### Процедура выполнения

Аналогична ежедневному резервному копированию, но:
- Бэкап сохраняется с пометкой "weekly"
- Хранится 4 недели (вместо 30 дней)
- Загружается в долгосрочное хранилище (AWS S3 Glacier, если настроено)

### Ежемесячное резервное копирование

#### Расписание

- **Время:** Первое число месяца, 04:00 UTC (07:00 MSK)
- **Частота:** Ежемесячно
- **Тип:** Полная резервная копия с архивацией
- **Автоматизация:** Да

#### Процедура выполнения

Аналогична ежедневному резервному копированию, но:
- Бэкап сохраняется с пометкой "monthly"
- Хранится 12 месяцев
- Загружается в долгосрочное хранилище (AWS S3 Glacier, если настроено)
- Создаётся отчёт о размере бэкапа и использовании хранилища

### Резервное копирование перед миграцией

#### Когда выполняется

Перед применением каждой миграции БД

#### Процедура выполнения

1. **Создание бэкапа:**
   ```bash
   # Создать бэкап с пометкой "pre-migration"
   node scripts/backup-supabase.js
   ```

2. **Сохранить имя файла миграции:**
   
   **Windows (PowerShell):**
   ```powershell
   # Записать имя файла миграции в backup_info.txt
   Add-Content -Path "backup_info.txt" -Value "Migration: 20250201000000_complete_database_schema.sql"
   ```
   
   **Windows (CMD):**
   ```batch
   REM Записать имя файла миграции в backup_info.txt
   echo Migration: 20250201000000_complete_database_schema.sql >> backup_info.txt
   ```
   
   **Linux/Mac:**
   ```bash
   # Записать имя файла миграции в backup_info.txt
   echo "Migration: 20250201000000_complete_database_schema.sql" >> backup_info.txt
   ```

3. **Применить миграцию:**
   
   **Windows:**
   ```batch
   REM Применить миграцию через psql
   REM Убедитесь, что PostgreSQL установлен и добавлен в PATH
   psql -h localhost -U postgres -d imperial_tunes -f supabase\migrations\20250201000000_complete_database_schema.sql
   
   REM Или через Supabase CLI
   supabase db push
   ```
   
   **Linux/Mac:**
   ```bash
   # Применить миграцию
   psql -h localhost -U postgres -d imperial_tunes -f supabase/migrations/20250201000000_complete_database_schema.sql
   ```

4. **Проверить результат:**
   ```bash
   # Проверить, что миграция применена успешно
   # Проверить целостность данных
   ```

5. **Удалить бэкап (опционально):**
   ```bash
   # Если миграция успешна, можно удалить pre-migration бэкап через 7 дней
   # Если миграция неуспешна, восстановить из бэкапа
   ```

### Резервное копирование перед обновлением

#### Когда выполняется

Перед каждым обновлением системы (изменение кода, зависимостей, конфигурации)

#### Процедура выполнения

1. **Создание бэкапа:**
   ```bash
   # Создать полный бэкап с пометкой "pre-update"
   node scripts/backup-supabase.js
   ```

2. **Сохранить версию кода:**
   
   **Windows (PowerShell):**
   ```powershell
   # Записать текущую версию Git commit
   git rev-parse HEAD | Out-File -FilePath "backup_info.txt" -Append
   ```
   
   **Windows (CMD):**
   ```batch
   REM Записать текущую версию Git commit
   git rev-parse HEAD >> backup_info.txt
   ```
   
   **Linux/Mac:**
   ```bash
   # Записать текущую версию Git commit
   git rev-parse HEAD > backup_info.txt
   ```

3. **Выполнить обновление:**
   ```bash
   # Обновить код, зависимости, конфигурацию
   git pull
   npm install
   npm run build
   ```

4. **Проверить результат:**
   ```bash
   # Проверить, что система работает корректно
   # Проверить целостность данных
   ```

5. **Удалить бэкап (опционально):**
   ```bash
   # Если обновление успешно, можно удалить pre-update бэкап через 30 дней
   # Если обновление неуспешно, восстановить из бэкапа
   ```

---

## Регламент восстановления

### Типы восстановления

#### 1. Полное восстановление (Full Restore)

**Когда используется:**
- Полная потеря данных
- Катастрофический сбой
- Восстановление после атаки

**Процедура:**

1. **Подготовка:**
   ```bash
   # Остановить приложение
   # Проверить наличие бэкапа
   # Проверить целостность бэкапа
   ```

2. **Восстановление БД:**
   
   **Windows (PowerShell):**
   ```powershell
   # Загрузить переменные окружения из файла
   if (Test-Path ".env.backup") {
       Get-Content ".env.backup" | ForEach-Object {
           if ($_ -match '^([^#][^=]+)=(.*)$') {
               [Environment]::SetEnvironmentVariable($matches[1], $matches[2], "Process")
           }
       }
   }
   
   # Восстановить из бэкапа
   node scripts\restore-supabase.js .\backups\supabase_backup_YYYYMMDD_HHMMSS
   ```
   
   **Windows (CMD):**
   ```batch
   REM Загрузить переменные окружения из файла
   for /f "usebackq tokens=1,* delims==" %%a in (".env.backup") do set %%a=%%b
   
   REM Восстановить из бэкапа
   node scripts\restore-supabase.js .\backups\supabase_backup_YYYYMMDD_HHMMSS
   ```
   
   **Linux/Mac:**
   ```bash
   # Загрузить переменные окружения
   source .env.backup
   
   # Восстановить из бэкапа
   node scripts/restore-supabase.js ./backups/supabase_backup_YYYYMMDD_HHMMSS
   ```

3. **Восстановление Storage:**
   ```bash
   # Автоматически выполняется в scripts/restore-supabase.js
   # Загрузка файлов в buckets: songs, covers, avatars
   ```

4. **Проверка восстановления:**
   ```bash
   # Проверить количество записей в таблицах
   # Проверить наличие файлов в Storage
   # Проверить целостность данных
   ```

5. **Запуск приложения:**
   ```bash
   # Запустить приложение
   # Проверить работу системы
   ```

**Время восстановления:** 10-60 минут (зависит от размера бэкапа)

#### 2. Восстановление отдельных таблиц (Partial Restore)

**Когда используется:**
- Потеря данных в отдельных таблицах
- Ошибка в данных конкретной таблицы

**Процедура:**

1. **Экстракция таблицы из бэкапа:**
   
   **Windows (PowerShell):**
   ```powershell
   # Если бэкап в формате .gz, сначала распаковать (нужен 7-Zip или WinRAR)
   # 7z x backups\imperial_tunes_backup_YYYYMMDD.sql.gz
   
   # Извлечь данные таблицы из SQL дампа
   Get-Content backups\imperial_tunes_backup_YYYYMMDD.sql | 
       Select-String -Pattern "COPY public.users" -Context 0,10000 | 
       Out-File users_backup.sql
   
   # Или если бэкап уже распакован
   Select-String -Path "backups\imperial_tunes_backup_YYYYMMDD.sql" -Pattern "COPY public.users" -Context 0,10000 | 
       Out-File users_backup.sql
   ```
   
   **Windows (CMD) - требует установки grep (через Git Bash или WSL):**
   ```batch
   REM Если бэкап в формате .gz, сначала распаковать
   REM 7z x backups\imperial_tunes_backup_YYYYMMDD.sql.gz
   
   REM Извлечь данные таблицы (требуется grep, например через Git Bash)
   REM grep -A 10000 "COPY public.users" backups\imperial_tunes_backup_YYYYMMDD.sql > users_backup.sql
   ```
   
   **Linux/Mac:**
   ```bash
   # Извлечь данные таблицы из SQL дампа
   gunzip -c backups/imperial_tunes_backup_YYYYMMDD.sql.gz | \
     grep -A 10000 "COPY public.users" > users_backup.sql
   ```

2. **Восстановление таблицы:**
   ```sql
   -- Очистить таблицу (если нужно)
   TRUNCATE TABLE public.users CASCADE;
   
   -- Импортировать данные
   \i users_backup.sql
   ```

**Время восстановления:** 1-10 минут

#### 3. Восстановление до определённого момента времени (Point-in-Time Recovery)

**Когда используется:**
- Необходимость восстановления данных до определённого момента
- Откат изменений после ошибки

**Процедура:**

1. **Восстановить из последнего полного бэкапа:**
   ```bash
   node scripts/restore-supabase.js ./backups/supabase_backup_YYYYMMDD_HHMMSS
   ```

2. **Применить WAL файлы до нужного момента (если доступны):**
   ```bash
   # Настройка recovery.conf (PostgreSQL 12+)
   restore_command = 'cp /path/to/wal/%f %p'
   recovery_target_time = '2025-02-01 14:30:00'
   ```

**Время восстановления:** 10-60 минут + время применения WAL

#### 4. Восстановление после сбоя миграции

**Когда используется:**
- Миграция завершилась с ошибкой
- Часть данных повреждена

**Процедура:**

1. **Откатить миграцию:**
   ```sql
   -- Откатить изменения миграции вручную
   -- (зависит от содержимого миграции)
   ```

2. **Восстановить из pre-migration бэкапа:**
   
   **Windows (PowerShell):**
   ```powershell
   # Найти бэкап перед миграцией
   Get-ChildItem backups\ | Where-Object { $_.Name -like "*pre-migration*" } | Sort-Object LastWriteTime -Descending
   
   # Восстановить из бэкапа (замените на актуальное имя)
   node scripts\restore-supabase.js .\backups\supabase_backup_pre-migration_YYYYMMDD_HHMMSS
   ```
   
   **Windows (CMD):**
   ```batch
   REM Найти бэкап перед миграцией
   dir backups\*pre-migration* /O-D
   
   REM Восстановить из бэкапа (замените на актуальное имя)
   node scripts\restore-supabase.js .\backups\supabase_backup_pre-migration_YYYYMMDD_HHMMSS
   ```
   
   **Linux/Mac:**
   ```bash
   # Найти бэкап перед миграцией
   ls -lt backups/ | grep "pre-migration"
   
   # Восстановить из бэкапа
   node scripts/restore-supabase.js ./backups/supabase_backup_pre-migration_YYYYMMDD_HHMMSS
   ```

3. **Исправить миграцию:**
   
   **Windows:**
   ```batch
   REM Исправить миграцию
   REM Затем применить заново
   psql -h localhost -U postgres -d imperial_tunes -f supabase\migrations\FIXED_MIGRATION.sql
   ```
   
   **Linux/Mac:**
   ```bash
   # Исправить миграцию
   # Затем применить заново
   psql -h localhost -U postgres -d imperial_tunes -f supabase/migrations/FIXED_MIGRATION.sql
   ```

**Время восстановления:** 10-30 минут

#### 5. Восстановление после удаления файлов в Storage

**Когда используется:**
- Случайное удаление файлов из Storage
- Потеря файлов при миграции

**Процедура:**

1. **Проверка удалённых файлов:**
   ```sql
   -- Найти записи с несуществующими файлами
   SELECT id, track_audio_url 
   FROM tracks 
   WHERE track_audio_url IS NOT NULL;
   ```

2. **Восстановление файлов из бэкапа:**
   ```bash
   # Восстановить файлы из бэкапа Storage
   supabase storage upload songs ./backups/storage/songs --upsert
   ```

3. **Обновление URL в БД (если нужно):**
   ```sql
   -- Обновить URL если файлы были перемещены
   UPDATE tracks 
   SET track_audio_url = REPLACE(track_audio_url, 'old_path', 'new_path')
   WHERE track_audio_url LIKE 'old_path%';
   ```

**Время восстановления:** 5-30 минут (зависит от количества файлов)

---

## Процедуры тестирования восстановления

### Ежемесячное тестирование восстановления

#### Расписание

- **Время:** Первое число месяца, 10:00 UTC (13:00 MSK)
- **Частота:** Ежемесячно
- **Тип:** Тестирование на учебном стенде

#### Процедура выполнения

1. **Подготовка учебного стенда:**
   ```bash
   # Создать новый проект Supabase (тестовый)
   # Или использовать локальный PostgreSQL
   ```

2. **Выбор бэкапа для тестирования:**
   
   **Windows (PowerShell):**
   ```powershell
   # Выбрать последний бэкап из последних 30 дней
   $BACKUP_FILE = Get-ChildItem backups\supabase_backup_* | 
       Where-Object { $_.LastWriteTime -gt (Get-Date).AddDays(-30) } | 
       Sort-Object LastWriteTime -Descending | 
       Select-Object -First 1
   
   Write-Host "Selected backup: $($BACKUP_FILE.FullName)"
   ```
   
   **Windows (CMD):**
   ```batch
   REM Выбрать последний бэкап (вручную указать имя)
   REM Или использовать PowerShell команду выше
   ```
   
   **Linux/Mac:**
   ```bash
   # Выбрать случайный бэкап из последних 30 дней
   BACKUP_FILE=$(ls -t backups/supabase_backup_* | head -1)
   ```

3. **Восстановление на учебном стенде:**
   
   **Windows (PowerShell):**
   ```powershell
   # Загрузить переменные окружения тестового проекта
   if (Test-Path ".env.backup.test") {
       Get-Content ".env.backup.test" | ForEach-Object {
           if ($_ -match '^([^#][^=]+)=(.*)$') {
               [Environment]::SetEnvironmentVariable($matches[1], $matches[2], "Process")
           }
       }
   }
   
   # Восстановить из бэкапа
   node scripts\restore-supabase.js $BACKUP_FILE.FullName
   ```
   
   **Windows (CMD):**
   ```batch
   REM Загрузить переменные окружения тестового проекта
   for /f "usebackq tokens=1,* delims==" %%a in (".env.backup.test") do set %%a=%%b
   
   REM Восстановить из бэкапа (замените на актуальное имя)
   node scripts\restore-supabase.js .\backups\supabase_backup_YYYYMMDD_HHMMSS
   ```
   
   **Linux/Mac:**
   ```bash
   # Загрузить переменные окружения тестового проекта
   source .env.backup.test
   
   # Восстановить из бэкапа
   node scripts/restore-supabase.js $BACKUP_FILE
   ```

4. **Проверка восстановления:**
   ```sql
   -- Проверить количество записей в таблицах
   SELECT 
     (SELECT COUNT(*) FROM users) as users_count,
     (SELECT COUNT(*) FROM tracks) as tracks_count,
     (SELECT COUNT(*) FROM albums) as albums_count,
     (SELECT COUNT(*) FROM playlists) as playlists_count;
   
   -- Проверить целостность данных
   SELECT * FROM tracks WHERE album_id NOT IN (SELECT id FROM albums);
   SELECT * FROM playlist_tracks WHERE track_id NOT IN (SELECT id FROM tracks);
   ```

5. **Проверка файлов в Storage:**
   
   **Windows/Linux/Mac (Supabase CLI):**
   ```bash
   # Проверить количество файлов в buckets
   supabase storage list songs
   supabase storage list covers
   supabase storage list avatars
   ```
   
   **Windows (PowerShell) - альтернатива через API:**
   ```powershell
   # Проверить файлы через Supabase API
   $headers = @{
       "apikey" = $env:SUPABASE_SERVICE_ROLE_KEY
       "Authorization" = "Bearer $env:SUPABASE_SERVICE_ROLE_KEY"
   }
   
   $songs = Invoke-RestMethod -Uri "$env:SUPABASE_URL/storage/v1/object/list/songs" -Headers $headers
   $covers = Invoke-RestMethod -Uri "$env:SUPABASE_URL/storage/v1/object/list/covers" -Headers $headers
   $avatars = Invoke-RestMethod -Uri "$env:SUPABASE_URL/storage/v1/object/list/avatars" -Headers $headers
   
   Write-Host "Songs: $($songs.Count) files"
   Write-Host "Covers: $($covers.Count) files"
   Write-Host "Avatars: $($avatars.Count) files"
   ```

6. **Проверка работы приложения:**
   ```bash
   # Запустить приложение на учебном стенде
   # Проверить основные функции:
   # - Авторизация
   # - Просмотр треков
   # - Воспроизведение треков
   # - Создание плейлистов
   ```

7. **Документирование результатов:**
   ```bash
   # Записать результаты тестирования
   # Время восстановления
   # Количество восстановленных записей
   # Обнаруженные проблемы
   # Рекомендации по улучшению
   ```

8. **Очистка учебного стенда:**
   ```bash
   # Удалить тестовый проект Supabase
   # Или очистить локальную БД
   ```

### Ежеквартальное тестирование восстановления

#### Расписание

- **Время:** Первое число квартала, 10:00 UTC (13:00 MSK)
- **Частота:** Ежеквартально
- **Тип:** Полное тестирование с нагрузкой

#### Процедура выполнения

Аналогична ежемесячному тестированию, но дополнительно:

1. **Тестирование под нагрузкой:**
   ```bash
   # Создать нагрузку на систему
   # Проверить производительность после восстановления
   ```

2. **Тестирование различных сценариев:**
   ```bash
   # Тестирование восстановления отдельных таблиц
   # Тестирование восстановления до определённого момента времени
   # Тестирование восстановления после сбоя миграции
   ```

3. **Документирование результатов:**
   ```bash
   # Записать результаты всех тестов
   # Время восстановления для каждого сценария
   # Обнаруженные проблемы
   # Рекомендации по улучшению
   ```

---

## Хранение резервных копий

### Локальное хранилище

#### Структура директории

```
backups/
├── daily/                          # Ежедневные бэкапы
│   ├── supabase_backup_20250201_020000/
│   ├── supabase_backup_20250202_020000/
│   └── ...
├── weekly/                         # Еженедельные бэкапы
│   ├── supabase_backup_20250201_030000_weekly/
│   └── ...
├── monthly/                        # Ежемесячные бэкапы
│   ├── supabase_backup_20250201_040000_monthly/
│   └── ...
├── pre-migration/                  # Бэкапы перед миграциями
│   ├── supabase_backup_20250201_100000_pre-migration/
│   └── ...
└── pre-update/                     # Бэкапы перед обновлениями
    ├── supabase_backup_20250201_120000_pre-update/
    └── ...
```

#### Политика ротации

- **Ежедневные бэкапы:** Хранятся 30 дней, затем удаляются
- **Еженедельные бэкапы:** Хранятся 4 недели, затем удаляются
- **Ежемесячные бэкапы:** Хранятся 12 месяцев, затем удаляются
- **Pre-migration бэкапы:** Хранятся до успешного применения миграции + 7 дней
- **Pre-update бэкапы:** Хранятся до успешного обновления + 30 дней

#### Скрипт ротации

**Windows (PowerShell):**
```powershell
# C:\Scripts\imperial-tunes-backup-rotation.ps1

$projectPath = "C:\Study\imperial-tunes\react"
$backupsPath = Join-Path $projectPath "backups"

# Удалить ежедневные бэкапы старше 30 дней
$dailyPath = Join-Path $backupsPath "daily"
if (Test-Path $dailyPath) {
    Get-ChildItem $dailyPath -Directory | 
        Where-Object { $_.LastWriteTime -lt (Get-Date).AddDays(-30) } | 
        Remove-Item -Recurse -Force
    Write-Host "Cleaned daily backups older than 30 days"
}

# Удалить еженедельные бэкапы старше 28 дней
$weeklyPath = Join-Path $backupsPath "weekly"
if (Test-Path $weeklyPath) {
    Get-ChildItem $weeklyPath -Directory | 
        Where-Object { $_.LastWriteTime -lt (Get-Date).AddDays(-28) } | 
        Remove-Item -Recurse -Force
    Write-Host "Cleaned weekly backups older than 28 days"
}

# Удалить ежемесячные бэкапы старше 365 дней
$monthlyPath = Join-Path $backupsPath "monthly"
if (Test-Path $monthlyPath) {
    Get-ChildItem $monthlyPath -Directory | 
        Where-Object { $_.LastWriteTime -lt (Get-Date).AddDays(-365) } | 
        Remove-Item -Recurse -Force
    Write-Host "Cleaned monthly backups older than 365 days"
}
```

**Windows (CMD):**
```batch
@echo off
REM C:\Scripts\imperial-tunes-backup-rotation.bat
REM Требуется PowerShell для работы с датами

REM Использовать PowerShell для ротации
powershell -ExecutionPolicy Bypass -File "C:\Scripts\imperial-tunes-backup-rotation.ps1"
```

**Linux/Mac:**
```bash
#!/bin/bash
# /etc/cron.daily/imperial-tunes-backup-rotation

# Удалить ежедневные бэкапы старше 30 дней
find /path/to/project/backups/daily -type d -mtime +30 -exec rm -rf {} \;

# Удалить еженедельные бэкапы старше 28 дней
find /path/to/project/backups/weekly -type d -mtime +28 -exec rm -rf {} \;

# Удалить ежемесячные бэкапы старше 365 дней
find /path/to/project/backups/monthly -type d -mtime +365 -exec rm -rf {} \;
```

### Облачное хранилище

#### AWS S3

**Настройка:**

1. **Создать S3 bucket:**
   ```bash
   aws s3 mb s3://imperial-tunes-backups
   ```

2. **Настроить lifecycle политику:**
   ```json
   {
     "Rules": [
       {
         "Id": "DeleteOldBackups",
         "Status": "Enabled",
         "Expiration": {
           "Days": 30
         }
       },
       {
         "Id": "TransitionToGlacier",
         "Status": "Enabled",
         "Transitions": [
           {
             "Days": 7,
             "StorageClass": "GLACIER"
           }
         ]
       }
     ]
   }
   ```

3. **Загрузка бэкапов:**
   ```bash
   # Автоматически через скрипт upload-to-cloud.js
   node scripts/upload-to-cloud.js ./backups/supabase_backup_YYYYMMDD_HHMMSS.tar.gz
   ```

#### Google Drive / Dropbox (через rclone)

**Настройка:**

1. **Установить rclone:**
   ```bash
   curl https://rclone.org/install.sh | sudo bash
   ```

2. **Настроить remote:**
   ```bash
   rclone config
   ```

3. **Загрузка бэкапов:**
   ```bash
   # Автоматически через скрипт upload-to-cloud.js
   RCLONE_REMOTE=gdrive node scripts/upload-to-cloud.js ./backups/supabase_backup_YYYYMMDD_HHMMSS.tar.gz
   ```

### Правило 3-2-1

Соблюдается правило 3-2-1 для резервного копирования:

- **3 копии данных:** Оригинал + 2 бэкапа
- **2 разных типа носителей:** Локальный диск + облачное хранилище
- **1 копия в удалённом хранилище:** Облачное хранилище (AWS S3, Google Drive)

---

## Мониторинг и контроль

### Мониторинг создания бэкапов

#### Метрики

1. **Успешность создания бэкапов:**
   - Количество успешных бэкапов за период
   - Количество неуспешных бэкапов за период
   - Процент успешных бэкапов

2. **Время создания бэкапов:**
   - Среднее время создания бэкапа
   - Максимальное время создания бэкапа
   - Минимальное время создания бэкапа

3. **Размер бэкапов:**
   - Средний размер бэкапа
   - Максимальный размер бэкапа
   - Тренд изменения размера бэкапов

4. **Использование хранилища:**
   - Общий размер всех бэкапов
   - Свободное место на диске
   - Использование облачного хранилища

#### Алерты

1. **Неуспешное создание бэкапа:**
   ```bash
   # Отправить email/SMS администратору
   mail -s "ImperialTunes Backup Failed" admin@example.com <<< "Backup failed. Check logs."
   ```

2. **Превышение времени создания бэкапа:**
   ```bash
   # Если бэкап создаётся дольше 1 часа
   mail -s "ImperialTunes Backup Slow" admin@example.com <<< "Backup is taking too long."
   ```

3. **Превышение размера бэкапа:**
   ```bash
   # Если размер бэкапа превышает 1 GB
   mail -s "ImperialTunes Backup Large" admin@example.com <<< "Backup size is unusually large."
   ```

4. **Недостаточно места на диске:**
   ```bash
   # Если свободное место меньше 10 GB
   mail -s "ImperialTunes Backup Disk Space" admin@example.com <<< "Low disk space for backups."
   ```

### Контроль целостности бэкапов

#### Проверка структуры

**Windows (PowerShell):**
```powershell
# Проверить наличие всех необходимых файлов
Get-ChildItem backups\supabase_backup_YYYYMMDD_HHMMSS\ -Recurse | Format-Table Name, Length, LastWriteTime
Get-ChildItem backups\supabase_backup_YYYYMMDD_HHMMSS\database\
Get-ChildItem backups\supabase_backup_YYYYMMDD_HHMMSS\storage\
```

**Windows (CMD):**
```batch
REM Проверить наличие всех необходимых файлов
dir backups\supabase_backup_YYYYMMDD_HHMMSS\ /s
dir backups\supabase_backup_YYYYMMDD_HHMMSS\database\
dir backups\supabase_backup_YYYYMMDD_HHMMSS\storage\
```

**Linux/Mac:**
```bash
# Проверить наличие всех необходимых файлов
ls -la backups/supabase_backup_YYYYMMDD_HHMMSS/
ls -la backups/supabase_backup_YYYYMMDD_HHMMSS/database/
ls -la backups/supabase_backup_YYYYMMDD_HHMMSS/storage/
```

#### Проверка размера

**Windows (PowerShell):**
```powershell
# Проверить размер бэкапа
$size = (Get-ChildItem backups\supabase_backup_YYYYMMDD_HHMMSS\ -Recurse | 
    Measure-Object -Property Length -Sum).Sum / 1MB
Write-Host "Backup size: $([math]::Round($size, 2)) MB"
```

**Windows (CMD):**
```batch
REM Проверить размер бэкапа (используя PowerShell)
powershell -Command "$size = (Get-ChildItem backups\supabase_backup_YYYYMMDD_HHMMSS\ -Recurse | Measure-Object -Property Length -Sum).Sum / 1MB; Write-Host \"Backup size: $([math]::Round($size, 2)) MB\""
```

**Linux/Mac:**
```bash
# Проверить размер бэкапа
du -sh backups/supabase_backup_YYYYMMDD_HHMMSS/
```

#### Проверка содержимого SQL дампа

**Windows (PowerShell):**
```powershell
# Проверить наличие CREATE TABLE
$createTableCount = (Select-String -Path "backups\supabase_backup_YYYYMMDD_HHMMSS\database\*.sql" -Pattern "CREATE TABLE").Count
Write-Host "Found $createTableCount CREATE TABLE statements"

# Проверить наличие основных таблиц
Select-String -Path "backups\supabase_backup_YYYYMMDD_HHMMSS\database\*.sql" -Pattern "CREATE TABLE.*(users|tracks|albums|playlists)"
```

**Windows (CMD) - требует установки grep:**
```batch
REM Проверить наличие CREATE TABLE (через Git Bash или WSL)
REM grep -c "CREATE TABLE" backups\supabase_backup_YYYYMMDD_HHMMSS\database\*.sql
```

**Linux/Mac:**
```bash
# Проверить наличие CREATE TABLE
grep -c "CREATE TABLE" backups/supabase_backup_YYYYMMDD_HHMMSS/database/*.sql

# Проверить наличие основных таблиц
grep -E "CREATE TABLE.*(users|tracks|albums|playlists)" \
  backups/supabase_backup_YYYYMMDD_HHMMSS/database/*.sql
```

#### Проверка содержимого JSON дампа

**Windows (PowerShell):**
```powershell
# Проверить структуру JSON (требуется установленный jq или встроенный ConvertFrom-Json)
$json = Get-Content backups\supabase_backup_YYYYMMDD_HHMMSS\database\*.json -Raw | ConvertFrom-Json
$json.tables.PSObject.Properties.Name
```

**Linux/Mac:**
```bash
# Проверить структуру JSON
cat backups/supabase_backup_YYYYMMDD_HHMMSS/database/*.json | jq '.tables | keys'
```

---

## План действий при инцидентах

### Инцидент 1: Потеря данных

#### Симптомы

- Отсутствие данных в таблицах
- Ошибки при запросах к БД
- Сообщения об отсутствии записей

#### Действия

1. **Остановить приложение:**
   ```bash
   # Остановить все сервисы
   docker-compose down
   ```

2. **Оценить масштаб потери:**
   ```sql
   -- Проверить количество записей в таблицах
   SELECT 
     (SELECT COUNT(*) FROM users) as users_count,
     (SELECT COUNT(*) FROM tracks) as tracks_count,
     (SELECT COUNT(*) FROM albums) as albums_count;
   ```

3. **Выбрать бэкап для восстановления:**
   
   **Windows (PowerShell):**
   ```powershell
   # Выбрать последний успешный бэкап
   Get-ChildItem backups\ | Sort-Object LastWriteTime -Descending | Select-Object -First 10 | Format-Table Name, Length, LastWriteTime
   ```
   
   **Windows (CMD):**
   ```batch
   REM Выбрать последний успешный бэкап
   dir backups\ /O-D | more
   ```
   
   **Linux/Mac:**
   ```bash
   # Выбрать последний успешный бэкап
   ls -lt backups/ | head -10
   ```

4. **Восстановить из бэкапа:**
   ```bash
   node scripts/restore-supabase.js ./backups/supabase_backup_YYYYMMDD_HHMMSS
   ```

5. **Проверить восстановление:**
   ```sql
   -- Проверить количество записей после восстановления
   SELECT 
     (SELECT COUNT(*) FROM users) as users_count,
     (SELECT COUNT(*) FROM tracks) as tracks_count,
     (SELECT COUNT(*) FROM albums) as albums_count;
   ```

6. **Запустить приложение:**
   ```bash
   docker-compose up -d
   ```

7. **Документировать инцидент:**
   ```bash
   # Записать в журнал инцидентов
   # Причина потери данных
   # Время восстановления
   # Потерянные данные (если есть)
   ```

### Инцидент 2: Сбой при создании бэкапа

#### Симптомы

- Ошибка при выполнении скрипта бэкапа
- Отсутствие файлов бэкапа
- Сообщения об ошибках в логах

#### Действия

1. **Проверить логи:**
   ```bash
   # Проверить логи скрипта бэкапа
   tail -n 100 /var/log/supabase_backup.log
   ```

2. **Проверить переменные окружения:**
   ```bash
   # Проверить наличие всех необходимых переменных
   echo $SUPABASE_URL
   echo $SUPABASE_SERVICE_ROLE_KEY
   echo $SUPABASE_DB_URL
   ```

3. **Проверить доступность Supabase:**
   ```bash
   # Проверить доступность Supabase API
   curl -I https://[project-ref].supabase.co/rest/v1/
   ```

4. **Повторить создание бэкапа:**
   ```bash
   # Попробовать создать бэкап снова
   node scripts/backup-supabase.js
   ```

5. **Если не удалось, использовать альтернативный метод:**
   ```bash
   # Использовать Supabase Dashboard для создания бэкапа
   # Или использовать Supabase CLI
   supabase db dump > backup_manual.sql
   ```

6. **Документировать проблему:**
   ```bash
   # Записать в журнал проблем
   # Причина сбоя
   # Решение проблемы
   # Рекомендации по предотвращению
   ```

### Инцидент 3: Недостаточно места на диске

#### Симптомы

- Ошибка при создании бэкапа
- Сообщения о нехватке места
- Невозможность записи файлов

#### Действия

1. **Проверить свободное место:**
   ```bash
   # Проверить использование диска
   df -h
   ```

2. **Очистить старые бэкапы:**
   
   **Windows (PowerShell):**
   ```powershell
   # Удалить бэкапы старше 30 дней
   Get-ChildItem backups\ -Directory | 
       Where-Object { $_.LastWriteTime -lt (Get-Date).AddDays(-30) } | 
       Remove-Item -Recurse -Force
   ```
   
   **Windows (CMD):**
   ```batch
   REM Удалить бэкапы старше 30 дней (используя PowerShell)
   powershell -Command "Get-ChildItem backups\ -Directory | Where-Object { $_.LastWriteTime -lt (Get-Date).AddDays(-30) } | Remove-Item -Recurse -Force"
   ```
   
   **Linux/Mac:**
   ```bash
   # Удалить бэкапы старше 30 дней
   find backups/ -type d -mtime +30 -exec rm -rf {} \;
   ```

3. **Загрузить бэкапы в облачное хранилище:**
   ```bash
   # Загрузить старые бэкапы в облако
   node scripts/upload-to-cloud.js ./backups/supabase_backup_YYYYMMDD_HHMMSS.tar.gz
   ```

4. **Увеличить размер диска (если возможно):**
   ```bash
   # Увеличить размер диска через облачный провайдер
   # Или добавить дополнительный диск
   ```

5. **Документировать проблему:**
   ```bash
   # Записать в журнал проблем
   # Причина нехватки места
   # Решение проблемы
   # Рекомендации по предотвращению
   ```

---

## Демонстрация восстановления на учебном стенде

### Подготовка учебного стенда

#### Вариант 1: Локальный PostgreSQL

1. **Установить PostgreSQL:**
   
   **Windows:**
   - Скачать установщик с https://www.postgresql.org/download/windows/
   - Запустить установщик и следовать инструкциям
   - Запомнить пароль пользователя postgres
   - Убедиться, что PostgreSQL добавлен в PATH
   
   **Linux (Ubuntu/Debian):**
   ```bash
   sudo apt-get install postgresql postgresql-contrib
   ```
   
   **macOS:**
   ```bash
   brew install postgresql
   ```

2. **Создать базу данных:**
   
   **Windows (CMD):**
   ```batch
   REM Создать базу данных
   REM Убедитесь, что PostgreSQL добавлен в PATH
   createdb -h localhost -U postgres imperial_tunes_test
   
   REM Или через psql
   psql -h localhost -U postgres -c "CREATE DATABASE imperial_tunes_test;"
   ```
   
   **Windows (PowerShell):**
   ```powershell
   # Создать базу данных
   & createdb -h localhost -U postgres imperial_tunes_test
   
   # Или через psql
   & psql -h localhost -U postgres -c "CREATE DATABASE imperial_tunes_test;"
   ```
   
   **Linux/Mac:**
   ```bash
   # Создать базу данных
   createdb -h localhost -U postgres imperial_tunes_test
   ```

3. **Настроить переменные окружения:**
   
   **Windows (PowerShell):**
   ```powershell
   # Создать файл .env.backup.test
   @"
   SUPABASE_URL=http://localhost:5432
   SUPABASE_SERVICE_ROLE_KEY=test_key
   SUPABASE_DB_URL=postgresql://postgres:postgres@localhost:5432/imperial_tunes_test
   "@ | Out-File -FilePath ".env.backup.test" -Encoding UTF8
   ```
   
   **Windows (CMD):**
   ```batch
   REM Создать файл .env.backup.test
   (
   echo SUPABASE_URL=http://localhost:5432
   echo SUPABASE_SERVICE_ROLE_KEY=test_key
   echo SUPABASE_DB_URL=postgresql://postgres:postgres@localhost:5432/imperial_tunes_test
   ) > .env.backup.test
   ```
   
   **Linux/Mac:**
   ```bash
   # Создать файл .env.backup.test
   cat > .env.backup.test << EOF
   SUPABASE_URL=http://localhost:5432
   SUPABASE_SERVICE_ROLE_KEY=test_key
   SUPABASE_DB_URL=postgresql://postgres:postgres@localhost:5432/imperial_tunes_test
   EOF
   ```

#### Вариант 2: Тестовый проект Supabase

1. **Создать тестовый проект Supabase:**
   ```bash
   # Перейти на https://supabase.com/dashboard
   # Создать новый проект
   # Скопировать URL и ключи
   ```

2. **Настроить переменные окружения:**
   
   **Windows (PowerShell):**
   ```powershell
   # Создать файл .env.backup.test
   @"
   SUPABASE_URL=https://[test-project-ref].supabase.co
   SUPABASE_SERVICE_ROLE_KEY=[test-service-role-key]
   SUPABASE_DB_URL=postgresql://postgres:[password]@db.[test-project-ref].supabase.co:5432/postgres
   "@ | Out-File -FilePath ".env.backup.test" -Encoding UTF8
   ```
   
   **Windows (CMD):**
   ```batch
   REM Создать файл .env.backup.test
   (
   echo SUPABASE_URL=https://[test-project-ref].supabase.co
   echo SUPABASE_SERVICE_ROLE_KEY=[test-service-role-key]
   echo SUPABASE_DB_URL=postgresql://postgres:[password]@db.[test-project-ref].supabase.co:5432/postgres
   ) > .env.backup.test
   ```
   
   **Linux/Mac:**
   ```bash
   # Создать файл .env.backup.test
   cat > .env.backup.test << EOF
   SUPABASE_URL=https://[test-project-ref].supabase.co
   SUPABASE_SERVICE_ROLE_KEY=[test-service-role-key]
   SUPABASE_DB_URL=postgresql://postgres:[password]@db.[test-project-ref].supabase.co:5432/postgres
   EOF
   ```

### Процедура демонстрации

#### Шаг 1: Создание тестовых данных

```bash
# Запустить приложение на учебном стенде
# Создать тестовых пользователей
# Загрузить тестовые треки
# Создать тестовые плейлисты
```

#### Шаг 2: Создание бэкапа

**Windows (PowerShell):**
```powershell
# Загрузить переменные окружения
if (Test-Path ".env.backup.test") {
    Get-Content ".env.backup.test" | ForEach-Object {
        if ($_ -match '^([^#][^=]+)=(.*)$') {
            [Environment]::SetEnvironmentVariable($matches[1], $matches[2], "Process")
        }
    }
}

# Создать бэкап
node scripts\backup-supabase.js

# Проверить создание бэкапа
Get-ChildItem backups\supabase_backup_*\ -Recurse | Format-Table Name, Length, LastWriteTime
```

**Windows (CMD):**
```batch
REM Загрузить переменные окружения
for /f "usebackq tokens=1,* delims==" %%a in (".env.backup.test") do set %%a=%%b

REM Создать бэкап
node scripts\backup-supabase.js

REM Проверить создание бэкапа
dir backups\supabase_backup_*\ /s
```

**Linux/Mac:**
```bash
# Загрузить переменные окружения
source .env.backup.test

# Создать бэкап
node scripts/backup-supabase.js

# Проверить создание бэкапа
ls -la backups/supabase_backup_*/
```

#### Шаг 3: Симуляция потери данных

```sql
-- Удалить тестовые данные
DELETE FROM tracks WHERE id IN (SELECT id FROM tracks LIMIT 10);
DELETE FROM playlists WHERE id IN (SELECT id FROM playlists LIMIT 5);
```

#### Шаг 4: Восстановление из бэкапа

**Windows (PowerShell):**
```powershell
# Выбрать последний бэкап
$BACKUP_DIR = Get-ChildItem backups\supabase_backup_* -Directory | 
    Sort-Object LastWriteTime -Descending | 
    Select-Object -First 1

Write-Host "Selected backup: $($BACKUP_DIR.FullName)"

# Восстановить из бэкапа
node scripts\restore-supabase.js $BACKUP_DIR.FullName
```

**Windows (CMD):**
```batch
REM Выбрать последний бэкап (вручную указать имя)
REM Или использовать PowerShell команду выше
REM Восстановить из бэкапа (замените на актуальное имя)
node scripts\restore-supabase.js .\backups\supabase_backup_YYYYMMDD_HHMMSS
```

**Linux/Mac:**
```bash
# Выбрать последний бэкап
BACKUP_DIR=$(ls -td backups/supabase_backup_* | head -1)

# Восстановить из бэкапа
node scripts/restore-supabase.js $BACKUP_DIR
```

#### Шаг 5: Проверка восстановления

```sql
-- Проверить количество записей после восстановления
SELECT 
  (SELECT COUNT(*) FROM tracks) as tracks_count,
  (SELECT COUNT(*) FROM playlists) as playlists_count;

-- Проверить целостность данных
SELECT * FROM tracks WHERE album_id NOT IN (SELECT id FROM albums);
```

#### Шаг 6: Документирование результатов

**Windows (PowerShell):**
```powershell
# Записать результаты демонстрации
@"
Дата демонстрации: $(Get-Date -Format "yyyy-MM-dd HH:mm:ss")
Время создания бэкапа: [время]
Время восстановления: [время]
Количество восстановленных записей: [количество]
Целостность данных: [проверено/не проверено]
Проблемы: [если есть]
Рекомендации: [если есть]
"@ | Out-File -FilePath "demonstration_results.txt" -Encoding UTF8
```

**Windows (CMD):**
```batch
REM Записать результаты демонстрации
(
echo Дата демонстрации: %date% %time%
echo Время создания бэкапа: [время]
echo Время восстановления: [время]
echo Количество восстановленных записей: [количество]
echo Целостность данных: [проверено/не проверено]
echo Проблемы: [если есть]
echo Рекомендации: [если есть]
) > demonstration_results.txt
```

**Linux/Mac:**
```bash
# Записать результаты демонстрации
cat > demonstration_results.txt << EOF
Дата демонстрации: $(date)
Время создания бэкапа: [время]
Время восстановления: [время]
Количество восстановленных записей: [количество]
Целостность данных: [проверено/не проверено]
Проблемы: [если есть]
Рекомендации: [если есть]
EOF
```

### Чеклист демонстрации

- [ ] Учебный стенд подготовлен
- [ ] Тестовые данные созданы
- [ ] Бэкап создан успешно
- [ ] Данные удалены (симуляция потери)
- [ ] Восстановление выполнено успешно
- [ ] Целостность данных проверена
- [ ] Результаты документированы
- [ ] Учебный стенд очищен

---

## Приложения

### Приложение 1: Скрипты резервного копирования

#### backup-supabase.js

Основной скрипт для создания резервных копий.

**Расположение:** `scripts/backup-supabase.js`

**Использование:**
```bash
node scripts/backup-supabase.js
```

**Требуемые переменные окружения:**
- `SUPABASE_URL` - URL проекта Supabase
- `SUPABASE_SERVICE_ROLE_KEY` - Service Role Key
- `SUPABASE_DB_URL` - Connection string для PostgreSQL (опционально)

#### restore-supabase.js

Скрипт для восстановления из резервных копий.

**Расположение:** `scripts/restore-supabase.js`

**Использование:**
```bash
node scripts/restore-supabase.js ./backups/supabase_backup_YYYYMMDD_HHMMSS
```

**Требуемые переменные окружения:**
- `SUPABASE_URL` - URL проекта Supabase
- `SUPABASE_SERVICE_ROLE_KEY` - Service Role Key
- `SUPABASE_DB_URL` - Connection string для PostgreSQL (опционально)

### Приложение 2: Формат метаданных бэкапа

#### backup_info.txt

Файл с метаданными о бэкапе.

**Формат:**
```
ImperialTunes Supabase Backup Information
==========================================
Дата создания: [дата]
Время создания: [время]
Supabase URL: [url]
Расположение: [путь]

БАЗА ДАННЫХ:
  Размер: [размер] MB
  Файлы: [список файлов]

STORAGE:
  Общий размер: [размер] MB
  Songs (аудио): [количество] файлов
  Covers (обложки): [количество] файлов
  Avatars (аватары): [количество] файлов

ОБЩИЙ РАЗМЕР: [размер] MB
==========================================
```

### Приложение 3: Журнал операций бэкапа

#### backup_log.csv

Файл с журналом всех операций бэкапа.

**Формат:**
```csv
Дата,Время,Операция,Файл,Размер,MD5,Статус,Примечания
2025-02-01,02:00,Создание,supabase_backup_20250201_020000.tar.gz,50.5 MB,abc123...,Успешно,Автоматический бэкап
2025-02-02,02:00,Создание,supabase_backup_20250202_020000.tar.gz,51.2 MB,def456...,Успешно,Автоматический бэкап
2025-02-03,02:00,Создание,supabase_backup_20250203_020000.tar.gz,52.1 MB,ghi789...,Успешно,Автоматический бэкап
```
---

