# Руководство по тестированию API

## Обзор

Проект использует **Vitest** для unit-тестирования API запросов. Все тесты находятся в директории `src/services/api/__tests__/`.

## Структура тестов

```
src/
├── services/
│   └── api/
│       ├── __tests__/
│       │   ├── tracks.test.ts      # Тесты для API треков
│       │   ├── albums.test.ts      # Тесты для API альбомов
│       │   ├── artists.test.ts     # Тесты для API артистов
│       │   ├── playlists.test.ts   # Тесты для API плейлистов
│       │   └── analytics.test.ts   # Тесты для API аналитики
│       ├── tracks.ts
│       ├── albums.ts
│       ├── artists.ts
│       ├── playlists.ts
│       └── analytics.ts
└── test/
    ├── setup.ts                    # Настройка тестового окружения
    └── mocks/
        └── supabase.ts             # Моки для Supabase клиента
```

## Запуск тестов

### Локально

```bash
# Запустить все тесты один раз
npm test

# Запустить тесты в режиме watch
npm run test:watch

# Запустить тесты с покрытием кода
npm run test:coverage
```

### В CI/CD

Тесты автоматически запускаются при:
- Push в ветки `main`, `develop`, `master`
- Создании Pull Request в эти ветки

## Покрытие тестами

Текущие тесты покрывают:

### ✅ Tracks API
- Получение всех треков (с фильтрами и без)
- Получение трека по ID
- Создание нового трека
- Обновление трека
- Удаление трека
- Увеличение счетчика прослушиваний

### ✅ Albums API
- Получение всех альбомов (с фильтрами и без)
- Получение альбома по ID
- Создание нового альбома
- Обновление альбома
- Удаление альбома

### ✅ Artists API
- Получение всех артистов (с фильтрами и без)
- Получение артиста по ID
- Создание нового артиста
- Обновление артиста
- Удаление артиста

### ✅ Playlists API
- Получение всех плейлистов пользователя
- Получение плейлиста по ID
- Создание нового плейлиста
- Добавление трека в плейлист
- Удаление трека из плейлиста

### ✅ Analytics API
- Получение статистики прослушиваний (с фильтрами)
- Получение топ треков
- Получение статистики по жанрам
- Получение ежедневной статистики

## Моки

Все тесты используют моки Supabase клиента, что позволяет:
- Тестировать логику без реального подключения к БД
- Быстрое выполнение тестов
- Предсказуемые результаты

Моки находятся в `src/test/mocks/supabase.ts`.

## Добавление новых тестов

### Пример теста для нового API метода

```typescript
import { describe, it, expect, vi, beforeEach } from 'vitest';
import * as myAPI from '../my-api';
import { supabase } from '@/integrations/supabase/client';

vi.mock('@/integrations/supabase/client', () => ({
  supabase: {
    from: vi.fn(),
  },
}));

describe('My API', () => {
  beforeEach(() => {
    vi.clearAllMocks();
  });

  describe('myMethod', () => {
    it('должен выполнить действие', async () => {
      const mockQuery = {
        select: vi.fn().mockReturnThis(),
        eq: vi.fn().mockResolvedValue({ data: [], error: null }),
      };

      vi.mocked(supabase.from).mockReturnValue(mockQuery as any);

      await myAPI.myMethod();

      expect(supabase.from).toHaveBeenCalledWith('my_table');
    });
  });
});
```

## Безопасность тестов

### ✅ Гарантии безопасности

**Все unit-тесты полностью изолированы от реальной базы данных и не могут повлиять на производственные данные.**

- Все тесты используют моки Supabase клиента (`vi.mock()`)
- Реальный `createClient()` **НИКОГДА** не вызывается
- Никакие HTTP запросы к Supabase API **НЕ отправляются**
- Реальная база данных **НЕ используется**

**Даже в CI/CD:**
- Переменные окружения используются только для информации
- Реальные запросы к БД невозможны благодаря мокам
- Производственные данные полностью защищены

Подробнее см. [src/test/README_SAFETY.md](src/test/README_SAFETY.md)

## Переменные окружения

Для тестов используются следующие переменные окружения (опционально):
- `VITE_SUPABASE_URL` - URL Supabase проекта
- `VITE_SUPABASE_ANON_KEY` - Публичный ключ Supabase

**Важно:** В тестах эти переменные не используются напрямую, так как все запросы мокируются. Даже если они установлены в CI, реальные запросы к БД невозможны.

## CI/CD интеграция

Тесты запускаются автоматически в GitHub Actions при каждом push. Результаты тестов и покрытие кода отображаются в:
- Вкладке "Actions" в GitHub
- Комментариях к Pull Request

## Полезные команды

```bash
# Запустить только тесты для треков
npm test -- tracks

# Запустить тесты с подробным выводом
npm test -- --reporter=verbose

# Запустить тесты и открыть UI
npm test -- --ui
```

## Troubleshooting

### Тесты не запускаются
- Убедитесь, что установлены все зависимости: `npm ci`
- Проверьте, что Node.js версии 18 или выше

### Ошибки импорта
- Убедитесь, что пути импорта используют алиас `@/`
- Проверьте, что файлы существуют в правильных директориях

### Моки не работают
- Убедитесь, что `vi.mock()` вызывается до импорта модуля
- Проверьте, что моки правильно настроены в `src/test/mocks/supabase.ts`

