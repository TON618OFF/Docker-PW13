# БЭКАПЫ И ПРОЦЕДУРЫ ВОССТАНОВЛЕНИЯ
## Проект: Imperial Tunes (SoundWeave DB)

**Версия документа:** 1.0  
**Дата создания:** 2025-01-30  
**База данных:** PostgreSQL (Supabase)

---

## ОГЛАВЛЕНИЕ

1. [Общая информация](#общая-информация)
2. [Типы бэкапов](#типы-бэкапов)
3. [Процедура создания бэкапов](#процедура-создания-бэкапов)
4. [Процедура восстановления](#процедура-восстановления)
5. [Автоматизация бэкапов](#автоматизация-бэкапов)
6. [Хранение и ротация бэкапов](#хранение-и-ротация-бэкапов)
7. [Бэкапы Supabase (Cloud)](#бэкапы-supabase-cloud)
8. [Восстановление в различных сценариях](#восстановление-в-различных-сценариях)
9. [Проверка целостности бэкапов](#проверка-целостности-бэкапов)

---

## ОБЩАЯ ИНФОРМАЦИЯ

Проект Imperial Tunes использует многоуровневую систему резервного копирования для защиты данных:

- **База данных** - SQL дампы через `pg_dump`
- **Storage файлы** - копирование файлов из Supabase Storage buckets
- **Миграции** - версионирование схемы БД в Git
- **Конфигурация** - сохранение настроек окружения

**Платформы:**
- **Локальная разработка** - PostgreSQL через Docker
- **Production (Supabase)** - встроенные механизмы бэкапов Supabase + ручные дампы

---

## ТИПЫ БЭКАПОВ

### Таблица 1: Типы данных для бэкапирования

| № | Тип данных | Метод бэкапа | Частота | Хранение | Критичность |
|---|------------|--------------|---------|----------|-------------|
| 1 | База данных (схема + данные) | pg_dump | Ежедневно | Локально + облако | Критический |
| 2 | Storage: аудио файлы (songs) | Копирование bucket | Еженедельно | Облачное хранилище | Критический |
| 3 | Storage: изображения (covers, avatars) | Копирование bucket | Еженедельно | Облачное хранилище | Высокий |
| 4 | Миграции БД | Git репозиторий | При каждом изменении | Git (GitHub/GitLab) | Высокий |
| 5 | Конфигурация окружения | Файлы .env | При изменении | Зашифрованное хранилище | Средний |
| 6 | Код приложения | Git репозиторий | При каждом коммите | Git (GitHub/GitLab) | Средний |

---

## ПРОЦЕДУРА СОЗДАНИЯ БЭКАПОВ

### 1. Бэкап базы данных Supabase

#### 1.1. Ручной бэкап через скрипт

**Скрипт:** `scripts/backup-supabase.js` (основной), `scripts/backup-supabase-windows.bat` (Windows)

**Описание:**
Скрипт создаёт полный бэкап Supabase проекта, включая базу данных (SQL дамп или JSON через API) и все файлы из Storage buckets (songs, covers, avatars).

**Использование:**

**Windows:**
```batch
# Двойной клик или запуск из командной строки
scripts\backup-supabase-windows.bat
```

**Linux/Mac:**
```bash
# Загрузить переменные окружения
source .env.backup

# Создать бэкап
node scripts/backup-supabase.js

# Или через полный скрипт (с загрузкой в облако)
bash scripts/full-backup-supabase.sh
```

**Процесс выполнения:**

1. **Проверка переменных окружения**
   - Проверка наличия `SUPABASE_URL` и `SUPABASE_SERVICE_ROLE_KEY`
   - Проверка наличия `SUPABASE_DB_URL` (опционально, для прямого доступа к БД)

2. **Создание бэкапа базы данных**
   
   **Метод 1 (если установлен SUPABASE_DB_URL):**
   - Использование `pg_dump` для создания полного SQL дампа
   - Включает схему и данные
   - Автоматическое сжатие (gzip) на Linux/Mac

   **Метод 2 (через Supabase API):**
   - Экспорт всех таблиц в JSON через Supabase API
   - Экспортирует только данные (схема не включается)
   - Используется автоматически, если `pg_dump` недоступен

3. **Скачивание файлов из Storage**
   - Рекурсивное скачивание всех файлов из bucket `songs`
   - Скачивание файлов из bucket `covers`
   - Скачивание файлов из bucket `avatars`
   - Fallback на публичные URL при ошибках доступа

4. **Создание информации о бэкапе**
   - Создание файла `backup_info.txt` с метаданными
   - Создание JSON файла с детальной информацией
   - Подсчёт размеров и количества файлов

5. **Создание архива (опционально)**
   - Создание tar.gz архива всего бэкапа
   - Автоматически на Linux/Mac
   - Пропускается на Windows (gzip может быть недоступен)

**Параметры pg_dump (если используется):**
- `--format=plain` - текстовый формат SQL
- `--no-owner` - не включать команды SET OWNER
- `--no-privileges` - не включать команды GRANT/REVOKE
- `--clean` - добавить команды DROP перед CREATE
- `--if-exists` - использовать IF EXISTS в командах DROP

**Результат:**
- Директория: `backups/supabase_backup_YYYYMMDD_HHMMSS/`
- БД: `database/database_backup_YYYYMMDD_HHMMSS.sql` (или `.json`)
- Storage: `storage/songs/`, `storage/covers/`, `storage/avatars/`
- Информация: `backup_info.txt` и `backup_info.json`
- Архив (опционально): `supabase_backup_YYYYMMDD_HHMMSS.tar.gz`

#### 1.2. Структура бэкапа

**Что включается в бэкап:**
- Все таблицы схемы `public`
- Все данные таблиц
- Все функции (SECURITY DEFINER)
- Все триггеры
- Все индексы
- Все представления (views)
- Все типы данных (ENUM)
- Все RLS политики
- Все внешние ключи и ограничения

**Что не включается:**
- Таблица `auth.users` (Supabase Auth, управляется отдельно)
- Временные таблицы
- Информация о владельцах объектов (из-за `--no-owner`)
- Права доступа (из-за `--no-privileges`)

#### 1.3. Пример вывода скрипта

```
[INFO] Начало создания полного бэкапа Supabase проекта...
[INFO] Дата: 05.11.2025, 22:39:01
[INFO] Директория: backups\supabase_backup_2025-11-05_223901

[INFO] Создание бэкапа базы данных...
[INFO] Используется pg_dump для: postgresql://postgres:****@db.xxxxx.supabase.co:5432/postgres
[OK] Дамп БД создан: 0.15 MB

[INFO] Создание бэкапа Storage...
[INFO] Скачивание файлов из bucket: songs...
   [OK] Скачан: 4fc7f570-82b1-4fcc-bed2-5089f58fb8d6/1762280386375.mp3 (2048.32 KB)
   [OK] Скачано 1 файлов из songs (2.00 MB)

[INFO] Скачивание файлов из bucket: covers...
   [OK] Скачан: 825164a1-a400-4ff3-b0fb-89367c12fd7e/1762280539164.png (156.25 KB)
   [OK] Скачано 1 файлов из covers (0.15 MB)

[INFO] Скачивание файлов из bucket: avatars...
   [OK] Скачано 0 файлов из avatars (0.00 MB)

[OK] Бэкап завершен успешно!
[INFO] Расположение: backups\supabase_backup_2025-11-05_223901
[INFO] Архив: backups\supabase_backup_2025-11-05_223901.tar.gz
[INFO] Общий размер: 2.30 MB
```

### 2. Бэкап Storage файлов (Supabase Storage)

#### 2.1. Ручной бэкап через Supabase CLI

**Метод 1: Через Supabase Dashboard**

1. Перейти в раздел **Storage** в Supabase Dashboard
2. Выбрать bucket (`songs`, `covers`, `avatars`)
3. Экспортировать файлы через веб-интерфейс

**Метод 2: Через Supabase CLI**

```bash
# Установка Supabase CLI (если не установлен)
npm install -g supabase

# Авторизация
supabase login

# Скачивание файлов из bucket
supabase storage download songs ./backups/storage/songs
supabase storage download covers ./backups/storage/covers
supabase storage download avatars ./backups/storage/avatars
```

**Метод 3: Через API (программно)**

```typescript
// Пример скрипта для бэкапа Storage
import { createClient } from '@supabase/supabase-js';
import * as fs from 'fs';
import * as path from 'path';

const supabase = createClient(
  process.env.SUPABASE_URL!,
  process.env.SUPABASE_SERVICE_ROLE_KEY! // Требуется service_role ключ
);

async function backupStorageBucket(bucketName: string, outputDir: string) {
  const { data: files, error } = await supabase.storage
    .from(bucketName)
    .list('', {
      limit: 1000,
      offset: 0,
    });

  if (error) throw error;

  for (const file of files) {
    const { data: fileData, error: downloadError } = await supabase.storage
      .from(bucketName)
      .download(file.name);

    if (downloadError) {
      console.error(`Ошибка загрузки ${file.name}:`, downloadError);
      continue;
    }

    const filePath = path.join(outputDir, file.name);
    const dir = path.dirname(filePath);
    fs.mkdirSync(dir, { recursive: true });

    const arrayBuffer = await fileData.arrayBuffer();
    fs.writeFileSync(filePath, Buffer.from(arrayBuffer));
  }
}

// Использование
await backupStorageBucket('songs', './backups/storage/songs');
await backupStorageBucket('covers', './backups/storage/covers');
await backupStorageBucket('avatars', './backups/storage/avatars');
```

#### 2.2. Структура бэкапа Storage

**Bucket: songs**
- Путь: `backups/storage/songs/{user_id}/{timestamp}.{ext}`
- Форматы: mp3, wav, flac, ogg, m4a
- Максимальный размер: 50 MB на файл

**Bucket: covers**
- Путь: `backups/storage/covers/{user_id}/{timestamp}.{ext}`
- Форматы: jpeg, png, webp
- Максимальный размер: 5 MB на файл

**Bucket: avatars**
- Путь: `backups/storage/avatars/{user_id}/{timestamp}.{ext}`
- Форматы: jpeg, jpg, png, webp
- Максимальный размер: 5 MB на файл

### 3. Бэкап миграций

**Метод:** Git репозиторий

**Описание:**
Все миграции БД хранятся в директории `supabase/migrations/` и версионируются через Git.

**Структура:**
```
supabase/migrations/
├── 20250128000000_imperial_tunes_schema.sql
├── 20250129000001_complete_schema.sql
├── 20250201000000_complete_database_schema.sql
└── ...
```

**Процедура:**
1. Все изменения схемы БД создаются как новые миграции
2. Миграции коммитятся в Git
3. При необходимости восстановления схемы применяются все миграции по порядку

**Восстановление схемы из миграций:**
```bash
# Применение всех миграций
supabase db reset

# Или вручную через psql
psql -h localhost -U postgres -d imperial_tunes -f supabase/migrations/20250201000000_complete_database_schema.sql
```

### 4. Бэкап конфигурации

**Файлы для бэкапа:**
- `.env.local` - переменные окружения (НЕ коммитится в Git)
- `nginx.conf` - конфигурация Nginx
- `docker-compose.yml` - конфигурация Docker
- `vite.config.ts` - конфигурация Vite
- `tailwind.config.ts` - конфигурация Tailwind CSS

**Процедура:**
```bash
# Создание архива конфигурации
tar -czf backups/config/config_$(date +%Y%m%d_%H%M%S).tar.gz \
  .env.local \
  nginx.conf \
  docker-compose.yml \
  vite.config.ts \
  tailwind.config.ts
```

**Важно:**
- `.env.local` содержит секретные данные и должен храниться в зашифрованном виде
- Используйте `env.example` как шаблон (без секретов)

---

## ПРОЦЕДУРА ВОССТАНОВЛЕНИЯ

### 1. Восстановление базы данных Supabase

#### 1.1. Восстановление через скрипт

**Скрипт:** `scripts/restore-supabase.js`

**Использование:**
```bash
# Загрузить переменные окружения
source .env.backup

# Восстановление из бэкапа (указать директорию бэкапа)
node scripts/restore-supabase.js ./backups/supabase_backup_2025-11-05_223901
```

**Требования:**
- Установлены переменные окружения: `SUPABASE_URL`, `SUPABASE_SERVICE_ROLE_KEY`
- Наличие директории бэкапа с файлами базы данных и Storage

**Процесс выполнения:**

1. **Проверка аргументов**
   - Проверка наличия директории бэкапа
   - Проверка наличия файлов базы данных и Storage

2. **Проверка переменных окружения**
   - Проверка `SUPABASE_URL` и `SUPABASE_SERVICE_ROLE_KEY`
   - Проверка `SUPABASE_DB_URL` (если используется SQL дамп)

3. **Подтверждение пользователя**
   - Запрос подтверждения перед восстановлением
   - Предупреждение о замене текущих данных

4. **Восстановление базы данных**
   
   **Если есть SQL дамп:**
   - Использование `psql` для восстановления из SQL файла
   - Или использование Supabase API для прямого восстановления
   
   **Если есть JSON данные:**
   - Восстановление через Supabase API
   - Загрузка данных в таблицы по порядку

5. **Восстановление Storage файлов**
   - Загрузка файлов в bucket `songs`
   - Загрузка файлов в bucket `covers`
   - Загрузка файлов в bucket `avatars`
   - Сохранение структуры директорий (user_id/path)

6. **Проверка восстановления**
   - Проверка количества записей в таблицах
   - Проверка наличия основных таблиц
   - Проверка загруженных файлов в Storage

#### 1.2. Ручное восстановление через psql

**Для сжатого файла:**
```bash
gunzip -c backups/imperial_tunes_backup_20250130_153045.sql.gz | \
  psql -h localhost -U postgres -d postgres
```

**Для несжатого файла:**
```bash
psql -h localhost -U postgres -d postgres < backups/imperial_tunes_backup_20250130_153045.sql
```

**Для восстановления в существующую БД:**
```bash
# Сначала удалить БД (если нужно)
psql -h localhost -U postgres -c "DROP DATABASE IF EXISTS imperial_tunes;"

# Затем восстановить из бэкапа с CREATE DATABASE
gunzip -c backups/imperial_tunes_backup_20250130_153045.sql.gz | \
  psql -h localhost -U postgres -d postgres
```

#### 1.3. Восстановление через миграции

**Метод:** Применение всех миграций по порядку

**Процедура:**
```bash
# 1. Создать новую БД
createdb -h localhost -U postgres imperial_tunes

# 2. Применить все миграции
for migration in supabase/migrations/*.sql; do
  echo "Applying: $migration"
  psql -h localhost -U postgres -d imperial_tunes -f "$migration"
done
```

**Или через Supabase CLI:**
```bash
supabase db reset
```

### 2. Восстановление Storage файлов

#### 2.1. Восстановление через Supabase CLI

```bash
# Загрузка файлов в bucket
supabase storage upload songs ./backups/storage/songs
supabase storage upload covers ./backups/storage/covers
supabase storage upload avatars ./backups/storage/avatars
```

#### 2.2. Восстановление через API

```typescript
import { createClient } from '@supabase/supabase-js';
import * as fs from 'fs';
import * as path from 'path';

const supabase = createClient(
  process.env.SUPABASE_URL!,
  process.env.SUPABASE_SERVICE_ROLE_KEY!
);

async function restoreStorageBucket(bucketName: string, backupDir: string) {
  const files = fs.readdirSync(backupDir, { recursive: true });

  for (const file of files) {
    const filePath = path.join(backupDir, file);
    if (fs.statSync(filePath).isFile()) {
      const fileBuffer = fs.readFileSync(filePath);
      
      const { error } = await supabase.storage
        .from(bucketName)
        .upload(file, fileBuffer, {
          upsert: true, // Перезаписать если существует
        });

      if (error) {
        console.error(`Ошибка загрузки ${file}:`, error);
      }
    }
  }
}

// Использование
await restoreStorageBucket('songs', './backups/storage/songs');
await restoreStorageBucket('covers', './backups/storage/covers');
await restoreStorageBucket('avatars', './backups/storage/avatars');
```

### 3. Восстановление конфигурации

**Процедура:**
```bash
# Извлечение архива конфигурации
tar -xzf backups/config/config_20250130_153045.tar.gz -C ./

# Проверка файлов
ls -la .env.local nginx.conf docker-compose.yml
```

**Важно:**
- После восстановления `.env.local` проверить все переменные окружения
- Перезапустить приложение для применения изменений

---

## АВТОМАТИЗАЦИЯ БЭКАПОВ

### 1. Cron задача для автоматического бэкапа

**Создание cron задачи:**

```bash
# Редактирование crontab
crontab -e

# Добавление задачи для ежедневного бэкапа в 2:00 ночи
# Важно: загрузить переменные окружения перед запуском
0 2 * * * cd /path/to/project && source .env.backup && export $(cat .env.backup | xargs) && node scripts/backup-supabase.js >> /var/log/supabase_backup.log 2>&1
```

**Примеры расписаний:**

```bash
# Ежедневно в 2:00
0 2 * * * cd /path/to/project && source .env.backup && export $(cat .env.backup | xargs) && node scripts/backup-supabase.js

# Каждые 6 часов
0 */6 * * * cd /path/to/project && source .env.backup && export $(cat .env.backup | xargs) && node scripts/backup-supabase.js

# Еженедельно в воскресенье в 3:00
0 3 * * 0 cd /path/to/project && source .env.backup && export $(cat .env.backup | xargs) && node scripts/backup-supabase.js

# Ежедневно с отправкой на email при ошибке
0 2 * * * cd /path/to/project && source .env.backup && export $(cat .env.backup | xargs) && node scripts/backup-supabase.js || mail -s "Backup failed" admin@example.com

# Или через полный скрипт (с загрузкой в облако)
0 2 * * * cd /path/to/project && bash scripts/full-backup-supabase.sh >> /var/log/supabase_backup.log 2>&1
```

### 2. Скрипт для полного бэкапа (БД + Storage + загрузка в облако)

**Скрипт:** `scripts/full-backup-supabase.sh` (уже существует в проекте)

**Описание:**
Скрипт выполняет полный бэкап Supabase проекта и автоматически загружает его в облачное хранилище (если настроено).

**Использование:**
```bash
# Загрузить переменные окружения
source .env.backup

# Запустить полный бэкап
bash scripts/full-backup-supabase.sh
```

**Процесс:**
1. Создание бэкапа БД и Storage через `backup-supabase.js`
2. Создание tar.gz архива
3. Загрузка в облачное хранилище (AWS S3 или rclone), если настроено

**Настройка облачного хранилища:**
Добавьте в `.env.backup`:
```bash
# Для AWS S3
AWS_ACCESS_KEY_ID=your_access_key
AWS_SECRET_ACCESS_KEY=your_secret_key
AWS_S3_BUCKET=your_bucket_name
AWS_REGION=us-east-1

# Или для rclone (Google Drive, Dropbox и т.д.)
RCLONE_REMOTE=gdrive
```

### 3. Windows Task Scheduler для автоматического бэкапа

**Настройка автоматического бэкапа на Windows:**

1. **Создать bat файл** (например, `auto-backup.bat`):
```batch
@echo off
cd /d C:\path\to\project
call scripts\backup-supabase-windows.bat
```

2. **Настроить Task Scheduler:**
   - Открыть Task Scheduler
   - Создать Basic Task
   - Указать расписание (например, ежедневно в 2:00)
   - Указать действие: запуск `auto-backup.bat`
   - Установить "Run whether user is logged on or not"
   - Указать учетную запись с правами администратора

**Примечание:** Убедитесь, что Node.js доступен в PATH для системных задач.

---

## ХРАНЕНИЕ И РОТАЦИЯ БЭКАПОВ

### 1. Локальное хранилище

**Структура директории:**
```
backups/
├── database/
│   ├── imperial_tunes_backup_20250130_020000.sql.gz
│   ├── imperial_tunes_backup_20250129_020000.sql.gz
│   ├── backup_info_20250130_020000.txt
│   └── ...
├── storage/
│   ├── songs/
│   ├── covers/
│   └── avatars/
├── config/
│   └── config_20250130_020000.tar.gz
└── full_backup_20250130_020000.tar.gz
```

**Ротация:**
- Рекомендуется настроить ручную или автоматическую ротацию
- Сохранение последних 7-30 бэкапов (в зависимости от размера)
- Можно настроить через cron задачи или скрипты очистки

### 2. Облачное хранилище

**Рекомендуемые сервисы:**
- **AWS S3** - для долгосрочного хранения
- **Google Cloud Storage** - альтернатива S3
- **Azure Blob Storage** - для Azure окружений
- **Backblaze B2** - экономичное решение

**Пример загрузки в S3:**
```bash
# Автоматическая загрузка через скрипт
node scripts/upload-to-cloud.js ./backups/supabase_backup_YYYYMMDD_HHMMSS.tar.gz

# Или через полный скрипт (автоматически загружает в облако)
bash scripts/full-backup-supabase.sh
```

**Настройка lifecycle политики S3:**
```json
{
  "Rules": [
    {
      "Id": "DeleteOldBackups",
      "Status": "Enabled",
      "Expiration": {
        "Days": 30
      }
    },
    {
      "Id": "TransitionToGlacier",
      "Status": "Enabled",
      "Transitions": [
        {
          "Days": 7,
          "StorageClass": "GLACIER"
        }
      ]
    }
  ]
}
```

### 3. Политика ротации

**Таблица 2: Политика ротации бэкапов**

| Тип бэкапа | Частота создания | Хранение | Автоматическое удаление |
|------------|------------------|----------|-------------------------|
| Ежедневный | Раз в день | 7 дней | Да (автоматически) |
| Еженедельный | Раз в неделю | 4 недели | Да (через 28 дней) |
| Ежемесячный | Раз в месяц | 12 месяцев | Да (через 1 год) |
| Годовой | Раз в год | 5 лет | Нет (ручное удаление) |

---

## БЭКАПЫ SUPABASE (CLOUD)

### 1. Автоматические бэкапы Supabase

**Описание:**
Supabase автоматически создаёт ежедневные бэкапы для всех проектов на платном плане.

**Характеристики:**
- **Частота:** Ежедневно в 00:00 UTC
- **Хранение:** 7 дней (на платном плане)
- **Формат:** Point-in-time recovery (PITR)
- **Восстановление:** Через Supabase Dashboard

**Примечание:** Для бесплатных планов автоматические бэкапы недоступны, поэтому рекомендуется использовать ручные скрипты бэкапа.

### 2. Ручной бэкап через скрипты проекта

**Для проектов с облачной Supabase БД (без локальной БД):**

Проект включает специальные скрипты для создания полного бэкапа Supabase проекта, включая:
- Базу данных (через API или pg_dump)
- Storage файлы (songs, covers, avatars)

#### 2.1. Настройка переменных окружения

**Скрипт:** `scripts/setup-backup-env.sh`

```bash
bash scripts/setup-backup-env.sh
```

Создаёт файл `.env.backup` с необходимыми переменными:
- `SUPABASE_URL` - URL проекта Supabase
- `SUPABASE_SERVICE_ROLE_KEY` - Service Role Key (для доступа к Storage)
- `SUPABASE_DB_URL` - Connection string для PostgreSQL (опционально)

#### 2.2. Создание полного бэкапа

**Скрипт:** `scripts/backup-supabase.js`

```bash
# Загрузить переменные окружения
source .env.backup

# Создать бэкап
node scripts/backup-supabase.js
```

**Что создаётся:**
- Бэкап базы данных (SQL или JSON)
- Бэкап всех Storage файлов (songs, covers, avatars)
- Информационный файл о бэкапе
- Опционально: сжатый архив

**Структура бэкапа:**
```
backups/supabase_backup_YYYYMMDD_HHMMSS/
├── database/
│   ├── database_backup_YYYYMMDD_HHMMSS.sql.gz
│   └── database_data_YYYYMMDD_HHMMSS.json (если через API)
├── storage/
│   ├── songs/     (все аудио файлы)
│   ├── covers/    (обложки альбомов)
│   └── avatars/    (аватары пользователей)
└── backup_info.txt
```

#### 2.3. Полный бэкап с загрузкой в облако

**Скрипт:** `scripts/full-backup-supabase.sh`

```bash
bash scripts/full-backup-supabase.sh
```

Выполняет:
1. Создание бэкапа БД и Storage
2. Создание архива
3. Загрузку в облачное хранилище (если настроено)

#### 2.4. Методы бэкапа базы данных

**Метод 1: Через pg_dump (требует SUPABASE_DB_URL)**
- Создаёт полный SQL дамп со схемой и данными
- Требует прямого доступа к PostgreSQL

**Метод 2: Через Supabase API (автоматически, если нет SUPABASE_DB_URL)**
- Экспортирует все данные таблиц в JSON
- Не требует прямого доступа к БД
- Экспортирует только данные, не схему

#### 2.5. Бэкап Storage файлов

Скрипт рекурсивно скачивает все файлы из Storage buckets:
- `songs` - аудио файлы (mp3, wav, flac, ogg, m4a)
- `covers` - обложки альбомов (jpeg, png, webp)
- `avatars` - аватары пользователей (jpeg, png, webp)

### 3. Восстановление из бэкапа

**Скрипт:** `scripts/restore-supabase.js`

```bash
source .env.backup
node scripts/restore-supabase.js ./backups/supabase_backup_YYYYMMDD_HHMMSS
```

**Процесс:**
1. Проверка наличия бэкапа
2. Восстановление базы данных (SQL или JSON)
3. Загрузка файлов в Storage buckets
4. Проверка восстановления

### 4. Загрузка бэкапов в облачное хранилище

**Скрипт:** `scripts/upload-to-cloud.js`

Поддерживает:
- **AWS S3** - через AWS CLI
- **Google Drive / Dropbox** - через rclone

**Настройка AWS S3:**
```bash
# В .env.backup
AWS_ACCESS_KEY_ID=your_access_key
AWS_SECRET_ACCESS_KEY=your_secret_key
AWS_S3_BUCKET=your_bucket_name
AWS_REGION=us-east-1
```

**Настройка rclone:**
```bash
# Установка rclone
curl https://rclone.org/install.sh | sudo bash

# Настройка remote
rclone config

# В .env.backup
RCLONE_REMOTE=gdrive
```

**Загрузка:**
```bash
node scripts/upload-to-cloud.js ./backups/supabase_backup_YYYYMMDD_HHMMSS.tar.gz
```

### 5. Ручной бэкап через Supabase Dashboard

**Процедура:**
1. Открыть Supabase Dashboard
2. Выбрать проект
3. Перейти в **Database** → **Backups**
4. Нажать **Create backup**
5. Дождаться завершения
6. Скачать бэкап или восстановить из него

**Примечание:** Доступно только на платных планах.

### 6. Экспорт данных через Supabase CLI

**Установка:**
```bash
npm install -g supabase
```

**Экспорт схемы:**
```bash
supabase db dump --schema public > schema_backup.sql
```

**Экспорт данных:**
```bash
supabase db dump --data-only > data_backup.sql
```

**Экспорт полного бэкапа:**
```bash
supabase db dump > full_backup.sql
```

**Восстановление:**
```bash
# Восстановление схемы
supabase db reset

# Восстановление из SQL файла
psql -h db.xxxxx.supabase.co -U postgres -d postgres -f full_backup.sql
```

---

## ВОССТАНОВЛЕНИЕ В РАЗЛИЧНЫХ СЦЕНАРИЯХ

### 1. Полная потеря данных (Disaster Recovery)

**Сценарий:** Полная потеря базы данных и Storage

**Процедура восстановления:**

1. **Восстановление базы данных**
   ```bash
   # Загрузить переменные окружения
   source .env.backup
   
   # Восстановить из бэкапа Supabase
   node scripts/restore-supabase.js ./backups/supabase_backup_YYYYMMDD_HHMMSS
   ```

2. **Восстановление Storage**
   - Выполняется автоматически скриптом `restore-supabase.js`
   - Или вручную через Supabase Dashboard → Storage → Upload

3. **Проверка восстановления**
   ```sql
   -- Проверка количества записей
   SELECT 
     (SELECT COUNT(*) FROM users) as users_count,
     (SELECT COUNT(*) FROM tracks) as tracks_count,
     (SELECT COUNT(*) FROM albums) as albums_count,
     (SELECT COUNT(*) FROM playlists) as playlists_count;
   ```

4. **Обновление URL в БД** (если изменился домен)
   ```sql
   -- Обновление URL файлов в Storage (если нужно)
   UPDATE tracks SET track_audio_url = REPLACE(track_audio_url, 'old-domain', 'new-domain');
   UPDATE albums SET album_cover_url = REPLACE(album_cover_url, 'old-domain', 'new-domain');
   ```

### 2. Восстановление отдельных таблиц

**Сценарий:** Потеря данных в одной или нескольких таблицах

**Процедура:**

1. **Экспорт данных из бэкапа**
   ```bash
   # Извлечь только нужные таблицы из бэкапа
   gunzip -c backups/imperial_tunes_backup_20250130.sql.gz | \
     grep -A 10000 "COPY public.users" > users_backup.sql
   ```

2. **Восстановление таблицы**
   ```sql
   -- Очистить таблицу (если нужно)
   TRUNCATE TABLE public.users CASCADE;
   
   -- Импортировать данные
   \i users_backup.sql
   ```

**Или через pg_restore:**
```bash
# Создать бэкап в custom формате
pg_dump -h localhost -U postgres -d imperial_tunes \
  --format=custom -Fc > backup.custom

# Восстановить только нужную таблицу
pg_restore -h localhost -U postgres -d imperial_tunes \
  -t users backup.custom
```

### 3. Восстановление до определённого момента времени (Point-in-Time Recovery)

**Сценарий:** Необходимость восстановления данных до определённого момента

**Требования:**
- Включён WAL (Write-Ahead Logging) в PostgreSQL
- Доступны архивные WAL файлы

**Процедура:**

1. **Восстановить из последнего полного бэкапа**
   ```bash
   source .env.backup
   node scripts/restore-supabase.js ./backups/supabase_backup_2025-11-05_223901
   ```

2. **Восстановить WAL файлы до нужного момента**
   ```bash
   # Настройка recovery.conf (PostgreSQL 12+)
   cat > recovery.conf << EOF
   restore_command = 'cp /path/to/wal/%f %p'
   recovery_target_time = '2025-01-30 14:30:00'
   EOF
   ```

3. **Перезапустить PostgreSQL**
   ```bash
   systemctl restart postgresql
   ```

**Примечание:** Для Supabase Cloud используется встроенный PITR через Dashboard.

### 4. Восстановление после сбоя миграции

**Сценарий:** Миграция завершилась с ошибкой, часть данных повреждена

**Процедура:**

1. **Откат миграции**
   ```sql
   -- Откатить последнюю миграцию вручную
   -- (зависит от содержимого миграции)
   ```

2. **Восстановление из бэкапа перед миграцией**
   ```bash
   # Найти бэкап перед миграцией
   ls -lt backups/ | head -5
   
   # Восстановить из бэкапа
   source .env.backup
   node scripts/restore-supabase.js ./backups/supabase_backup_BEFORE_MIGRATION
   ```

3. **Исправление миграции и повторное применение**
   ```bash
   # Исправить миграцию
   # Затем применить заново
   psql -h localhost -U postgres -d imperial_tunes -f supabase/migrations/FIXED_MIGRATION.sql
   ```

### 5. Восстановление после удаления файлов в Storage

**Сценарий:** Случайное удаление файлов из Storage buckets

**Процедура:**

1. **Проверка удалённых файлов**
   ```sql
   -- Найти записи с несуществующими файлами
   SELECT id, track_audio_url 
   FROM tracks 
   WHERE track_audio_url IS NOT NULL;
   ```

2. **Восстановление из бэкапа Storage**
   ```bash
   # Восстановить файлы из бэкапа
   supabase storage upload songs ./backups/storage/songs --upsert
   ```

3. **Обновление URL в БД** (если пути изменились)
   ```sql
   -- Обновить URL если файлы были перемещены
   UPDATE tracks 
   SET track_audio_url = REPLACE(track_audio_url, 'old_path', 'new_path')
   WHERE track_audio_url LIKE 'old_path%';
   ```

---

## ПРОВЕРКА ЦЕЛОСТНОСТИ БЭКАПОВ

### 1. Проверка целостности бэкапа

**Автоматическая проверка:**
Скрипт `restore-supabase.js` проверяет наличие всех необходимых файлов перед восстановлением.

**Ручная проверка:**
```bash
# Проверить наличие файлов бэкапа
ls -la backups/supabase_backup_YYYYMMDD_HHMMSS/

# Проверить размер файлов базы данных
ls -lh backups/supabase_backup_YYYYMMDD_HHMMSS/database/

# Проверить количество файлов в Storage
find backups/supabase_backup_YYYYMMDD_HHMMSS/storage -type f | wc -l

# Проверить содержимое backup_info.txt
cat backups/supabase_backup_YYYYMMDD_HHMMSS/backup_info.txt
```

### 2. Проверка структуры бэкапа

**Для SQL дампа:**
```bash
# Проверка наличия CREATE TABLE
grep -c "CREATE TABLE" backups/supabase_backup_YYYYMMDD_HHMMSS/database/*.sql

# Проверка наличия основных таблиц
grep -E "CREATE TABLE.*(users|tracks|albums|playlists)" \
  backups/supabase_backup_YYYYMMDD_HHMMSS/database/*.sql
```

**Для JSON дампа:**
```bash
# Проверка структуры JSON
cat backups/supabase_backup_YYYYMMDD_HHMMSS/database/*.json | jq '.tables | keys'

# Должны быть таблицы:
# roles, users, artists, genres, albums, tracks, playlists,
# track_genres, playlist_tracks, listening_history, audit_log,
# favorites_tracks, favorites_albums, favorites_playlists,
# artist_applications
```

### 3. Тестовое восстановление

**Для Supabase проекта:**
Рекомендуется создать тестовый проект Supabase и восстановить бэкап туда перед восстановлением в production.

**Процедура:**
1. Создать новый проект в Supabase Dashboard (тестовый)
2. Скопировать `.env.backup` в `.env.backup.test` и обновить URL на тестовый проект
3. Загрузить переменные окружения тестового проекта
4. Выполнить восстановление:
```bash
source .env.backup.test
node scripts/restore-supabase.js ./backups/supabase_backup_YYYYMMDD_HHMMSS
```
5. Проверить данные в тестовом проекте
6. Если всё корректно, выполнить восстановление в production проект

### 4. Проверка размера бэкапа

**Ожидаемые размеры:**
- Пустая БД (только схема): ~500 KB - 1 MB
- БД с небольшим количеством данных: 1-5 MB
- БД с большим количеством данных: 5-50 MB
- Storage файлы: зависит от загруженного контента (может быть несколько GB)

**Проверка:**
```bash
# Размер директории бэкапа
du -sh backups/supabase_backup_YYYYMMDD_HHMMSS

# Размер базы данных
du -sh backups/supabase_backup_YYYYMMDD_HHMMSS/database

# Размер Storage
du -sh backups/supabase_backup_YYYYMMDD_HHMMSS/storage

# Если размер необычно мал, возможно бэкап неполный
```

---

## ДОКУМЕНТАЦИЯ БЭКАПОВ

### Таблица 3: Информация о бэкапе

**Файл:** `backups/backup_info_YYYYMMDD_HHMMSS.txt`

**Содержимое:**
```
ImperialTunes Database Backup Information
=========================================
Date: Thu Jan 30 15:30:45 MSK 2025
Database: imperial_tunes
Host: localhost:5432
User: postgres
Backup File: imperial_tunes_backup_20250130_153045.sql.gz
Original Size: 2.5M
Compressed Size: 856K
MD5 Hash: a1b2c3d4e5f6g7h8i9j0k1l2m3n4o5p6
```

### Таблица 4: Лог операций бэкапа

**Рекомендуется вести лог всех операций:**

| Дата/Время | Операция | Файл | Размер | MD5 | Статус | Примечания |
|------------|----------|------|--------|-----|--------|------------|
| 2025-01-30 02:00 | Создание | imperial_tunes_backup_20250130_020000.sql.gz | 856K | a1b2c3... | ✅ Успешно | Автоматический бэкап |
| 2025-01-30 15:30 | Восстановление | imperial_tunes_backup_20250129_020000.sql.gz | 823K | b2c3d4... | ✅ Успешно | Восстановление после ошибки |
| 2025-01-31 02:00 | Создание | imperial_tunes_backup_20250131_020000.sql.gz | 891K | c3d4e5... | ✅ Успешно | Автоматический бэкап |

---

## РЕКОМЕНДАЦИИ ПО БЭКАПАМ

### 1. Частота создания бэкапов

**Рекомендуемая частота:**
- **Production:** Каждые 6 часов или ежедневно
- **Development:** Ежедневно или перед важными изменениями
- **Перед миграциями:** Обязательно создать бэкап

### 2. Хранение бэкапов

**Правило 3-2-1:**
- **3** копии данных (оригинал + 2 бэкапа)
- **2** разных типа носителей (локальный диск + облако)
- **1** копия в удалённом хранилище

**Рекомендации:**
- Локальные бэкапы для быстрого восстановления
- Облачные бэкапы для защиты от катастроф
- Географически распределённое хранение

### 3. Тестирование восстановления

**Частота:**
- Ежемесячно тестировать восстановление из бэкапа
- Проверять целостность данных после восстановления
- Документировать результаты тестирования

**Процедура тестирования:**
1. Создать тестовую БД
2. Восстановить из последнего бэкапа
3. Проверить структуру и данные
4. Удалить тестовую БД

### 4. Мониторинг бэкапов

**Что мониторить:**
- Успешность создания бэкапов
- Размер бэкапов (аномальные изменения)
- Время создания бэкапов
- Доступность хранилища бэкапов

**Настройка алертов:**
```bash
# Скрипт для проверки последнего бэкапа
#!/bin/bash
LAST_BACKUP=$(ls -t backups/*.sql.gz | head -1)
LAST_BACKUP_AGE=$(($(date +%s) - $(stat -c %Y "$LAST_BACKUP")))

# Если бэкап старше 25 часов - отправить алерт
if [ $LAST_BACKUP_AGE -gt 90000 ]; then
  echo "⚠️ Последний бэкап старше 25 часов!" | mail -s "Backup Alert" admin@example.com
fi
```

---

## ЗАКЛЮЧЕНИЕ

Система бэкапов и восстановления проекта Imperial Tunes обеспечивает:

1. **Регулярное резервное копирование** - автоматические ежедневные бэкапы
2. **Проверку целостности** - MD5 хеши для проверки бэкапов
3. **Быстрое восстановление** - скрипты для автоматического восстановления
4. **Защиту от потери данных** - многоуровневое хранение (локально + облако)
5. **Документирование** - информация о каждом бэкапе

Все процедуры бэкапов и восстановления документированы и могут быть выполнены администратором системы.

---

**Дата создания документа**: 2025-01-30  
**Версия проекта**: 6.0  
**База данных**: PostgreSQL 15+ (Supabase)  
**Скрипты бэкапов**: `scripts/backup.sh`, `scripts/restore.sh`

