# Схема тестирования ImperialTunes

## Версия документа: 1.0
## Дата создания: 06.11.2025
## Проект: ImperialTunes

---

## Оглавление

1. [Общая информация](#общая-информация)
2. [Пирамида тестов](#пирамида-тестов)
3. [Инструменты тестирования](#инструменты-тестирования)
4. [Метрики качества](#метрики-качества)
5. [Стратегия тестирования](#стратегия-тестирования)
6. [Процесс тестирования](#процесс-тестирования)
7. [Автоматизация тестирования](#автоматизация-тестирования)
8. [Отчётность](#отчётность)

---

## Общая информация

### Цель тестирования

Обеспечение качества, надёжности и производительности системы ImperialTunes через систематическое тестирование на всех уровнях.

### Область тестирования

1. **Функциональное тестирование** - проверка функциональности системы
2. **Интеграционное тестирование** - проверка взаимодействия компонентов
3. **Нагрузочное тестирование** - проверка производительности под нагрузкой
4. **Тестирование безопасности** - проверка защиты данных и доступа
5. **Тестирование отказоустойчивости** - проверка восстановления после сбоев
6. **Регрессионное тестирование** - проверка отсутствия регрессий
7. **Тестирование пользовательского интерфейса** - проверка UI/UX

---

## Пирамида тестов

### Структура пирамиды тестов

```
                    /\
                   /  \
                  / E2E \           ← Небольшое количество (5-10%)
                 /______\
                /        \
               / Integration\       ← Среднее количество (20-30%)
              /____________\
             /              \
            /   Unit Tests    \     ← Большое количество (60-70%)
           /__________________\
```

### Уровень 1: Unit-тесты (Единичные тесты)

**Описание:** Тестирование отдельных функций, компонентов и модулей изолированно.

**Цель:** Проверка корректности работы отдельных единиц кода.

**Покрытие:** 60-70% от общего количества тестов.

**Примеры:**
- Тестирование функций валидации
- Тестирование утилитарных функций
- Тестирование компонентов React изолированно
- Тестирование SQL функций и триггеров

**Инструменты:**
- **Jest** - фреймворк для unit-тестирования JavaScript/TypeScript
- **React Testing Library** - тестирование React компонентов
- **pgTAP** - тестирование PostgreSQL функций и триггеров

**Пример unit-теста:**

```typescript
// src/utils/formatDuration.test.ts
import { formatDuration } from './formatDuration';

describe('formatDuration', () => {
  it('should format seconds to MM:SS', () => {
    expect(formatDuration(125)).toBe('2:05');
    expect(formatDuration(3600)).toBe('60:00');
    expect(formatDuration(0)).toBe('0:00');
  });
});
```

### Уровень 2: Интеграционные тесты

**Описание:** Тестирование взаимодействия между компонентами, модулями и сервисами.

**Цель:** Проверка корректности взаимодействия компонентов системы.

**Покрытие:** 20-30% от общего количества тестов.

**Примеры:**
- Тестирование взаимодействия компонентов React
- Тестирование API endpoints
- Тестирование интеграции с Supabase
- Тестирование транзакций БД

**Инструменты:**
- **Jest** - фреймворк для интеграционного тестирования
- **Supertest** - тестирование HTTP endpoints
- **MSW (Mock Service Worker)** - мокирование API запросов
- **pgTAP** - тестирование SQL транзакций

**Пример интеграционного теста:**

```typescript
// src/integrations/supabase/tracks.test.ts
import { supabase } from './client';

describe('Tracks API Integration', () => {
  it('should create a track', async () => {
    const { data, error } = await supabase
      .from('tracks')
      .insert({
        track_title: 'Test Track',
        track_duration: 180,
        album_id: 'test-album-id'
      });
    
    expect(error).toBeNull();
    expect(data).toBeDefined();
  });
});
```

### Уровень 3: E2E тесты (End-to-End тесты)

**Описание:** Тестирование полного потока работы приложения от начала до конца.

**Цель:** Проверка корректности работы системы с точки зрения пользователя.

**Покрытие:** 5-10% от общего количества тестов.

**Примеры:**
- Тестирование регистрации и входа пользователя
- Тестирование загрузки трека
- Тестирование воспроизведения трека
- Тестирование создания плейлиста

**Инструменты:**
- **Playwright** - фреймворк для E2E тестирования
- **Cypress** - альтернативный фреймворк для E2E тестирования
- **Puppeteer** - инструмент для автоматизации браузера

**Пример E2E теста:**

```typescript
// e2e/playback.test.ts
import { test, expect } from '@playwright/test';

test('user can play a track', async ({ page }) => {
  await page.goto('http://localhost:5173');
  await page.click('text=Войти');
  await page.fill('input[type="email"]', 'test@example.com');
  await page.fill('input[type="password"]', 'password');
  await page.click('button:has-text("Войти")');
  
  await page.click('text=Треки');
  await page.click('.track-item:first-child');
  await page.click('button[aria-label="Play"]');
  
  await expect(page.locator('button[aria-label="Pause"]')).toBeVisible();
});
```

---

## Инструменты тестирования

### 1. Jest

**Описание:** Фреймворк для тестирования JavaScript/TypeScript приложений.

**Установка:**
```bash
npm install --save-dev jest @types/jest ts-jest
```

**Конфигурация:**
```json
// package.json
{
  "scripts": {
    "test": "jest",
    "test:watch": "jest --watch",
    "test:coverage": "jest --coverage"
  },
  "jest": {
    "preset": "ts-jest",
    "testEnvironment": "jsdom",
    "setupFilesAfterEnv": ["<rootDir>/src/test/setup.ts"],
    "moduleNameMapper": {
      "^@/(.*)$": "<rootDir>/src/$1"
    },
    "collectCoverageFrom": [
      "src/**/*.{ts,tsx}",
      "!src/**/*.d.ts",
      "!src/test/**/*"
    ]
  }
}
```

**Использование:**
```bash
# Запуск всех тестов
npm test

# Запуск тестов в watch режиме
npm run test:watch

# Запуск тестов с покрытием
npm run test:coverage
```

### 2. React Testing Library

**Описание:** Библиотека для тестирования React компонентов.

**Установка:**
```bash
npm install --save-dev @testing-library/react @testing-library/jest-dom @testing-library/user-event
```

**Использование:**
```typescript
// src/components/MusicPlayer.test.tsx
import { render, screen, fireEvent } from '@testing-library/react';
import { MusicPlayer } from './MusicPlayer';

describe('MusicPlayer', () => {
  it('should render play button', () => {
    render(<MusicPlayer track={mockTrack} />);
    expect(screen.getByLabelText('Play')).toBeInTheDocument();
  });
  
  it('should play track when play button is clicked', () => {
    render(<MusicPlayer track={mockTrack} />);
    fireEvent.click(screen.getByLabelText('Play'));
    expect(screen.getByLabelText('Pause')).toBeInTheDocument();
  });
});
```

### 3. Playwright

**Описание:** Фреймворк для E2E тестирования веб-приложений.

**Установка:**
```bash
npm install --save-dev @playwright/test
npx playwright install
```

**Конфигурация:**
```typescript
// playwright.config.ts
import { defineConfig, devices } from '@playwright/test';

export default defineConfig({
  testDir: './e2e',
  fullyParallel: true,
  forbidOnly: !!process.env.CI,
  retries: process.env.CI ? 2 : 0,
  workers: process.env.CI ? 1 : undefined,
  reporter: 'html',
  use: {
    baseURL: 'http://localhost:5173',
    trace: 'on-first-retry',
  },
  projects: [
    {
      name: 'chromium',
      use: { ...devices['Desktop Chrome'] },
    },
    {
      name: 'firefox',
      use: { ...devices['Desktop Firefox'] },
    },
    {
      name: 'webkit',
      use: { ...devices['Desktop Safari'] },
    },
  ],
  webServer: {
    command: 'npm run dev',
    url: 'http://localhost:5173',
    reuseExistingServer: !process.env.CI,
  },
});
```

**Использование:**
```bash
# Запуск E2E тестов
npx playwright test

# Запуск E2E тестов в UI режиме
npx playwright test --ui

# Запуск E2E тестов в определённом браузере
npx playwright test --project=chromium
```

### 4. pgTAP

**Описание:** Фреймворк для тестирования PostgreSQL функций и триггеров.

**Установка:**
```bash
# Ubuntu/Debian
sudo apt-get install pgtap

# macOS
brew install pgtap

# Или через расширение PostgreSQL
CREATE EXTENSION IF NOT EXISTS pgtap;
```

**Использование:**
```sql
-- supabase/migrations/test_functions.sql
BEGIN;

SELECT plan(3);

-- Тест функции toggle_favorite_track
SELECT ok(
  (SELECT (data->>'success')::boolean 
   FROM toggle_favorite_track('test-track-id')),
  'toggle_favorite_track should return success'
);

-- Тест функции ensure_user_exists
SELECT ok(
  (SELECT (data->>'success')::boolean 
   FROM ensure_user_exists()),
  'ensure_user_exists should return success'
);

-- Тест триггера listening_history_trigger
INSERT INTO listening_history (user_id, track_id, duration_played, completed)
VALUES ('test-user-id', 'test-track-id', 120, true);

SELECT is(
  (SELECT track_play_count FROM tracks WHERE id = 'test-track-id'),
  1,
  'track_play_count should be incremented after inserting listening_history'
);

SELECT * FROM finish();
ROLLBACK;
```

### 5. k6 (для нагрузочного тестирования)

**Описание:** Инструмент для нагрузочного тестирования API.

**Установка:**
```bash
# macOS
brew install k6

# Linux
sudo gpg -k
sudo gpg --no-default-keyring --keyring /usr/share/keyrings/k6-archive-keyring.gpg --keyserver hkp://keyserver.ubuntu.com:80 --recv-keys C5AD17C747E3415A3642D57D77C6C491D6AC1D69
echo "deb [signed-by=/usr/share/keyrings/k6-archive-keyring.gpg] https://dl.k6.io/deb stable main" | sudo tee /etc/apt/sources.list.d/k6.list
sudo apt-get update
sudo apt-get install k6

# Windows
choco install k6
```

**Использование:**
```javascript
// tests/load/api.js
import http from 'k6/http';
import { check, sleep } from 'k6';

export const options = {
  stages: [
    { duration: '30s', target: 20 },
    { duration: '1m', target: 50 },
    { duration: '30s', target: 0 },
  ],
  thresholds: {
    http_req_duration: ['p(95)<500'],
    http_req_failed: ['rate<0.01'],
  },
};

export default function () {
  const res = http.get('https://[project-ref].supabase.co/rest/v1/tracks?limit=10', {
    headers: {
      'apikey': __ENV.SUPABASE_ANON_KEY,
    },
  });
  
  check(res, {
    'status is 200': (r) => r.status === 200,
    'response time < 500ms': (r) => r.timings.duration < 500,
  });
  
  sleep(1);
}
```

**Запуск:**
```bash
# Запуск нагрузочного теста
k6 run tests/load/api.js

# Запуск с переменными окружения
SUPABASE_ANON_KEY=your_key k6 run tests/load/api.js
```

### 6. Artillery (альтернатива k6)

**Описание:** Альтернативный инструмент для нагрузочного тестирования.

**Установка:**
```bash
npm install -g artillery
```

**Использование:**
```yaml
# tests/load/artillery.yml
config:
  target: 'https://[project-ref].supabase.co'
  phases:
    - duration: 60
      arrivalRate: 10
      name: "Warm up"
    - duration: 120
      arrivalRate: 20
      name: "Ramp up"
    - duration: 60
      arrivalRate: 20
      name: "Sustained load"
  defaults:
    headers:
      apikey: '{{ $processEnvironment.SUPABASE_ANON_KEY }}'

scenarios:
  - name: "Get tracks"
    flow:
      - get:
          url: "/rest/v1/tracks?limit=10"
```

**Запуск:**
```bash
artillery run tests/load/artillery.yml
```

---

## Метрики качества

### 1. Покрытие кода (Code Coverage)

**Целевое покрытие:**
- **Unit-тесты:** 80%+
- **Интеграционные тесты:** 60%+
- **E2E тесты:** 40%+

**Инструменты:**
- **Jest Coverage** - встроенное покрытие в Jest
- **Istanbul** - инструмент для анализа покрытия
- **Coveralls** - сервис для отслеживания покрытия

**Метрики:**
- **Statement Coverage** - покрытие statements (операторов)
- **Branch Coverage** - покрытие ветвей (if/else)
- **Function Coverage** - покрытие функций
- **Line Coverage** - покрытие строк

**Пример отчёта:**
```
File      | % Stmts | % Branch | % Funcs | % Lines | Uncovered Line #s
----------|---------|----------|---------|---------|------------------
All files |   75.5  |   68.2   |   72.1  |   75.5  |
 utils.ts |   90.0  |   85.0   |   95.0  |   90.0  |
 player.ts|   65.0  |   55.0   |   60.0  |   65.0  | 45-50, 78-82
```

### 2. Производительность (Performance)

**Метрики:**
- **Время ответа API** - среднее время ответа API endpoints
- **Время загрузки страницы** - время загрузки страницы
- **Время первого рендера** - время до первого рендера (FCP)
- **Время интерактивности** - время до интерактивности (TTI)
- **Пропускная способность** - количество запросов в секунду (RPS)

**Целевые значения:**
- **Время ответа API:** < 200ms (p95)
- **Время загрузки страницы:** < 2s
- **Время первого рендера:** < 1s
- **Пропускная способность:** > 100 RPS

**Инструменты:**
- **Lighthouse** - анализ производительности веб-страниц
- **WebPageTest** - тестирование производительности
- **k6** - нагрузочное тестирование API
- **Artillery** - альтернативный инструмент для нагрузочного тестирования

### 3. Надёжность (Reliability)

**Метрики:**
- **Доступность (Availability)** - процент времени доступности системы
- **Среднее время между сбоями (MTBF)** - среднее время между сбоями
- **Среднее время восстановления (MTTR)** - среднее время восстановления
- **Частота ошибок (Error Rate)** - процент запросов с ошибками

**Целевые значения:**
- **Доступность:** 99.9% (3 девятки)
- **MTBF:** > 720 часов (30 дней)
- **MTTR:** < 1 час
- **Частота ошибок:** < 0.1%

**Инструменты:**
- **Мониторинг Supabase** - встроенный мониторинг Supabase
- **Sentry** - отслеживание ошибок
- **Datadog** - мониторинг производительности
- **New Relic** - альтернативный инструмент для мониторинга

### 4. Безопасность (Security)

**Метрики:**
- **Количество уязвимостей** - количество найденных уязвимостей
- **Уровень безопасности** - оценка уровня безопасности
- **Соответствие стандартам** - соответствие стандартам безопасности (OWASP, PCI DSS)

**Целевые значения:**
- **Количество критических уязвимостей:** 0
- **Количество высоких уязвимостей:** < 5
- **Уровень безопасности:** A (по шкале OWASP)

**Инструменты:**
- **npm audit** - проверка уязвимостей в зависимостях
- **Snyk** - сканирование уязвимостей
- **OWASP ZAP** - тестирование безопасности веб-приложений
- **Burp Suite** - альтернативный инструмент для тестирования безопасности

### 5. Качество кода (Code Quality)

**Метрики:**
- **Сложность кода (Cyclomatic Complexity)** - сложность кода
- **Дублирование кода (Code Duplication)** - процент дублирования кода
- **Соответствие стандартам** - соответствие стандартам кодирования (ESLint, Prettier)

**Целевые значения:**
- **Цикломатическая сложность:** < 10 на функцию
- **Дублирование кода:** < 3%
- **Соответствие стандартам:** 100%

**Инструменты:**
- **ESLint** - линтер для JavaScript/TypeScript
- **Prettier** - форматтер кода
- **SonarQube** - анализ качества кода
- **CodeClimate** - альтернативный инструмент для анализа качества кода

---

## Стратегия тестирования

### Функциональное тестирование

#### 1. Тестирование CRUD операций

**Цель:** Проверка корректности создания, чтения, обновления и удаления данных.

**Тестовые сценарии:**
- Создание трека
- Получение списка треков
- Обновление трека
- Удаление трека
- Создание плейлиста
- Добавление трека в плейлист
- Удаление трека из плейлиста

**Примеры тестов:**
```typescript
// tests/functional/crud.test.ts
describe('CRUD Operations', () => {
  it('should create a track', async () => {
    const track = await createTrack({
      track_title: 'Test Track',
      track_duration: 180,
      album_id: 'test-album-id'
    });
    expect(track).toBeDefined();
    expect(track.track_title).toBe('Test Track');
  });
  
  it('should get tracks', async () => {
    const tracks = await getTracks();
    expect(tracks).toBeInstanceOf(Array);
    expect(tracks.length).toBeGreaterThan(0);
  });
  
  it('should update a track', async () => {
    const track = await createTrack({...});
    const updated = await updateTrack(track.id, {
      track_title: 'Updated Track'
    });
    expect(updated.track_title).toBe('Updated Track');
  });
  
  it('should delete a track', async () => {
    const track = await createTrack({...});
    await deleteTrack(track.id);
    const found = await getTrack(track.id);
    expect(found).toBeNull();
  });
});
```

#### 2. Тестирование поиска и фильтрации

**Цель:** Проверка корректности поиска и фильтрации данных.

**Тестовые сценарии:**
- Поиск треков по названию
- Фильтрация треков по жанру
- Сортировка треков по популярности
- Фильтрация треков по дате

**Примеры тестов:**
```typescript
// tests/functional/search.test.ts
describe('Search and Filter', () => {
  it('should search tracks by title', async () => {
    const results = await searchTracks('rock');
    expect(results).toBeInstanceOf(Array);
    expect(results.every(t => t.track_title.toLowerCase().includes('rock'))).toBe(true);
  });
  
  it('should filter tracks by genre', async () => {
    const results = await filterTracksByGenre('rock');
    expect(results).toBeInstanceOf(Array);
    expect(results.every(t => t.genres.some(g => g.genre_name === 'rock'))).toBe(true);
  });
  
  it('should sort tracks by play count', async () => {
    const results = await getTracks({ order: 'track_play_count.desc' });
    expect(results).toBeInstanceOf(Array);
    for (let i = 1; i < results.length; i++) {
      expect(results[i-1].track_play_count).toBeGreaterThanOrEqual(results[i].track_play_count);
    }
  });
});
```

#### 3. Тестирование ролей и прав доступа

**Цель:** Проверка корректности разграничения прав доступа.

**Тестовые сценарии:**
- Пользователь может видеть только свои данные
- Администратор может видеть все данные
- Артист может загружать треки
- Дистрибьютор может управлять артистами

**Примеры тестов:**
```typescript
// tests/functional/rbac.test.ts
describe('Role-Based Access Control', () => {
  it('should restrict user access to own data', async () => {
    const user1 = await createUser({...});
    const user2 = await createUser({...});
    const playlist = await createPlaylist({ user_id: user1.id });
    
    // user2 не должен видеть плейлист user1
    const playlists = await getPlaylists({ user_id: user2.id });
    expect(playlists.find(p => p.id === playlist.id)).toBeUndefined();
  });
  
  it('should allow admin to see all data', async () => {
    const admin = await createUser({ role: 'admin' });
    const playlists = await getPlaylists({ user_id: admin.id, all: true });
    expect(playlists.length).toBeGreaterThan(0);
  });
  
  it('should allow artist to upload tracks', async () => {
    const artist = await createUser({ role: 'artist' });
    const track = await createTrack({ uploaded_by: artist.id });
    expect(track).toBeDefined();
  });
  
  it('should prevent non-artist from uploading tracks', async () => {
    const user = await createUser({ role: 'listener' });
    await expect(createTrack({ uploaded_by: user.id })).rejects.toThrow();
  });
});
```

### Интеграционное тестирование

#### 1. Тестирование API endpoints

**Цель:** Проверка корректности работы API endpoints.

**Тестовые сценарии:**
- Получение списка треков через API
- Создание трека через API
- Обновление трека через API
- Удаление трека через API

**Примеры тестов:**
```typescript
// tests/integration/api.test.ts
import request from 'supertest';
import { app } from '../src/app';

describe('API Endpoints', () => {
  it('should get tracks', async () => {
    const res = await request(app)
      .get('/api/tracks')
      .set('Authorization', `Bearer ${token}`)
      .expect(200);
    
    expect(res.body).toBeInstanceOf(Array);
  });
  
  it('should create a track', async () => {
    const res = await request(app)
      .post('/api/tracks')
      .set('Authorization', `Bearer ${token}`)
      .send({
        track_title: 'Test Track',
        track_duration: 180,
        album_id: 'test-album-id'
      })
      .expect(201);
    
    expect(res.body.track_title).toBe('Test Track');
  });
});
```

#### 2. Тестирование транзакций БД

**Цель:** Проверка корректности транзакций БД.

**Тестовые сценарии:**
- Атомарность транзакций
- Откат транзакций при ошибках
- Изоляция транзакций

**Примеры тестов:**
```sql
-- tests/integration/transactions.sql
BEGIN;

-- Тест атомарности транзакции
BEGIN;
INSERT INTO tracks (track_title, track_duration, album_id) 
VALUES ('Test Track', 180, 'test-album-id');
INSERT INTO track_genres (track_id, genre_id) 
VALUES (CURRVAL('tracks_id_seq'), 'test-genre-id');
-- Если одна из операций fail, обе должны откатиться
COMMIT;

-- Тест отката транзакции при ошибке
BEGIN;
INSERT INTO tracks (track_title, track_duration, album_id) 
VALUES ('Test Track', 180, 'invalid-album-id');
-- Должна возникнуть ошибка foreign key constraint
ROLLBACK;

SELECT * FROM finish();
```

### Нагрузочное тестирование

#### 1. Тестирование производительности API

**Цель:** Проверка производительности API под нагрузкой.

**Тестовые сценарии:**
- Нагрузка на получение списка треков
- Нагрузка на создание треков
- Нагрузка на обновление треков
- Нагрузка на поиск треков

**Профиль нагрузки:**
```javascript
// tests/load/api-load.js
export const options = {
  stages: [
    { duration: '1m', target: 50 },   // Ramp up to 50 users
    { duration: '3m', target: 50 },   // Stay at 50 users
    { duration: '1m', target: 100 },  // Ramp up to 100 users
    { duration: '3m', target: 100 },  // Stay at 100 users
    { duration: '1m', target: 0 },    // Ramp down to 0 users
  ],
  thresholds: {
    http_req_duration: ['p(95)<500'],  // 95% of requests should be below 500ms
    http_req_failed: ['rate<0.01'],    // Error rate should be below 1%
  },
};
```

#### 2. Тестирование массовых операций

**Цель:** Проверка производительности массовых операций.

**Тестовые сценарии:**
- Массовое создание треков (1000+ треков)
- Массовое обновление треков
- Массовое удаление треков
- Пакетные транзакции

**Примеры тестов:**
```typescript
// tests/load/batch-operations.test.ts
describe('Batch Operations', () => {
  it('should handle bulk insert of tracks', async () => {
    const tracks = Array.from({ length: 1000 }, (_, i) => ({
      track_title: `Track ${i}`,
      track_duration: 180,
      album_id: 'test-album-id'
    }));
    
    const start = Date.now();
    await bulkInsertTracks(tracks);
    const duration = Date.now() - start;
    
    expect(duration).toBeLessThan(10000); // Should complete in less than 10 seconds
  });
  
  it('should handle bulk update of tracks', async () => {
    const tracks = await getTracks({ limit: 1000 });
    const updates = tracks.map(t => ({ id: t.id, track_play_count: t.track_play_count + 1 }));
    
    const start = Date.now();
    await bulkUpdateTracks(updates);
    const duration = Date.now() - start;
    
    expect(duration).toBeLessThan(5000); // Should complete in less than 5 seconds
  });
});
```

### Тестирование безопасности

#### 1. Тестирование SQL-инъекций

**Цель:** Проверка защиты от SQL-инъекций.

**Тестовые сценарии:**
- Попытка SQL-инъекции в параметры запроса
- Попытка SQL-инъекции в тело запроса
- Попытка SQL-инъекции в заголовки запроса

**Примеры тестов:**
```typescript
// tests/security/sql-injection.test.ts
describe('SQL Injection Protection', () => {
  it('should prevent SQL injection in query parameters', async () => {
    const maliciousInput = "'; DROP TABLE tracks; --";
    const results = await searchTracks(maliciousInput);
    // Should return empty results or error, not execute SQL
    expect(results).toBeInstanceOf(Array);
  });
  
  it('should prevent SQL injection in request body', async () => {
    const maliciousInput = "'; DROP TABLE tracks; --";
    await expect(createTrack({
      track_title: maliciousInput,
      track_duration: 180,
      album_id: 'test-album-id'
    })).rejects.toThrow();
  });
});
```

#### 2. Тестирование аутентификации и авторизации

**Цель:** Проверка корректности аутентификации и авторизации.

**Тестовые сценарии:**
- Неавторизованный доступ к защищённым ресурсам
- Доступ с неверными учётными данными
- Доступ с истёкшим токеном
- Доступ с недостаточными правами

**Примеры тестов:**
```typescript
// tests/security/auth.test.ts
describe('Authentication and Authorization', () => {
  it('should reject unauthenticated requests', async () => {
    await expect(getTracks()).rejects.toThrow('Unauthorized');
  });
  
  it('should reject requests with invalid token', async () => {
    await expect(getTracks({ token: 'invalid-token' })).rejects.toThrow('Unauthorized');
  });
  
  it('should reject requests with expired token', async () => {
    const expiredToken = generateExpiredToken();
    await expect(getTracks({ token: expiredToken })).rejects.toThrow('Token expired');
  });
  
  it('should restrict access based on user role', async () => {
    const user = await createUser({ role: 'listener' });
    await expect(createTrack({ user_id: user.id })).rejects.toThrow('Forbidden');
  });
});
```

#### 3. Тестирование шифрования и маскирования

**Цель:** Проверка корректности шифрования и маскирования данных.

**Тестовые сценарии:**
- Шифрование паролей
- Маскирование чувствительных данных
- Хранение секретов

**Примеры тестов:**
```typescript
// tests/security/encryption.test.ts
describe('Encryption and Masking', () => {
  it('should hash passwords', async () => {
    const password = 'secure_password';
    const hashed = await hashPassword(password);
    expect(hashed).not.toBe(password);
    expect(hashed.length).toBeGreaterThan(32); // BCrypt hash length
  });
  
  it('should mask sensitive data in logs', async () => {
    const log = logUserAction({ password: 'secure_password' });
    expect(log).not.toContain('secure_password');
    expect(log).toContain('***');
  });
});
```

### Тестирование отказоустойчивости

#### 1. Тестирование восстановления после сбоев

**Цель:** Проверка корректности восстановления после сбоев.

**Тестовые сценарии:**
- Восстановление после сбоя БД
- Восстановление после сбоя Storage
- Восстановление после сетевого сбоя

**Примеры тестов:**
```typescript
// tests/resilience/recovery.test.ts
describe('Recovery from Failures', () => {
  it('should recover from database failure', async () => {
    // Симулировать сбой БД
    await simulateDatabaseFailure();
    
    // Восстановить из бэкапа
    await restoreFromBackup('./backups/supabase_backup_YYYYMMDD_HHMMSS');
    
    // Проверить восстановление
    const tracks = await getTracks();
    expect(tracks.length).toBeGreaterThan(0);
  });
  
  it('should recover from storage failure', async () => {
    // Симулировать сбой Storage
    await simulateStorageFailure();
    
    // Восстановить файлы из бэкапа
    await restoreStorageFromBackup('./backups/storage');
    
    // Проверить восстановление
    const files = await listStorageFiles('songs');
    expect(files.length).toBeGreaterThan(0);
  });
});
```

#### 2. Тестирование обработки ошибок

**Цель:** Проверка корректности обработки ошибок.

**Тестовые сценарии:**
- Обработка сетевых ошибок
- Обработка ошибок БД
- Обработка ошибок валидации

**Примеры тестов:**
```typescript
// tests/resilience/error-handling.test.ts
describe('Error Handling', () => {
  it('should handle network errors gracefully', async () => {
    await simulateNetworkError();
    const result = await getTracks();
    expect(result).toBeInstanceOf(Array);
    // Should return cached data or empty array
  });
  
  it('should handle database errors gracefully', async () => {
    await simulateDatabaseError();
    await expect(createTrack({...})).rejects.toThrow();
    // Should return meaningful error message
  });
  
  it('should handle validation errors gracefully', async () => {
    await expect(createTrack({
      track_title: '', // Invalid: empty title
      track_duration: 180,
      album_id: 'test-album-id'
    })).rejects.toThrow('Validation error');
  });
});
```

---

## Процесс тестирования

### 1. Планирование тестирования

#### Тест-план

**Документ:** `ТЕСТ-ПЛАН.md`

**Содержимое:**
- Область тестирования
- Стратегия тестирования
- Ресурсы для тестирования
- Расписание тестирования
- Критерии приёмки

#### Тест-кейсы

**Документ:** `ТЕСТ-КЕЙСЫ.md`

**Формат:**
```markdown
### TC-001: Создание трека

**Приоритет:** Высокий
**Тип:** Функциональный тест

**Предусловия:**
- Пользователь авторизован
- Пользователь имеет роль "артист" или "дистрибьютор"
- Альбом существует

**Шаги:**
1. Открыть форму загрузки трека
2. Заполнить поля: название, длительность, альбом
3. Выбрать аудио файл
4. Нажать кнопку "Загрузить"

**Ожидаемый результат:**
- Трек создан успешно
- Трек отображается в списке треков
- Аудио файл загружен в Storage

**Фактический результат:**
[Заполняется при выполнении теста]

**Статус:** [Pass/Fail]
```

### 2. Выполнение тестирования

#### Запуск тестов

```bash
# Unit-тесты
npm test

# Интеграционные тесты
npm run test:integration

# E2E тесты
npm run test:e2e

# Нагрузочные тесты
npm run test:load

# Все тесты
npm run test:all
```

#### Журнал прогонов

**Документ:** `ЖУРНАЛ_ПРОГОНОВ.md`

**Формат:**
```markdown
## Прогон #1

**Дата:** 2025-02-01
**Время:** 10:00-12:00
**Тестировщик:** [Имя]

### Результаты:

| Тест-кейс | Статус | Время | Примечания |
|-----------|--------|-------|------------|
| TC-001 | Pass | 5s | - |
| TC-002 | Pass | 3s | - |
| TC-003 | Fail | 10s | Ошибка валидации |
| TC-004 | Pass | 2s | - |

### Обнаруженные проблемы:

1. **Проблема #1:** Ошибка валидации при создании трека
   - **Описание:** Трек не создаётся при пустом названии
   - **Приоритет:** Высокий
   - **Статус:** Открыта
```

### 3. Отчётность

#### Отчёт о дефектах

**Документ:** `ОТЧЁТ_О_ДЕФЕКТАХ.md`

**Формат:**
```markdown
## Дефект #1

**ID:** DEF-001
**Название:** Ошибка валидации при создании трека
**Приоритет:** Высокий
**Статус:** Открыта
**Найдено:** 2025-02-01
**Нашёл:** [Имя тестировщика]

**Описание:**
При попытке создать трек с пустым названием система не показывает ошибку валидации.

**Шаги воспроизведения:**
1. Открыть форму загрузки трека
2. Оставить поле "Название" пустым
3. Заполнить остальные поля
4. Нажать кнопку "Загрузить"

**Ожидаемое поведение:**
Система должна показать ошибку валидации "Название обязательно для заполнения".

**Фактическое поведение:**
Система пытается создать трек, но запрос fails с ошибкой БД.

**Окружение:**
- Браузер: Chrome 120
- ОС: Windows 10
- Версия приложения: 1.0.0

**Скриншоты:**
[Ссылки на скриншоты]

**Логи:**
```
Error: new row for relation "tracks" violates check constraint "tracks_track_title_check"
```

**Исправление:**
[Заполняется разработчиком]
```

#### Итоговый отчёт

**Документ:** `ИТОГОВЫЙ_ОТЧЁТ_О_ТЕСТИРОВАНИИ.md`

**Содержимое:**
- Общая информация о тестировании
- Статистика тестирования
- Обнаруженные проблемы
- Рекомендации
- Заключение

---

## Автоматизация тестирования

### CI/CD интеграция

#### GitHub Actions

**Файл:** `.github/workflows/test.yml`

```yaml
name: Tests

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  test:
    runs-on: ubuntu-latest
    
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: imperial_tunes_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
    
    steps:
      - uses: actions/checkout@v3
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Run unit tests
        run: npm test
      
      - name: Run integration tests
        run: npm run test:integration
        env:
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/imperial_tunes_test
      
      - name: Generate coverage report
        run: npm run test:coverage
      
      - name: Upload coverage to Coveralls
        uses: coverallsapp/github-action@master
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
```

#### GitLab CI

**Файл:** `.gitlab-ci.yml`

```yaml
stages:
  - test

unit-tests:
  stage: test
  image: node:18
  script:
    - npm ci
    - npm test
    - npm run test:coverage
  coverage: '/Lines\s*:\s*(\d+\.\d+)%/'
  artifacts:
    reports:
      coverage_report:
        coverage_format: cobertura
        path: coverage/cobertura-coverage.xml

integration-tests:
  stage: test
  image: node:18
  services:
    - postgres:15
  variables:
    POSTGRES_DB: imperial_tunes_test
    POSTGRES_USER: postgres
    POSTGRES_PASSWORD: postgres
    DATABASE_URL: postgresql://postgres:postgres@postgres:5432/imperial_tunes_test
  script:
    - npm ci
    - npm run test:integration
  artifacts:
    when: always
    paths:
      - test-results/
    reports:
      junit: test-results/junit.xml

e2e-tests:
  stage: test
  image: mcr.microsoft.com/playwright:v1.40.0-focal
  script:
    - npm ci
    - npx playwright install --with-deps
    - npm run test:e2e
  artifacts:
    when: always
    paths:
      - test-results/
      - playwright-report/
```

---

## Отчётность

### Метрики тестирования

#### Покрытие кода

**Целевое покрытие:**
- **Unit-тесты:** 80%+
- **Интеграционные тесты:** 60%+
- **E2E тесты:** 40%+

**Отчёт о покрытии:**
```markdown
## Покрытие кода

**Дата:** 2025-02-01
**Версия:** 1.0.0

### Общее покрытие: 75.5%

| Файл | Statements | Branches | Functions | Lines |
|------|------------|----------|-----------|-------|
| utils.ts | 90.0% | 85.0% | 95.0% | 90.0% |
| player.ts | 65.0% | 55.0% | 60.0% | 65.0% |
| api.ts | 80.0% | 75.0% | 85.0% | 80.0% |

### Рекомендации:

1. Увеличить покрытие player.ts до 80%+
2. Добавить тесты для edge cases
3. Увеличить покрытие branches
```

#### Результаты тестирования

**Отчёт о результатах:**
```markdown
## Результаты тестирования

**Дата:** 2025-02-01
**Версия:** 1.0.0

### Статистика:

- **Всего тестов:** 150
- **Пройдено:** 145
- **Провалено:** 5
- **Пропущено:** 0
- **Успешность:** 96.7%

### Результаты по типам тестов:

| Тип теста | Всего | Пройдено | Провалено | Успешность |
|-----------|-------|----------|-----------|------------|
| Unit-тесты | 100 | 98 | 2 | 98.0% |
| Интеграционные | 30 | 28 | 2 | 93.3% |
| E2E тесты | 20 | 19 | 1 | 95.0% |

### Обнаруженные проблемы:

1. **DEF-001:** Ошибка валидации при создании трека (Приоритет: Высокий)
2. **DEF-002:** Медленная загрузка списка треков (Приоритет: Средний)
3. **DEF-003:** Ошибка при удалении плейлиста (Приоритет: Низкий)
```

---

## Чеклист тестирования

- [x] Пирамида тестов определена
- [x] Инструменты тестирования выбраны и настроены
- [x] Метрики качества определены
- [x] Стратегия тестирования разработана
- [x] Процесс тестирования документирован
- [x] Автоматизация тестирования настроена
- [x] Отчётность настроена

