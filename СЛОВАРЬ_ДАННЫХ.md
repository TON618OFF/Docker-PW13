# СЛОВАРЬ ДАННЫХ
## Проект: Imperial Tunes (SoundWeave DB)

**Версия документа:** 1.0  
**Дата создания:** 2025-01-30  
**База данных:** PostgreSQL (Supabase)  
**Версия БД:** 6.0

---

## ОГЛАВЛЕНИЕ

1. [Таблица: roles (Роли)](#таблица-roles-роли)
2. [Таблица: users (Пользователи)](#таблица-users-пользователи)
3. [Таблица: artists (Артисты)](#таблица-artists-артисты)
4. [Таблица: genres (Жанры)](#таблица-genres-жанры)
5. [Таблица: albums (Альбомы)](#таблица-albums-альбомы)
6. [Таблица: tracks (Треки)](#таблица-tracks-треки)
7. [Таблица: playlists (Плейлисты)](#таблица-playlists-плейлисты)
8. [Таблица: track_genres (Связь Трек-Жанр)](#таблица-track_genres-связь-трек-жанр)
9. [Таблица: playlist_tracks (Связь Плейлист-Трек)](#таблица-playlist_tracks-связь-плейлист-трек)
10. [Таблица: listening_history (История прослушиваний)](#таблица-listening_history-история-прослушиваний)
11. [Таблица: audit_log (Лог аудита)](#таблица-audit_log-лог-аудита)
12. [Таблица: favorites_tracks (Избранные треки)](#таблица-favorites_tracks-избранные-треки)
13. [Таблица: favorites_albums (Избранные альбомы)](#таблица-favorites_albums-избранные-альбомы)
14. [Таблица: favorites_playlists (Избранные плейлисты)](#таблица-favorites_playlists-избранные-плейлисты)
15. [Таблица: artist_applications (Анкеты артистов)](#таблица-artist_applications-анкеты-артистов)

---

## ТАБЛИЦА: roles (Роли)

| Атрибут | Тип данных | Ограничения | Комментарий |
|---------|------------|-------------|-------------|
| id | UUID | PRIMARY KEY, DEFAULT uuid_generate_v4() | Уникальный идентификатор роли |
| role_name | VARCHAR(50) | NOT NULL, UNIQUE, CHECK (role_name IN ('слушатель', 'администратор', 'артист', 'дистрибьютор', 'модератор')) | Название роли. Допустимые значения: 'слушатель', 'администратор', 'артист', 'дистрибьютор', 'модератор' |
| role_description | TEXT | NULL | Описание роли и её прав доступа |
| created_at | TIMESTAMPTZ | NOT NULL, DEFAULT now() | Дата и время создания записи |
| updated_at | TIMESTAMPTZ | NOT NULL, DEFAULT now() | Дата и время последнего обновления записи (обновляется триггером) |

---

## ТАБЛИЦА: users (Пользователи)

| Атрибут | Тип данных | Ограничения | Комментарий |
|---------|------------|-------------|-------------|
| id | UUID | PRIMARY KEY, REFERENCES auth.users(id) ON DELETE CASCADE | Уникальный идентификатор пользователя. Связь с auth.users из Supabase Authentication |
| username | VARCHAR(50) | NOT NULL, UNIQUE, CHECK (LENGTH(username) >= 3 AND LENGTH(username) <= 50) | Имя пользователя. Длина от 3 до 50 символов. Должно быть уникальным |
| first_name | VARCHAR(50) | NULL | Имя пользователя |
| last_name | VARCHAR(50) | NULL | Фамилия пользователя |
| role_id | UUID | REFERENCES public.roles(id) ON DELETE RESTRICT | Идентификатор роли пользователя. При удалении роли операция запрещена (RESTRICT) |
| avatar_url | TEXT | NULL | URL аватара пользователя в Storage bucket 'avatars' |
| bio | TEXT | NULL | Биография пользователя |
| language | VARCHAR(10) | NOT NULL, DEFAULT 'ru', CHECK (language IN ('ru', 'en')) | Язык интерфейса пользователя. Допустимые значения: 'ru', 'en' |
| is_active | BOOLEAN | NOT NULL, DEFAULT TRUE | Статус активности аккаунта. FALSE - аккаунт деактивирован |
| created_at | TIMESTAMPTZ | NOT NULL, DEFAULT now() | Дата и время создания аккаунта |
| updated_at | TIMESTAMPTZ | NOT NULL, DEFAULT now() | Дата и время последнего обновления (обновляется триггером) |
| last_login | TIMESTAMPTZ | NULL | Дата и время последнего входа в систему |

**Индексы:**
- idx_users_username - индекс по username для быстрого поиска
- idx_users_role - индекс по role_id для фильтрации по ролям
- idx_users_last_login - индекс по last_login для сортировки по активности
- idx_users_created_at - индекс по created_at для сортировки по дате регистрации

---

## ТАБЛИЦА: artists (Артисты)

| Атрибут | Тип данных | Ограничения | Комментарий |
|---------|------------|-------------|-------------|
| id | UUID | PRIMARY KEY, DEFAULT uuid_generate_v4() | Уникальный идентификатор артиста |
| artist_name | VARCHAR(100) | NOT NULL, UNIQUE, CHECK (LENGTH(artist_name) >= 2 AND LENGTH(artist_name) <= 100) | Название артиста или группы. Длина от 2 до 100 символов. Должно быть уникальным |
| artist_bio | TEXT | NULL | Биография артиста |
| artist_image_url | TEXT | NULL | URL изображения артиста в Storage bucket 'covers' |
| genre | VARCHAR(50) | NULL | Основной жанр артиста (текстовое поле, не связано с таблицей genres) |
| user_id | UUID | REFERENCES public.users(id) ON DELETE SET NULL | Идентификатор пользователя-артиста. При удалении пользователя устанавливается NULL |
| created_at | TIMESTAMPTZ | NOT NULL, DEFAULT now() | Дата и время создания записи |
| updated_at | TIMESTAMPTZ | NOT NULL, DEFAULT now() | Дата и время последнего обновления (обновляется триггером) |

**Индексы:**
- idx_artists_user - индекс по user_id для связи с пользователем

---

## ТАБЛИЦА: genres (Жанры)

| Атрибут | Тип данных | Ограничения | Комментарий |
|---------|------------|-------------|-------------|
| id | UUID | PRIMARY KEY, DEFAULT uuid_generate_v4() | Уникальный идентификатор жанра |
| genre_name | VARCHAR(50) | NOT NULL, UNIQUE, CHECK (LENGTH(genre_name) >= 2 AND LENGTH(genre_name) <= 50) | Название жанра. Длина от 2 до 50 символов. Должно быть уникальным |
| genre_description | TEXT | NULL | Описание жанра |
| is_active | BOOLEAN | NOT NULL, DEFAULT TRUE | Статус активности жанра. FALSE - жанр скрыт |
| created_at | TIMESTAMPTZ | NOT NULL, DEFAULT now() | Дата и время создания записи |
| updated_at | TIMESTAMPTZ | NOT NULL, DEFAULT now() | Дата и время последнего обновления (обновляется триггером) |

---

## ТАБЛИЦА: albums (Альбомы)

| Атрибут | Тип данных | Ограничения | Комментарий |
|---------|------------|-------------|-------------|
| id | UUID | PRIMARY KEY, DEFAULT uuid_generate_v4() | Уникальный идентификатор альбома |
| album_title | VARCHAR(100) | NOT NULL, CHECK (LENGTH(album_title) >= 2 AND LENGTH(album_title) <= 100) | Название альбома. Длина от 2 до 100 символов |
| album_release_date | DATE | NOT NULL, CHECK (album_release_date >= '1900-01-01' AND album_release_date <= CURRENT_DATE + INTERVAL '1 year') | Дата релиза альбома. Диапазон: от 1900-01-01 до текущей даты + 1 год |
| artist_id | UUID | REFERENCES public.artists(id) ON DELETE CASCADE | Идентификатор артиста. При удалении артиста альбом удаляется (CASCADE) |
| created_by | UUID | REFERENCES public.users(id) ON DELETE SET NULL | Идентификатор пользователя, создавшего альбом. При удалении пользователя устанавливается NULL |
| album_cover_url | TEXT | NULL | URL обложки альбома в Storage bucket 'covers' |
| album_description | TEXT | NULL | Описание альбома |
| is_public | BOOLEAN | NOT NULL, DEFAULT TRUE | Статус публичности альбома. TRUE - публичный, FALSE - приватный |
| is_active | BOOLEAN | NOT NULL, DEFAULT TRUE | Статус активности альбома. FALSE - альбом скрыт |
| created_at | TIMESTAMPTZ | NOT NULL, DEFAULT now() | Дата и время создания записи |
| updated_at | TIMESTAMPTZ | NOT NULL, DEFAULT now() | Дата и время последнего обновления (обновляется триггером) |

**Индексы:**
- idx_albums_created_by - индекс по created_by для поиска альбомов пользователя
- idx_albums_artist - индекс по artist_id для поиска альбомов артиста

---

## ТАБЛИЦА: tracks (Треки)

| Атрибут | Тип данных | Ограничения | Комментарий |
|---------|------------|-------------|-------------|
| id | UUID | PRIMARY KEY, DEFAULT uuid_generate_v4() | Уникальный идентификатор трека |
| track_title | VARCHAR(100) | NOT NULL, CHECK (LENGTH(track_title) >= 1 AND LENGTH(track_title) <= 100) | Название трека. Длина от 1 до 100 символов |
| track_duration | INTEGER | NOT NULL, CHECK (track_duration > 0 AND track_duration <= 7200) | Длительность трека в секундах. Диапазон: от 1 до 7200 секунд (2 часа) |
| album_id | UUID | REFERENCES public.albums(id) ON DELETE CASCADE | Идентификатор альбома. При удалении альбома трек удаляется (CASCADE) |
| track_audio_url | TEXT | NOT NULL | URL аудио файла в Storage bucket 'songs' |
| track_order | INTEGER | NOT NULL, DEFAULT 1, CHECK (track_order > 0) | Порядковый номер трека в альбоме. Должен быть больше 0 |
| track_play_count | INTEGER | NOT NULL, DEFAULT 0, CHECK (track_play_count >= 0) | Количество прослушиваний трека. Обновляется триггером listening_history_trigger |
| track_like_count | INTEGER | NOT NULL, DEFAULT 0, CHECK (track_like_count >= 0) | Количество лайков трека. Обновляется при добавлении/удалении из избранного |
| is_public | BOOLEAN | NOT NULL, DEFAULT TRUE | Статус публичности трека. TRUE - публичный, FALSE - приватный |
| uploaded_by | UUID | REFERENCES public.users(id) ON DELETE SET NULL | Идентификатор пользователя, загрузившего трек. При удалении пользователя устанавливается NULL |
| created_at | TIMESTAMPTZ | NOT NULL, DEFAULT now() | Дата и время создания записи |
| updated_at | TIMESTAMPTZ | NOT NULL, DEFAULT now() | Дата и время последнего обновления (обновляется триггером) |

**Индексы:**
- idx_tracks_album - индекс по album_id для поиска треков альбома
- idx_tracks_play_count - индекс по track_play_count DESC для топ-чартов
- idx_tracks_like_count - индекс по track_like_count DESC для популярных треков
- idx_tracks_created_at - индекс по created_at для новых треков
- idx_tracks_is_public - индекс по is_public для фильтрации публичных треков
- idx_tracks_uploaded_by - индекс по uploaded_by для поиска треков пользователя

---

## ТАБЛИЦА: playlists (Плейлисты)

| Атрибут | Тип данных | Ограничения | Комментарий |
|---------|------------|-------------|-------------|
| id | UUID | PRIMARY KEY, DEFAULT uuid_generate_v4() | Уникальный идентификатор плейлиста |
| playlist_title | VARCHAR(100) | NOT NULL, CHECK (LENGTH(playlist_title) >= 2 AND LENGTH(playlist_title) <= 100) | Название плейлиста. Длина от 2 до 100 символов |
| playlist_description | TEXT | NULL | Описание плейлиста |
| user_id | UUID | REFERENCES public.users(id) ON DELETE CASCADE | Идентификатор владельца плейлиста. При удалении пользователя плейлист удаляется (CASCADE) |
| playlist_cover_url | TEXT | NULL | URL обложки плейлиста в Storage bucket 'covers' |
| is_public | BOOLEAN | NOT NULL, DEFAULT FALSE | Статус публичности плейлиста. По умолчанию приватный |
| is_active | BOOLEAN | NOT NULL, DEFAULT TRUE | Статус активности плейлиста. FALSE - плейлист скрыт |
| follow_count | INTEGER | NOT NULL, DEFAULT 0, CHECK (follow_count >= 0) | Количество подписчиков плейлиста. Должно быть неотрицательным |
| created_at | TIMESTAMPTZ | NOT NULL, DEFAULT now() | Дата и время создания плейлиста |
| updated_at | TIMESTAMPTZ | NOT NULL, DEFAULT now() | Дата и время последнего обновления (обновляется триггером) |

**Индексы:**
- idx_playlists_user - индекс по user_id для поиска плейлистов пользователя
- idx_playlists_is_public - индекс по is_public для фильтрации публичных плейлистов
- idx_playlists_follow_count - индекс по follow_count DESC для популярных плейлистов
- idx_playlists_created_at - индекс по created_at для сортировки по дате

---

## ТАБЛИЦА: track_genres (Связь Трек-Жанр)

| Атрибут | Тип данных | Ограничения | Комментарий |
|---------|------------|-------------|-------------|
| id | UUID | PRIMARY KEY, DEFAULT uuid_generate_v4() | Уникальный идентификатор связи |
| track_id | UUID | NOT NULL, REFERENCES public.tracks(id) ON DELETE CASCADE, UNIQUE (track_id, genre_id) | Идентификатор трека. При удалении трека связь удаляется (CASCADE). Уникальная комбинация с genre_id |
| genre_id | UUID | NOT NULL, REFERENCES public.genres(id) ON DELETE CASCADE, UNIQUE (track_id, genre_id) | Идентификатор жанра. При удалении жанра связь удаляется (CASCADE). Уникальная комбинация с track_id |
| created_at | TIMESTAMPTZ | NOT NULL, DEFAULT now() | Дата и время создания связи |

**Описание:** Таблица связи "многие-ко-многим" между треками и жанрами. Один трек может иметь несколько жанров, один жанр может быть у нескольких треков.

---

## ТАБЛИЦА: playlist_tracks (Связь Плейлист-Трек)

| Атрибут | Тип данных | Ограничения | Комментарий |
|---------|------------|-------------|-------------|
| id | UUID | PRIMARY KEY, DEFAULT uuid_generate_v4() | Уникальный идентификатор связи |
| playlist_id | UUID | NOT NULL, REFERENCES public.playlists(id) ON DELETE CASCADE, UNIQUE (playlist_id, track_id) | Идентификатор плейлиста. При удалении плейлиста связь удаляется (CASCADE). Уникальная комбинация с track_id |
| track_id | UUID | NOT NULL, REFERENCES public.tracks(id) ON DELETE CASCADE, UNIQUE (playlist_id, track_id) | Идентификатор трека. При удалении трека связь удаляется (CASCADE). Уникальная комбинация с playlist_id |
| order_position | INTEGER | NOT NULL, CHECK (order_position > 0) | Порядковая позиция трека в плейлисте. Должна быть больше 0 |
| added_at | TIMESTAMPTZ | NOT NULL, DEFAULT now() | Дата и время добавления трека в плейлист |

**Описание:** Таблица связи "многие-ко-многим" между плейлистами и треками. Один плейлист может содержать несколько треков, один трек может быть в нескольких плейлистах. Порядок треков определяется полем order_position.

---

## ТАБЛИЦА: listening_history (История прослушиваний)

| Атрибут | Тип данных | Ограничения | Комментарий |
|---------|------------|-------------|-------------|
| id | UUID | PRIMARY KEY, DEFAULT uuid_generate_v4() | Уникальный идентификатор записи истории |
| user_id | UUID | NOT NULL, REFERENCES public.users(id) ON DELETE CASCADE | Идентификатор пользователя. При удалении пользователя история удаляется (CASCADE) |
| track_id | UUID | NOT NULL, REFERENCES public.tracks(id) ON DELETE CASCADE | Идентификатор трека. При удалении трека запись удаляется (CASCADE) |
| listened_at | TIMESTAMPTZ | NOT NULL, DEFAULT now() | Дата и время прослушивания трека |
| duration_played | INTEGER | NULL, CHECK (duration_played >= 0) | Длительность прослушивания в секундах. Может быть NULL, если не отслеживается. Должна быть неотрицательной |
| completed | BOOLEAN | DEFAULT FALSE | Признак завершения прослушивания трека. TRUE - трек прослушан полностью |

**Индексы:**
- idx_listening_user - индекс по user_id для истории пользователя
- idx_listening_track - индекс по track_id для статистики трека
- idx_listening_date - индекс по listened_at для временной сортировки
- idx_listening_user_date - составной индекс по (user_id, listened_at) для оптимизации запросов истории

**Триггеры:**
- listening_history_trigger - автоматически увеличивает track_play_count при добавлении записи в историю

---

## ТАБЛИЦА: audit_log (Лог аудита)

| Атрибут | Тип данных | Ограничения | Комментарий |
|---------|------------|-------------|-------------|
| id | UUID | PRIMARY KEY, DEFAULT uuid_generate_v4() | Уникальный идентификатор записи аудита |
| user_id | UUID | NULL, REFERENCES public.users(id) ON DELETE SET NULL | Идентификатор пользователя, выполнившего действие. При удалении пользователя устанавливается NULL |
| action_type | VARCHAR(100) | NOT NULL, CHECK (action_type IN ('INSERT', 'UPDATE', 'DELETE', 'SELECT', 'LOGIN', 'LOGOUT')) | Тип действия. Допустимые значения: 'INSERT', 'UPDATE', 'DELETE', 'SELECT', 'LOGIN', 'LOGOUT' |
| table_name | VARCHAR(50) | NOT NULL, CHECK (table_name IN ('users', 'artists', 'albums', 'tracks', 'playlists', 'track_genres', 'playlist_tracks', 'listening_history', 'genres', 'artist_applications')) | Имя таблицы, над которой выполнено действие |
| record_id | UUID | NULL | Идентификатор записи, над которой выполнено действие |
| old_value | JSONB | NULL | Старое значение записи в формате JSONB (для UPDATE и DELETE) |
| new_value | JSONB | NULL | Новое значение записи в формате JSONB (для INSERT и UPDATE) |
| timestamp | TIMESTAMPTZ | NOT NULL, DEFAULT now() | Дата и время выполнения действия |

**Индексы:**
- idx_audit_user - индекс по user_id для аудита действий пользователя
- idx_audit_table - индекс по table_name для фильтрации по таблицам
- idx_audit_timestamp - индекс по timestamp для временной сортировки
- idx_audit_action - индекс по action_type для фильтрации по типам действий

**Триггеры:**
- audit_tracks_trigger - автоматически создаёт записи аудита при изменении таблицы tracks
- audit_playlists_trigger - автоматически создаёт записи аудита при изменении таблицы playlists

---

## ТАБЛИЦА: favorites_tracks (Избранные треки)

| Атрибут | Тип данных | Ограничения | Комментарий |
|---------|------------|-------------|-------------|
| id | UUID | PRIMARY KEY, DEFAULT uuid_generate_v4() | Уникальный идентификатор записи |
| user_id | UUID | NOT NULL, REFERENCES public.users(id) ON DELETE CASCADE, UNIQUE (user_id, track_id) | Идентификатор пользователя. При удалении пользователя записи удаляются (CASCADE). Уникальная комбинация с track_id |
| track_id | UUID | NOT NULL, REFERENCES public.tracks(id) ON DELETE CASCADE, UNIQUE (user_id, track_id) | Идентификатор трека. При удалении трека запись удаляется (CASCADE). Уникальная комбинация с user_id |
| created_at | TIMESTAMPTZ | NOT NULL, DEFAULT now() | Дата и время добавления трека в избранное |

**Описание:** Таблица избранных треков пользователей. Один пользователь может добавить трек в избранное только один раз (уникальная комбинация user_id + track_id).

**Индексы:**
- idx_favorites_tracks_user - индекс по user_id для избранных треков пользователя
- idx_favorites_tracks_track - индекс по track_id для статистики трека

**Функции:**
- toggle_favorite_track(p_track_id UUID) - добавляет/удаляет трек из избранного

---

## ТАБЛИЦА: favorites_albums (Избранные альбомы)

| Атрибут | Тип данных | Ограничения | Комментарий |
|---------|------------|-------------|-------------|
| id | UUID | PRIMARY KEY, DEFAULT uuid_generate_v4() | Уникальный идентификатор записи |
| user_id | UUID | NOT NULL, REFERENCES public.users(id) ON DELETE CASCADE, UNIQUE (user_id, album_id) | Идентификатор пользователя. При удалении пользователя записи удаляются (CASCADE). Уникальная комбинация с album_id |
| album_id | UUID | NOT NULL, REFERENCES public.albums(id) ON DELETE CASCADE, UNIQUE (user_id, album_id) | Идентификатор альбома. При удалении альбома запись удаляется (CASCADE). Уникальная комбинация с user_id |
| created_at | TIMESTAMPTZ | NOT NULL, DEFAULT now() | Дата и время добавления альбома в избранное |

**Описание:** Таблица избранных альбомов пользователей. Один пользователь может добавить альбом в избранное только один раз (уникальная комбинация user_id + album_id).

**Индексы:**
- idx_favorites_albums_user - индекс по user_id для избранных альбомов пользователя
- idx_favorites_albums_album - индекс по album_id для статистики альбома

**Функции:**
- toggle_favorite_album(p_album_id UUID) - добавляет/удаляет альбом из избранного

---

## ТАБЛИЦА: favorites_playlists (Избранные плейлисты)

| Атрибут | Тип данных | Ограничения | Комментарий |
|---------|------------|-------------|-------------|
| id | UUID | PRIMARY KEY, DEFAULT uuid_generate_v4() | Уникальный идентификатор записи |
| user_id | UUID | NOT NULL, REFERENCES public.users(id) ON DELETE CASCADE, UNIQUE (user_id, playlist_id) | Идентификатор пользователя. При удалении пользователя записи удаляются (CASCADE). Уникальная комбинация с playlist_id |
| playlist_id | UUID | NOT NULL, REFERENCES public.playlists(id) ON DELETE CASCADE, UNIQUE (user_id, playlist_id) | Идентификатор плейлиста. При удалении плейлиста запись удаляется (CASCADE). Уникальная комбинация с user_id |
| created_at | TIMESTAMPTZ | NOT NULL, DEFAULT now() | Дата и время добавления плейлиста в избранное |

**Описание:** Таблица избранных плейлистов пользователей. Один пользователь может добавить плейлист в избранное только один раз (уникальная комбинация user_id + playlist_id).

**Индексы:**
- idx_favorites_playlists_user - индекс по user_id для избранных плейлистов пользователя
- idx_favorites_playlists_playlist - индекс по playlist_id для статистики плейлиста

**Функции:**
- toggle_favorite_playlist(p_playlist_id UUID) - добавляет/удаляет плейлист из избранного

---

## ТАБЛИЦА: artist_applications (Анкеты артистов)

| Атрибут | Тип данных | Ограничения | Комментарий |
|---------|------------|-------------|-------------|
| id | UUID | PRIMARY KEY, DEFAULT uuid_generate_v4() | Уникальный идентификатор анкеты |
| user_id | UUID | NOT NULL, REFERENCES public.users(id) ON DELETE CASCADE | Идентификатор пользователя-заявителя. При удалении пользователя анкета удаляется (CASCADE) |
| artist_name | VARCHAR(100) | NOT NULL, CHECK (LENGTH(artist_name) >= 2 AND LENGTH(artist_name) <= 100) | Предполагаемое имя артиста/группы. Длина от 2 до 100 символов |
| artist_bio | TEXT | NULL | Биография артиста |
| artist_image_url | TEXT | NULL | URL изображения артиста в Storage bucket 'covers' |
| genre | VARCHAR(50) | NULL | Основной жанр артиста (текстовое поле) |
| portfolio_url | TEXT | NULL | URL портфолио артиста |
| social_media_urls | JSONB | NULL | Социальные сети в формате JSON. Пример: {"instagram": "url", "youtube": "url"} |
| motivation | TEXT | NULL | Мотивационное письмо артиста |
| status | VARCHAR(20) | NOT NULL, DEFAULT 'pending', CHECK (status IN ('pending', 'approved', 'rejected')) | Статус анкеты. Допустимые значения: 'pending' (на рассмотрении), 'approved' (одобрена), 'rejected' (отклонена) |
| reviewed_by | UUID | NULL, REFERENCES public.users(id) ON DELETE SET NULL | Идентификатор дистрибьютора, рассмотревшего анкету. При удалении пользователя устанавливается NULL |
| review_comment | TEXT | NULL | Комментарий дистрибьютора при рассмотрении анкеты |
| reviewed_at | TIMESTAMPTZ | NULL | Дата и время рассмотрения анкеты |
| created_at | TIMESTAMPTZ | NOT NULL, DEFAULT now() | Дата и время создания анкеты |
| updated_at | TIMESTAMPTZ | NOT NULL, DEFAULT now() | Дата и время последнего обновления (обновляется триггером) |

**Индексы:**
- idx_artist_applications_user - индекс по user_id для заявок пользователя
- idx_artist_applications_status - индекс по status для фильтрации по статусам
- idx_artist_applications_reviewed_by - индекс по reviewed_by для работы дистрибьюторов

**Функции:**
- approve_artist_application(p_application_id UUID) - одобряет анкету, создаёт артиста и обновляет роль пользователя
- reject_artist_application(p_application_id UUID, p_comment TEXT) - отклоняет анкету с комментарием

---

## ОСОБЫЕ ТИПЫ ДАННЫХ

### ENUM: app_role

**Описание:** Тип перечисления для ролей пользователей

**Значения:**
- 'слушатель'
- 'администратор'
- 'артист'
- 'дистрибьютор'
- 'модератор'

### ENUM: audio_format

**Описание:** Тип перечисления для форматов аудио файлов

**Значения:**
- 'mp3'
- 'wav'
- 'flac'
- 'ogg'
- 'm4a'

---

## STORAGE BUCKETS (Supabase Storage)

### Bucket: songs

**Описание:** Хранилище аудио файлов

| Параметр | Значение | Комментарий |
|----------|----------|-------------|
| id | 'songs' | Идентификатор bucket |
| public | FALSE | Приватный bucket (требуется аутентификация) |
| file_size_limit | 52428800 (50 MB) | Максимальный размер файла в байтах |
| allowed_mime_types | ['audio/mpeg', 'audio/wav', 'audio/flac', 'audio/ogg', 'audio/mp4'] | Разрешенные MIME-типы файлов |

### Bucket: covers

**Описание:** Хранилище обложек альбомов, артистов и плейлистов

| Параметр | Значение | Комментарий |
|----------|----------|-------------|
| id | 'covers' | Идентификатор bucket |
| public | TRUE | Публичный bucket (доступен без аутентификации) |
| file_size_limit | 5242880 (5 MB) | Максимальный размер файла в байтах |
| allowed_mime_types | ['image/jpeg', 'image/png', 'image/webp'] | Разрешенные MIME-типы файлов |

### Bucket: avatars

**Описание:** Хранилище аватаров пользователей

| Параметр | Значение | Комментарий |
|----------|----------|-------------|
| id | 'avatars' | Идентификатор bucket |
| public | TRUE | Публичный bucket (доступен без аутентификации) |
| file_size_limit | 5242880 (5 MB) | Максимальный размер файла в байтах |
| allowed_mime_types | ['image/jpeg', 'image/jpg', 'image/png', 'image/webp'] | Разрешенные MIME-типы файлов |

---

## ПРЕДСТАВЛЕНИЯ (VIEWS)

### Представление: album_duration

**Описание:** Вычисляет общую длительность альбомов и количество треков

**Поля:**
- id, album_title, artist_id, artist_name, album_release_date - из таблицы albums
- total_duration_seconds - сумма длительности всех треков альбома
- track_count - количество треков в альбоме
- created_at, updated_at - из таблицы albums

**Условие:** Только активные альбомы (is_active = TRUE)

### Представление: playlist_duration

**Описание:** Вычисляет общую длительность плейлистов и количество треков

**Поля:**
- id, playlist_title, user_id, username, is_public, follow_count - из таблицы playlists
- total_duration_seconds - сумма длительности всех треков плейлиста
- track_count - количество треков в плейлисте
- created_at, updated_at - из таблицы playlists

**Условие:** Только активные плейлисты (is_active = TRUE)

### Представление: user_statistics

**Описание:** Статистика пользователей

**Поля:**
- id, username, email, role_name, created_at, last_login - из таблицы users
- playlist_count - количество созданных плейлистов
- total_listens - общее количество прослушиваний
- unique_tracks_listened - количество уникальных прослушанных треков

### Представление: track_statistics

**Описание:** Статистика треков с уровнем популярности

**Поля:**
- id, track_title, track_duration, track_play_count, track_like_count - из таблицы tracks
- album_title, artist_name - из связанных таблиц
- created_at, is_public - из таблицы tracks
- popularity_level - вычисляемое поле ('Новый', 'Средний', 'Популярный') на основе track_play_count

---

## ОБЩИЕ ПРИНЦИПЫ

### Временные метки

Все таблицы содержат поля `created_at` и `updated_at` типа TIMESTAMPTZ:
- `created_at` - устанавливается автоматически при создании записи (DEFAULT now())
- `updated_at` - обновляется триггером `update_updated_at_column` при изменении записи

### Уникальные идентификаторы

Все таблицы используют UUID в качестве первичного ключа:
- Генерируется автоматически через `uuid_generate_v4()`
- Обеспечивает глобальную уникальность

### Внешние ключи

Все внешние ключи имеют политики каскадного удаления:
- `ON DELETE CASCADE` - при удалении родительской записи удаляются связанные
- `ON DELETE SET NULL` - при удалении родительской записи поле устанавливается в NULL
- `ON DELETE RESTRICT` - при удалении родительской записи операция запрещена

### Row Level Security (RLS)

Все таблицы имеют включенную систему безопасности на уровне строк (RLS):
- Пользователи видят только свои данные или публичные данные
- Администраторы и дистрибьюторы имеют расширенные права доступа
- Политики безопасности определены для каждой таблицы

---

**Дата создания документа**: 2025-01-30  
**Версия БД**: 6.0  
**База данных**: Supabase (PostgreSQL 15+)  
**СУБД**: PostgreSQL

