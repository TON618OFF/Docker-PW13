# 2. ОБЩАЯ ЧАСТЬ

## 2.1. Постановка задачи

Разработка музыкального онлайн-портала ImperialTunes предусматривает создание защищённой клиент-серверной информационной системы для управления музыкальным контентом на основе облачной платформы Supabase. Система обеспечивает функциональность, аналогичную современным музыкальным платформам (Spotify, VK Music, Apple Music), с акцентом на безопасность данных и аналитику пользовательской активности. Основные задачи включают:

• **Проектирование и реализация реляционной базы данных** на основе PostgreSQL через Supabase с поддержкой CRUD-операций, связей между сущностями (1:1, 1:M, M:M), ограничений целостности данных (NOT NULL, UNIQUE, CHECK), внешних ключей с каскадным удалением и ENUM типов для валидации доменов.

• **Реализация серверной логики** с использованием хранимых функций PostgreSQL (например, `toggle_favorite_track`, `approve_artist_application`, `log_listening`), триггеров для автоматизации операций (создание профиля пользователя, обновление метаданных, аудит изменений) и транзакций для обеспечения атомарности бизнес-операций.

• **Обеспечение безопасности данных** через ролевую модель доступа (RBAC) с пятью ролями, Row Level Security (RLS) политики для изоляции данных пользователей, автоматическое хэширование паролей через Supabase Authentication и систему аудита действий пользователей через таблицу `audit_log` с сохранением состояния данных до и после изменений.

• **Разработка клиентского приложения** с использованием Supabase Client API (JavaScript/TypeScript) для взаимодействия с базой данных и Storage API для загрузки/воспроизведения аудиофайлов и изображений, обеспечивая реактивность через React Query для кэширования и синхронизации данных.

• **Создание адаптивного веб-интерфейса** на основе React 18 с TypeScript и Vite, использующего имперскую цветовую палитру (чёрный фон, золотые и оранжевые акценты) с поддержкой темной и светлой темы, компонентной архитектуры на базе Radix UI и стилизацией через Tailwind CSS для обеспечения отзывчивости на разных устройствах (мобильные, планшеты, десктопы).

• **Реализация подсистемы аналитики** с возможностью формирования отчётов и визуализаций через библиотеку Recharts (графики прослушиваний по времени, статистика по жанрам, популярные треки и альбомы, активность пользователей) с использованием представлений базы данных (`track_statistics`, `user_statistics`, `playlist_duration`, `album_duration`) для оптимизации запросов.

• **Поддержка импорта и экспорта данных** в форматах CSV и JSON через нативные методы браузера и библиотеку jsPDF, а также SQL-дампы базы данных через автоматизированные скрипты резервного копирования (`backup.sh`) с поддержкой сжатия и ротации архивов.

• **Проведение тестирования** функциональности всех компонентов интерфейса, интеграционного тестирования взаимодействия с Supabase API и проверки безопасности через анализ RLS политик и валидацию входных данных.

• **Обеспечение резервного копирования и восстановления базы данных** через скрипты `backup.sh` и `restore.sh` с поддержкой проверки целостности (MD5 хэш), автоматической ротации архивов и документацией процесса развертывания.

• **Документирование процесса разработки**, включая ER-диаграмму базы данных с описанием всех таблиц и связей, спецификацию API Supabase с примерами запросов, руководство пользователя с инструкциями по регистрации и работе с контентом, а также пояснительную записку с описанием архитектуры системы.

## 2.2. Входные/выходные данные

**Входные данные:**

• **Данные пользователей:** email (используется для входа), пароль (автоматически хэшируется Supabase Authentication), username (уникальный идентификатор пользователя, минимум 3 символа), имя и фамилия (опционально), настройки интерфейса (тема оформления, язык интерфейса — русский/английский, размер страниц пагинации), аватар пользователя (изображение, загружаемое в Supabase Storage bucket 'avatars').

• **Музыкальный контент:** метаданные треков (название, длительность в секундах, URL аудиофайла в Storage, порядковый номер в альбоме, флаг публичности), метаданные альбомов (название, дата выпуска, описание, обложка альбома, флаг публичности), метаданные артистов (название артиста, биография, изображение, жанр, ссылки на социальные сети в формате JSONB), связи треков с жанрами через таблицу `track_genres` (M:M), файлы аудио (форматы MP3, WAV, FLAC, OGG, M4A, загружаемые в Storage bucket 'songs'), файлы изображений (обложки альбомов и артистов, загружаемые в Storage bucket 'covers').

• **Плейлисты:** название плейлиста (минимум 2 символа), описание (опционально), список треков через таблицу `playlist_tracks` с указанием порядка (order_position), владелец (user_id), статус публичности (is_public), обложка плейлиста (опционально), количество подписчиков (follow_count).

• **Заявки на артиста:** информация о заявке (`artist_applications`) включает название артиста, биографию, изображение, жанр, ссылку на портфолио, ссылки на социальные сети (Instagram, YouTube, другие в формате JSONB), мотивационное письмо, статус модерации (pending, approved, rejected), комментарий модератора (опционально).

• **История прослушиваний:** автоматически записывается при воспроизведении трека через триггер `listening_history_trigger`, включает идентификатор пользователя, идентификатор трека, временную метку прослушивания, длительность прослушивания в секундах и флаг завершения трека.

• **Журнал аудита:** автоматически создается через триггер `audit_changes` при операциях INSERT, UPDATE, DELETE над критичными таблицами (tracks, playlists), включает идентификатор пользователя, тип операции, название таблицы, идентификатор записи, старое и новое значение в формате JSONB, временную метку.

• **Импортируемые данные:** файлы CSV/JSON с информацией о треках (название, длительность, альбом, артист, жанр), альбомах (название, дата выпуска, артист, описание), исполнителях (название, биография, жанр, ссылки на социальные сети).

**Выходные данные:**

• **Музыкальный контент:** списки треков с метаданными (название, длительность, количество прослушиваний и лайков, альбом, артист, жанры), списки альбомов с общей длительностью и количеством треков (через представление `album_duration`), списки исполнителей с информацией о количестве альбомов и треков, списки плейлистов с общей длительностью и количеством треков (через представление `playlist_duration`), публичные и приватные плейлисты пользователя с возможностью фильтрации.

• **Отчёты аналитики:** сводные таблицы статистики пользователей (через представление `user_statistics`: количество плейлистов, общее количество прослушиваний, количество уникальных треков), статистика треков (через представление `track_statistics`: уровень популярности на основе количества прослушиваний), визуализации через Recharts: графики прослушиваний по времени (линейные и столбчатые диаграммы), распределение по жанрам (круговые диаграммы), топ популярных треков и альбомов (таблицы с сортировкой).

• **Журнал аудита:** записи о действиях пользователей с указанием идентификатора пользователя, типа операции (INSERT, UPDATE, DELETE), названия таблицы, идентификатора измененной записи, состояния данных до изменений (old_value в JSONB) и после изменений (new_value в JSONB), временной метки, доступные для просмотра администраторами и модераторами.

• **Экспортируемые данные:** файлы CSV с данными о треках, альбомах, плейлистах (генерируются через нативные методы браузера или библиотеку jsPDF), файлы JSON с метаданными контента в структурированном формате, SQL-дампы базы данных через скрипт `backup.sh` в сжатом формате (gzip) с проверкой целостности (MD5 хэш).

• **Сообщения об ошибках:** человекочитаемые коды и сообщения об ошибках при некорректных запросах (валидация входных данных через CHECK ограничения и Zod схемы на клиенте), сбоях подключения к Supabase (обработка через try-catch блоки с отображением уведомлений через библиотеку Sonner), нарушении прав доступа через RLS политики (сообщения о недостаточных правах для выполнения операции).

• **Статусы операций:** подтверждения успешного выполнения операций через toast-уведомления (добавление трека в плейлист, создание плейлиста, загрузка трека, одобрение/отклонение заявки на артиста), статусы загрузки файлов через прогресс-бары, статусы синхронизации данных через индикаторы загрузки в интерфейсе.

## 2.3. Основные роли

Система предусматривает ролевую модель доступа (RBAC) с пятью ролями, каждая из которых имеет уникальный набор прав и функций, обеспечивающих выполнение бизнес-процессов музыкального портала ImperialTunes. Роли определяются через таблицу `roles` и связаны с пользователями через поле `role_id` в таблице `users`, права доступа контролируются через Row Level Security (RLS) политики и проверку ролей в клиентском приложении:

**Администратор:**

• Полный доступ ко всем данным и функциям системы через RLS политики, позволяющие просматривать и изменять все записи в таблицах.

• Управление пользователями: просмотр списка всех пользователей через административную панель (`/admin`), удаление пользователей (каскадное удаление через внешние ключи), изменение ролей пользователей через обновление `role_id`, редактирование данных пользователей (username, имя, фамилия, биография, статус активности).

• Просмотр и экспорт журналов аудита (`audit_log`) для мониторинга действий всех ролей с возможностью фильтрации по пользователю, таблице, типу операции и временному периоду, экспорт данных аудита в CSV.

• Управление контентом: просмотр всех треков, альбомов, артистов и плейлистов независимо от статуса публичности, возможность изменения метаданных контента, удаление контента любых пользователей.

• Управление резервным копированием и восстановлением базы данных через скрипты `backup.sh` и `restore.sh` с возможностью запуска через административный интерфейс (при интеграции с серверной частью).

• Импорт/экспорт данных в форматах CSV, JSON, SQL через административную панель с валидацией формата и обработкой ошибок.

• Управление жанрами: создание, редактирование и удаление жанров через интерфейс управления контентом.

**Слушатель:**

• Доступ только для чтения к публичному музыкальному контенту через RLS политики, разрешающие просмотр записей с `is_public = TRUE` в таблицах `tracks`, `albums`, `playlists`.

• Просмотр и воспроизведение треков, альбомов, публичных плейлистов через веб-интерфейс с использованием встроенного HTML5 Audio API, автоматическое логирование прослушиваний в `listening_history` через триггер.

• Использование поиска по названию трека, имени артиста, названию альбома, жанру через фильтрацию запросов Supabase с поддержкой сортировки по дате создания, популярности, алфавиту.

• Создание и управление собственными плейлистами: создание плейлистов (публичных или приватных), добавление треков в плейлисты через функцию `add_track_to_playlist`, редактирование названия, описания и обложки плейлиста, удаление собственных плейлистов, изменение порядка треков в плейлистах.

• Управление избранным: добавление треков, альбомов и плейлистов в избранное через функции `toggle_favorite_track/album/playlist`, просмотр списка избранного в разделе настроек (`/settings`), удаление элементов из избранного.

• Просмотр собственной статистики: история прослушиваний, количество созданных плейлистов, популярные треки через страницу аналитики (`/analytics`) с визуализацией через Recharts.

• Отсутствие прав на создание или изменение музыкального контента (треков, альбомов, артистов): слушатели не могут загружать треки или создавать записи артистов, но могут подавать заявки на получение роли артиста через форму (`BecomeArtistForm`).

**Артист:**

• Создание и управление собственным музыкальным контентом: загрузка треков через диалог `UploadTrackDialog` с указанием названия, альбома, жанров, обложки, аудиофайла в форматах MP3, WAV, FLAC, OGG, M4A, редактирование метаданных треков (название, жанр, порядковый номер в альбоме), удаление собственных треков.

• Создание и управление альбомами: создание альбомов через `CreateAlbumDialog` с указанием названия, даты выпуска, описания, обложки, связывание треков с альбомами через поле `album_id`, редактирование метаданных альбомов, удаление собственных альбомов (с каскадным удалением треков).

• Управление профилем артиста: создание записи в таблице `artists` с указанием названия артиста, биографии, изображения, жанра, ссылок на социальные сети (Instagram, YouTube, другие в формате JSONB), редактирование профиля артиста, связывание профиля артиста с пользователем через поле `user_id`.

• Просмотр аналитики по собственным трекам: количество прослушиваний через `track_play_count`, количество лайков через `track_like_count`, статистика прослушиваний через представление `track_statistics` с фильтрацией по собственным трекам, графики популярности через страницу аналитики.

• Создание и редактирование собственных плейлистов (публичных или приватных) с теми же правами, что и у слушателей.

• Ограниченный доступ к данным других артистов или пользователей: артисты могут просматривать только публичный контент других артистов через RLS политики, не могут изменять чужой контент или просматривать приватные плейлисты других пользователей.

**Дистрибьютор:**

• Загрузка и управление музыкальным контентом от нескольких артистов (например, лейблов): дистрибьюторы могут создавать треки и альбомы с указанием артиста (через поле `artist_id`) и связывать контент с различными артистами через таблицы `artists` и `albums`.

• Предпрослушивание контента, который поступил на публикацию: дистрибьюторы могут просматривать все треки и альбомы, независимо от статуса публичности, через RLS политики, разрешающие доступ для роли 'дистрибьютор'.

• Модерация заявок на артистов: просмотр списка заявок (`artist_applications`) через страницу `/applications`, просмотр деталей заявки (название артиста, биография, мотивационное письмо, ссылки на социальные сети), одобрение заявки через функцию `approve_artist_application` (создание записи в таблице `artists` и обновление статуса заявки), отклонение заявки через функцию `reject_artist_application` (обновление статуса заявки с комментарием модератора).

• Ограниченный доступ к данным пользователей и чужого контента: дистрибьюторы могут просматривать публичный контент всех артистов, но не могут изменять контент других артистов или просматривать приватные плейлисты пользователей, за исключением контента, связанного с их собственными артистами.

• Просмотр аналитики по контенту своих артистов: статистика прослушиваний треков, связанных с артистами дистрибьютора, через представления `track_statistics` и `album_duration` с фильтрацией по `artist_id`.

**Модератор:**

• Просмотр и модерация контента: просмотр всех треков, альбомов и плейлистов независимо от статуса публичности, возможность изменения метаданных контента (например, изменение жанра, названия при необходимости модерации), скрытие контента через установку флага `is_public = FALSE` или `is_active = FALSE`.

• Модерация заявок на артистов: те же права, что и у дистрибьюторов, включая просмотр заявок, одобрение и отклонение заявок через функции `approve_artist_application` и `reject_artist_application`.

• Просмотр журналов аудита: доступ к таблице `audit_log` для мониторинга изменений контента с возможностью фильтрации по пользователю, таблице и временному периоду, просмотр деталей изменений через поля `old_value` и `new_value` в формате JSONB.

• Ограниченное управление пользователями: модераторы могут просматривать список пользователей и изменять статус активности (`is_active`), но не могут изменять роли пользователей или удалять пользователей (эти права зарезервированы для администраторов).

## 2.4. Сценарии пользователей

**Сценарий 1: Администратор управляет пользователями и контентом**

• Администратор открывает веб-приложение ImperialTunes, входит в систему через страницу авторизации (`/auth`), используя email и пароль, прошедшие валидацию через Supabase Authentication.

• После успешной авторизации администратор перенаправляется на главную страницу (`/`), где отображается статистика системы (общее количество треков, плейлистов, прослушиваний за последние 7 дней).

• Администратор переходит в раздел управления пользователями через маршрут `/admin` (защищенный маршрут `ProtectedRoute` с проверкой роли администратора через хук `useRole`).

• В административной панели администратор просматривает список всех пользователей с информацией о username, email, роли, дате создания и последнем входе, используя представление `user_statistics` для отображения дополнительной статистики (количество плейлистов, прослушиваний).

• Администратор использует поиск по username или email для нахождения нужного пользователя, применяя фильтрацию через Supabase Client API с условием `.ilike('%query%')`.

• Администратор выбирает пользователя из списка и выполняет одно из действий: изменение роли через выпадающий список с выбором роли (слушатель, артист, дистрибьютор, модератор, администратор) с обновлением `role_id` в таблице `users`, редактирование данных пользователя (username, имя, фамилия, биография) через форму редактирования, удаление пользователя с подтверждением через диалог (каскадное удаление связанных записей через внешние ключи), деактивация пользователя через установку `is_active = FALSE`.

• Администратор просматривает журнал аудита через раздел "Аудит" в административной панели, применяя фильтры по пользователю (через `user_id`), таблице (через `table_name`), типу операции (INSERT, UPDATE, DELETE) и временному периоду (через `timestamp`), экспортирует данные аудита в CSV через кнопку экспорта.

• Администратор проверяет список всех треков, альбомов и плейлистов через разделы "Треки", "Альбомы", "Плейлисты" в административной панели, просматривает метаданные контента (название, артист, количество прослушиваний, статус публичности), изменяет метаданные контента при необходимости (например, исправление названия, изменение жанра) или удаляет контент с подтверждением.

**Сценарий 2: Слушатель просматривает публичный контент и создает плейлисты**

• Слушатель открывает веб-приложение ImperialTunes, входит в систему через страницу авторизации (`/auth`), вводя email и пароль. При первом входе автоматически создается профиль пользователя через триггер `handle_new_user` с назначением роли "слушатель" по умолчанию.

• После успешной авторизации слушатель перенаправляется на главную страницу (`/`), где отображаются популярные треки, недавно добавленные треки и рекомендуемые плейлисты, загружаемые через Supabase Client API с фильтрацией `is_public = TRUE`.

• Слушатель использует поиск или ленту для нахождения интересующих треков: вводит запрос в поле поиска на главной странице, применяя фильтрацию по названию трека (через `.ilike('%query%')`), имени артиста (через join с таблицей `artists`), жанру (через join с таблицей `track_genres`), просматривает результаты поиска с информацией о треке (название, артист, альбом, длительность, количество прослушиваний).

• Слушатель нажимает кнопку воспроизведения на треке, что вызывает функцию `playTrack` из контекста `PlayerContext`, загружающую аудиофайл из Supabase Storage и начинающую воспроизведение через HTML5 Audio API. При воспроизведении автоматически создается запись в `listening_history` через триггер `listening_history_trigger`, который также обновляет счетчик `track_play_count` через функцию `log_listening`.

• Слушатель просматривает публичный плейлист, переходя на страницу деталей плейлиста (`/playlists/:id`) через клик на плейлист в списке. На странице отображается информация о плейлисте (название, описание, обложка, количество треков, общая длительность через представление `playlist_duration`), список треков плейлиста с возможностью воспроизведения всего плейлиста через кнопку "Воспроизвести все".

• Слушатель добавляет трек в избранное, нажимая кнопку "В избранное" на карточке трека, что вызывает функцию `toggle_favorite_track` через Supabase RPC, добавляющую запись в таблицу `favorites_tracks` или удаляющую её при повторном нажатии (toggle-функциональность).

• Слушатель создает собственный плейлист: переходит в раздел "Плейлисты" (`/playlists`), нажимает кнопку "Создать плейлист", открывающую диалог `CreatePlaylistDialog`, заполняет форму (название, описание, обложка, статус публичности), сохраняет плейлист через Supabase Client API с созданием записи в таблице `playlists`, добавляет треки в плейлист через диалог `AddSongToPlaylistDialog`, выбирая треки из библиотеки и указывая порядок добавления.

**Сценарий 3: Артист загружает и анализирует собственный контент**

• Артист входит в систему под своими учетными данными (email и пароль). После успешной авторизации артист перенаправляется на главную страницу, где отображается персонализированная лента с его собственными треками и рекомендациями.

• Артист проверяет статус заявки на артиста: если артист еще не имеет записи в таблице `artists`, он переходит в раздел "Стать артистом" (через форму `BecomeArtistForm`), где может просмотреть статус своей заявки (pending, approved, rejected) или создать новую заявку, заполняя форму (название артиста, биография, изображение, жанр, ссылки на социальные сети, мотивационное письмо), отправляя заявку на модерацию дистрибьюторами.

• После одобрения заявки (статус `approved` через функцию `approve_artist_application`) артист получает уведомление и может перейти к управлению контентом.

• Артист переходит в раздел управления контентом через маршрут `/library` (или раздел "Библиотека" в навигации), где отображаются вкладки для управления треками, альбомами и артистами.

• Артист создает запись артиста (если она еще не создана): переходит во вкладку "Артисты" в разделе "Библиотека", заполняет форму создания артиста (название, биография, изображение, жанр, ссылки на социальные сети), сохраняет запись через Supabase Client API с созданием записи в таблице `artists`, связывая её с пользователем через поле `user_id`.

• Артист загружает трек: нажимает кнопку "Загрузить трек" в разделе "Библиотека", открывающую диалог `UploadTrackDialog`, заполняет форму (название трека, выбор альбома из списка или создание нового альбома, выбор жанров из списка доступных жанров, загрузка аудиофайла в формате MP3, WAV, FLAC, OGG или M4A через Supabase Storage, загрузка обложки трека через `ImageUpload` компонент), сохраняет трек через Supabase Client API с созданием записи в таблице `tracks`, связывая трек с альбомом через `album_id` и добавляя связи с жанрами через таблицу `track_genres`, устанавливая `is_public = TRUE` для публикации трека или `is_public = FALSE` для черновика.

• Артист создает альбом: переходит во вкладку "Альбомы" в разделе "Библиотека", нажимает кнопку "Создать альбом", открывающую диалог `CreateAlbumDialog`, заполняет форму (название альбома, дата выпуска, описание, обложка альбома, выбор артиста из списка или создание нового артиста), сохраняет альбом через Supabase Client API с созданием записи в таблице `albums`, связывая альбом с артистом через `artist_id`.

• Артист просматривает статистику прослушиваний своих треков: переходит на страницу аналитики (`/analytics`), где отображается статистика по его собственным трекам через фильтрацию запросов по `uploaded_by = current_user_id`, просматривает графики прослушиваний по времени (линейные диаграммы через Recharts), количество прослушиваний и лайков каждого трека через представление `track_statistics`, топ популярных треков с сортировкой по `track_play_count`, экспортирует данные аналитики в CSV через кнопку экспорта.

**Сценарий 4: Дистрибьютор модерирует заявки на артистов и управляет контентом**

• Дистрибьютор входит в систему через веб-интерфейс, используя email и пароль. После успешной авторизации дистрибьютор перенаправляется на главную страницу.

• Дистрибьютор переходит в раздел модерации заявок на артистов через маршрут `/applications` (защищенный маршрут с проверкой роли дистрибьютора или модератора через `ProtectedRoute requireContentManagement`), где отображается компонент `ArtistApplicationsManager` со списком всех заявок.

• Дистрибьютор просматривает список заявок с фильтрацией по статусу (all, pending, approved, rejected) через выпадающий список, применяя фильтр через Supabase Client API с условием `.eq('status', filterStatus)`. Список отображает информацию о заявке: название артиста, username пользователя, который подал заявку, дата создания, статус модерации, комментарий модератора (если заявка отклонена).

• Дистрибьютор открывает заявку на публикацию трека, кликая на заявку в списке, что открывает диалог с детальной информацией о заявке: название артиста, биография, изображение артиста, жанр, ссылка на портфолио, ссылки на социальные сети (Instagram, YouTube), мотивационное письмо, информация о пользователе (username, email).

• Дистрибьютор просматривает сведения о заявленном на публикацию контенте: изучает биографию артиста, проверяет ссылки на социальные сети и портфолио, оценивает мотивационное письмо, просматривает изображение артиста (если загружено).

• Дистрибьютор принимает решение об одобрении или отказе в публикации: для одобрения заявки дистрибьютор нажимает кнопку "Одобрить", что вызывает функцию `approve_artist_application` через Supabase RPC, которая создает запись в таблице `artists` с данными из заявки, связывает артиста с пользователем через `user_id`, обновляет статус заявки на `approved` с указанием идентификатора дистрибьютора в поле `reviewed_by` и временной метки в поле `reviewed_at`, отправляет уведомление пользователю (если реализована система уведомлений); для отклонения заявки дистрибьютор нажимает кнопку "Отклонить", открывающую диалог для ввода комментария, заполняет поле комментария с указанием причины отклонения, подтверждает отклонение, что вызывает функцию `reject_artist_application` через Supabase RPC, которая обновляет статус заявки на `rejected` с сохранением комментария в поле `review_comment`.

• После модерации заявок дистрибьютор может управлять контентом одобренных артистов: просматривать треки и альбомы артистов через раздел "Библиотека" с фильтрацией по `artist_id`, создавать треки и альбомы от имени артистов через диалоги загрузки контента, изменять метаданные контента при необходимости (например, исправление названия, изменение жанра).


